<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="kr.wise.commons.cmm.service.CommonMapper">
  <resultMap id="BaseResultMap" type="kr.wise.commons.cmm.CommonVo">
    <result column="EXP_DTM" jdbcType="TIMESTAMP" property="expDtm" />
    <result column="STR_DTM" jdbcType="TIMESTAMP" property="strDtm" />
    <result column="RQST_NO" property="rqstNo" jdbcType="VARCHAR" />
    <result column="RQST_SNO" property="rqstSno" jdbcType="DECIMAL" />
    <result column="RQST_DTL_SNO" property="rqstDtlSno" jdbcType="DECIMAL" />
    <result column="RQST_DTL_DTL_SNO" property="rqstDtlDtlSno" jdbcType="DECIMAL" />
    <result column="RQST_DCD" property="rqstDcd" jdbcType="VARCHAR" />
    <result column="RVW_STS_CD" property="rvwStsCd" jdbcType="VARCHAR" />
    <result column="RVW_CONTS" property="rvwConts" jdbcType="VARCHAR" />
    <result column="VRF_CD" property="vrfCd" jdbcType="VARCHAR" />
    <result column="VRF_RMK" property="vrfRmk" jdbcType="VARCHAR" />
    <result column="WRIT_DTM" jdbcType="TIMESTAMP" property="writDtm" />
    <result column="WRIT_USER_ID" jdbcType="VARCHAR" property="writUserId" />
    <result column="WRIT_USER_NM" jdbcType="VARCHAR" property="writUserNm" />
    <result column="OBJ_DESCN" jdbcType="VARCHAR" property="objDescn" />
    <result column="OBJ_VERS" jdbcType="DECIMAL" property="objVers" />
    <result column="REG_TYP_CD" jdbcType="VARCHAR" property="regTypCd" />
    <result column="FRS_RQST_DTM" property="frsRqstDtm" jdbcType="TIMESTAMP" />
    <result column="FRS_RQST_USER_ID" property="frsRqstUserId" jdbcType="VARCHAR" />
    <result column="FRS_RQST_USER_NM" property="frsRqstUserNm" jdbcType="VARCHAR" />
    <result column="RQST_DTM" property="rqstDtm" jdbcType="TIMESTAMP" />
    <result column="RQST_USER_ID" property="rqstUserId" jdbcType="VARCHAR" />
    <result column="RQST_USER_NM" property="rqstUserNm" jdbcType="VARCHAR" />
    <result column="APRV_DTM" property="aprvDtm" jdbcType="TIMESTAMP" />
    <result column="APRV_USER_ID" property="aprvUserId" jdbcType="VARCHAR" />
    <result column="APRV_USER_NM" property="aprvUserNm" jdbcType="VARCHAR" />
    <result column="FULL_PATH" property="fullPath" jdbcType="VARCHAR" />
    <result column="IBS_STATUS" property="ibsStatus" jdbcType="VARCHAR" />
    <result column="IBS_CHECK" property="ibsCheck" jdbcType="VARCHAR" />
    <result column="SEARCH_BGN_DE" property="searchBgnDe" jdbcType="VARCHAR" />
    <result column="SEARCH_END_DE" property="searchEndDe" jdbcType="VARCHAR" />
    <result column="STND_ASRT" property="stndAsrt" jdbcType="VARCHAR" />
<!--     <result column="APL_STR_DT" property="aplStrDt" jdbcType="VARCHAR" /> -->
<!--     <result column="APL_END_DT" property="aplEndDt" jdbcType="VARCHAR" /> -->
  </resultMap>
  
  <sql id="getObjId">
  	SELECT OBJ_ID.NEXTVAL FROM DUAL
  </sql>

  <sql id="getRequestId">
  	SELECT RQST_ID.NEXTVAL FROM DUAL
  </sql>
  
  <sql id="getNextrqstSno">
  	SELECT NVL(MAX(RQST_SNO), 0) + 1 FROM WAQ_STWD WHERE RQST_NO = #{rqstNo}
  </sql>

  <sql id="getNextwdSno">
  	SELECT NVL(MAX(WD_SNO), 0) + 1 FROM WAQ_STWD_CNFG WHERE BIZ_DTL_CD = #{bizDtlCd,jdbcType=VARCHAR} AND RQST_NO = #{rqstNo,jdbcType=VARCHAR} AND RQST_SNO = #{rqstSno,jdbcType=DECIMAL}
  </sql>
  <sql id="getTblNm">
     <if test="tblnm=='WAQ_STWD'">WAQ_STWD</if>
     <if test="tblnm=='WAQ_DMN'">WAQ_DMN</if>
     <if test="tblnm=='WAQ_SDITM'">WAQ_SDITM</if>
     <if test="tblnm=='WAQ_LDM_ENTY'">WAQ_LDM_ENTY</if>
     <if test="tblnm=='WAQ_PDM_TBL'">WAQ_PDM_TBL</if>
     <if test="tblnm=='WAQ_PDM_REL_MST'">WAQ_PDM_REL_MST</if>
     <if test="tblnm=='WAQ_DDL_IDX'">WAQ_DDL_IDX</if>
     <if test="tblnm=='WAQ_DDL_TBL'">WAQ_DDL_TBL</if>
     <if test="tblnm=='WAQ_DDL_PART'">WAQ_DDL_PART</if>
     <if test="tblnm=='WAQ_DDL_SEQ'">WAQ_DDL_SEQ</if>
     <if test="tblnm=='WAQ_DDL_ETC'">WAQ_DDL_ETC</if>
     <if test="tblnm=='WAQ_DML_WRK'">WAQ_DML_WRK</if>
     <if test="tblnm=='WAQ_TBL_MAP'">WAQ_TBL_MAP</if>
     <if test="tblnm=='WAQ_COL_MAP'">WAQ_COL_MAP</if>
     <if test="tblnm=='WAQ_COD_MAP'">WAQ_COD_MAP</if>
     <if test="tblnm=='WAQ_CODE_CFC_SYS'">WAQ_CODE_CFC_SYS</if>
     <if test="tblnm=='WAQ_BIZ_AREA'">WAQ_BIZ_AREA</if>
     <if test="tblnm=='WAQ_DQI'">WAQ_DQI</if>
     <if test="tblnm=='WAQ_CTQ'">WAQ_CTQ</if>
     <if test="tblnm=='WAQ_CS_ANA_MSTR'">WAQ_CS_ANA_MSTR</if>
     <if test="tblnm=='WAQ_IM_ACT_MSTR'">WAQ_IM_ACT_MSTR</if>
     <if test="tblnm=='WAQ_BR_MSTR'">WAQ_BR_MSTR</if>
     <if test="tblnm=='WAQ_PRF_MSTR'">WAQ_PRF_MSTR</if>
     <if test="tblnm=='WAQ_APP_STWD'">WAQ_APP_STWD</if>
     <if test="tblnm=='WAQ_APP_SDITM'">WAQ_APP_SDITM</if>
     <if test="tblnm=='WAQ_MSG'">WAQ_MSG</if>
     <if test="tblnm=='WAQ_CD_VAL_TSF'">WAQ_CD_VAL_TSF</if>
     <if test="tblnm=='WAQ_MSG_TSF'">WAQ_MSG_TSF</if>
     <if test="tblnm=='WAQ_STD_ERR_MSG'">WAQ_STD_ERR_MSG</if>
     <if test="tblnm=='WAQ_CHNL_ERR_MSG'">WAQ_CHNL_ERR_MSG</if>
     <if test="tblnm=='WAQ_ERR_MSG_MAP'">WAQ_ERR_MSG_MAP</if>
     <if test="tblnm=='WAQ_ACTN_MSG'">WAQ_ACTN_MSG</if>
     <if test="tblnm=='WAQ_ASIS_PDM_TBL'">WAQ_ASIS_PDM_TBL</if>
     <if test="tblnm=='WAQ_ASIS_DMN_CD_VAL'">WAQ_ASIS_DMN_CD_VAL</if>
     <if test="tblnm=='WAQ_SYMN_ITEM'">WAQ_SYMN_ITEM</if>
     <if test="tblnm=='WAQ_SUBJ_OWNER'">WAQ_SUBJ_OWNER</if>
     <if test="tblnm=='WAQ_MTA_TBL'">WAQ_MTA_TBL</if>
     <if test="tblnm=='WAQ_APP_PRGM'">WAQ_APP_PRGM</if>
     <if test="tblnm=='WAQ_DMNG'">WAQ_DMNG</if>
     <if test="tblnm=='WAQ_PRF_COL_ANA'">WAQ_PRF_COL_ANA</if>
     <if test="tblnm=='WAQ_PRF_DQI_MAP'">WAQ_PRF_DQI_MAP</if>
     <if test="tblnm=='WAQ_PRF_DTFRM_ANA'">WAQ_PRF_DTFRM_ANA</if>
     <if test="tblnm=='WAQ_PRF_EFVA_ANA'">WAQ_PRF_EFVA_ANA</if>
     <if test="tblnm=='WAQ_PRF_EFVA_USER_DF'">WAQ_PRF_EFVA_USER_DF</if>
     <if test="tblnm=='WAQ_PRF_PTR_USER_DF'">WAQ_PRF_PTR_USER_DF</if>
     <if test="tblnm=='WAQ_PRF_REL_COL'">WAQ_PRF_REL_COL</if>
     <if test="tblnm=='WAQ_PRF_REL_TBL'">WAQ_PRF_REL_TBL</if>
     <if test="tblnm=='WAQ_PRF_RNG_ANA'">WAQ_PRF_RNG_ANA</if>
     <if test="tblnm=='WAQ_PRF_UNQ_COL'">WAQ_PRF_UNQ_COL</if>
     <if test="tblnm=='WAQ_DDL_GRT'">WAQ_DDL_GRT</if>
     
  </sql>
  <sql id="insertVrfDtlSql">
  	INSERT INTO WAQ_RQST_VRF_DTLS
  	(
  	    BIZ_DTL_CD
      , RQST_NO
	  , RQST_SNO
	  , VRF_SNO
	  , RQST_DTL_SNO
	  , VRF_DTL_CD
	  , VRF_DTLS
  	)
	SELECT #{bizDtlCd} AS BIZ_DTL_CD
           ,A.RQST_NO
	       ,A.RQST_SNO
	       ,NVL(C.VRF_SNO,0) + 1 AS VRF_SNO
	       ,0 AS RQST_DTL_SNO
	       ,#{vrfDtlCd} AS VRF_DTL_CD
	       ,NULL AS VRF_DTLS
	FROM <include refid="getTblNm" />
	A
	LEFT OUTER JOIN (SELECT MAX(VRF_SNO) AS VRF_SNO
	                       ,RQST_NO
	                       ,RQST_SNO
	                 FROM WAQ_RQST_VRF_DTLS A
	                 WHERE A.BIZ_DTL_CD = #{bizDtlCd}
	                   AND A.RQST_NO = #{rqstNo}
	                 GROUP BY RQST_NO, RQST_SNO) C
	   ON A.RQST_NO = C.RQST_NO
	  AND A.RQST_SNO = C.RQST_SNO
	  WHERE A.RQST_NO = #{rqstNo,jdbcType=VARCHAR}
  </sql>
  
  <sql id="insertVrfDtls">
    INSERT INTO WAQ_RQST_VRF_DTLS
    (
        BIZ_DTL_CD
      , RQST_NO
	  , RQST_SNO
	  , VRF_SNO
	  , RQST_DTL_SNO
	  , VRF_DTL_CD
	  , VRF_DTLS
    )
	SELECT #{bizDtlCd} AS BIZ_DTL_CD
           ,A.RQST_NO
	       ,A.RQST_SNO
	       ,NVL(C.VRF_SNO,0) + 1 AS VRF_SNO
	       ,0 AS RQST_DTL_SNO
	       ,#{vrfDtlCd} AS VRF_DTL_CD
	       ,NULL AS VRF_DTLS
  </sql>
  <!-- 요청검증내역 순번 채번 -->
    <sql id="maxVrfSnoSql">
      LEFT OUTER JOIN (SELECT MAX(VRF_SNO) AS VRF_SNO
	                       ,RQST_NO
	                       ,RQST_SNO
	                 FROM WAQ_RQST_VRF_DTLS A
	                 WHERE A.BIZ_DTL_CD = #{bizDtlCd}
	                   AND A.RQST_NO = #{rqstNo}
	                 GROUP BY RQST_NO, RQST_SNO) C
	   ON A.RQST_NO = C.RQST_NO
	  AND A.RQST_SNO = C.RQST_SNO
  </sql>
  
  <sql id="insertVrfDtls2">
    INSERT INTO WAQ_RQST_VRF_DTLS
    (
        BIZ_DTL_CD
      , RQST_NO
	  , RQST_SNO
	  , VRF_SNO
	  , RQST_DTL_SNO
	  , VRF_DTL_CD
	  , VRF_DTLS
    )
	SELECT #{bizDtlCd} AS BIZ_DTL_CD
           ,A.RQST_NO
	       ,A.RQST_SNO
	       ,NVL(C.VRF_SNO,0) + 1 AS VRF_SNO
	       ,A.RQST_DTL_SNO
	       ,#{vrfDtlCd} AS VRF_DTL_CD
	       ,NULL AS VRF_DTLS
  </sql>
  

  <sql id="maxVrfSnoSql2">
      LEFT OUTER JOIN (SELECT MAX(VRF_SNO) AS VRF_SNO
	                       ,RQST_NO
	                       ,RQST_SNO
	                       ,RQST_DTL_SNO
	                 FROM WAQ_RQST_VRF_DTLS A
	                 WHERE A.BIZ_DTL_CD = #{bizDtlCd}
	                   AND A.RQST_NO = #{rqstNo}
	                 GROUP BY RQST_NO, RQST_SNO, RQST_DTL_SNO) C
	   ON A.RQST_NO = C.RQST_NO
	  AND A.RQST_SNO = C.RQST_SNO
	  AND A.RQST_DTL_SNO = C.RQST_DTL_SNO
  </sql>
  
  <sql id="updateVrfCdSql">
     SELECT CASE WHEN MAX(B.VRF_SNO) IS NULL THEN '1' ELSE '2' END
         FROM WAQ_RQST_VRF_DTLS B
         WHERE B.BIZ_DTL_CD = #{bizDtlCd}
           AND B.RQST_NO = A.RQST_NO
           AND B.RQST_SNO = A.RQST_SNO
  </sql>
  <sql id="updateVrfCdSql2">
     SELECT CASE WHEN MAX(B.VRF_SNO) IS NULL THEN '1' ELSE '2' END
         FROM WAQ_RQST_VRF_DTLS B
         WHERE B.BIZ_DTL_CD = #{bizDtlCd}
           AND B.RQST_NO = A.RQST_NO
           AND B.RQST_SNO = A.RQST_SNO
           AND B.RQST_DTL_SNO = A.RQST_DTL_SNO
  </sql>
  
  
</mapper>