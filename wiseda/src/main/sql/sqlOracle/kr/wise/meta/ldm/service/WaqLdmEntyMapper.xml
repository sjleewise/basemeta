<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="kr.wise.meta.ldm.service.WaqLdmEntyMapper" >
  <resultMap id="BaseResultMap" type="kr.wise.meta.ldm.service.WaqLdmEnty" extends="kr.wise.commons.cmm.service.CommonMapper.BaseResultMap" >
    <id column="RQST_NO"  property="rqstNo" jdbcType="VARCHAR" />
    <id column="RQST_SNO" property="rqstSno" jdbcType="DECIMAL" />
    <result column="LDM_ENTY_ID"     property="ldmEntyId"   jdbcType="VARCHAR" />
    <result column="LDM_ENTY_LNM"    property="ldmEntyLnm"  jdbcType="VARCHAR" />  
    <result column="FULL_PATH"       property="fullPath"    jdbcType="VARCHAR" />         
    <result column="MDL_LNM"         property="mdlLnm"      jdbcType="VARCHAR" />
    <result column="UPP_SUBJ_LNM"    property="uppSubjLnm"  jdbcType="VARCHAR" />
    <result column="SUBJ_ID"         property="subjId"      jdbcType="VARCHAR" />
    <result column="SUBJ_LNM"        property="subjLnm"     jdbcType="VARCHAR" />
    <result column="STD_APL_YN"      property="stdAplYn"    jdbcType="VARCHAR" />     
    <result column="CRG_USER_ID"     property="crgUserId"   jdbcType="VARCHAR" />
    <result column="CRG_USER_NM"     property="crgUserNm"   jdbcType="VARCHAR" />   
  </resultMap>
  
  <sql id="Base_Column_List" >
      RQST_NO, RQST_SNO
    , LDM_ENTY_ID
    , LDM_ENTY_LNM    
    , RQST_DCD
    , RVW_STS_CD, RVW_CONTS, VRF_CD, VRF_RMK, MDL_LNM, UPP_SUBJ_LNM, SUBJ_ID, SUBJ_LNM
    , STD_APL_YN    
    , CRG_USER_ID, CRG_USER_NM, OBJ_DESCN, OBJ_VERS 
    , REG_TYP_CD, FRS_RQST_DTM, FRS_RQST_USER_ID, RQST_DTM, RQST_USER_ID, APRV_DTM, APRV_USER_ID 
    , FULL_PATH
  </sql>

  <sql id="waq_Column_List" >
      RQST_NO, RQST_SNO
    , LDM_ENTY_ID
    , LDM_ENTY_LNM    
    , RQST_DCD 
    , RVW_CONTS, VRF_CD, VRF_RMK, MDL_LNM, UPP_SUBJ_LNM, SUBJ_ID, SUBJ_LNM 
    , STD_APL_YN     
    , CRG_USER_ID, CRG_USER_NM, OBJ_DESCN, OBJ_VERS 
    , REG_TYP_CD, FRS_RQST_DTM, FRS_RQST_USER_ID, RQST_DTM, RQST_USER_ID, APRV_DTM, APRV_USER_ID     
    , FULL_PATH
  </sql>
  
  <select id="selectLdmEntyListbyMst" parameterType="kr.wise.commons.rqstmst.service.WaqMstr" resultMap="BaseResultMap">
  	--물리모델 테이블 요청서 리스트 조회
  	 SELECT A.RQST_NO, A.RQST_SNO
  	      , A.LDM_ENTY_ID
  	      , A.LDM_ENTY_LNM
  	      , A.RQST_DCD 
          , A.RVW_CONTS, A.VRF_CD, A.VRF_RMK
          , A.MDL_LNM, A.UPP_SUBJ_LNM
          , A.SUBJ_ID, A.SUBJ_LNM
          , A.STD_APL_YN
          , A.CRG_USER_ID, A.CRG_USER_NM
          , A.OBJ_DESCN, A.OBJ_VERS 
          , A.REG_TYP_CD, A.FRS_RQST_DTM, A.FRS_RQST_USER_ID, A.RQST_DTM, A.RQST_USER_ID, A.APRV_DTM, A.APRV_USER_ID 
          , A.FULL_PATH
          <if test='rqstStepCd == "Q" '>
          , CASE WHEN A.RVW_STS_CD = '2' THEN '2' ELSE '0' END AS RVW_STS_CD
          </if>
          <if test='rqstStepCd != "Q" '>
          , A.RVW_STS_CD
          </if>
          , CASE WHEN A.VRF_CD = '2' THEN '#FF0000' ELSE CASE WHEN A.VRF_CD = '5' THEN '#0000FF'  END END AS FontColor
          , U.USER_NM AS RQST_USER_NM     
       FROM WAQ_LDM_ENTY A
            LEFT JOIN WAA_USER U
              ON U.USER_ID = A.RQST_USER_ID 
             AND U.EXP_DTM = TO_DATE('9999-12-31', 'YYYY-MM-DD')
             AND U.REG_TYP_CD IN ('C', 'U')
      WHERE A.RQST_NO = #{rqstNo,jdbcType=VARCHAR}
      <if test='rqstStepCd == "Q" or rqstStepCd == "A" '>
      	AND A.VRF_CD = '1'
      </if>
      ORDER BY A.RQST_SNO  	
  </select>

  <select id="selectByPrimaryKey" resultMap="BaseResultMap" parameterType="map" >
    select 
    <include refid="Base_Column_List" />
    from WAQ_LDM_ENTY
    where RQST_NO = #{rqstNo,jdbcType=VARCHAR}
      and RQST_SNO = #{rqstSno,jdbcType=DECIMAL}
  </select>

  <select id="selectLdmTblDetail" resultMap="BaseResultMap" parameterType="kr.wise.meta.ldm.service.WaqLdmEnty" >
    -- 물리모델 테이블 요청 상세정보 조회
    select 
    <include refid="Base_Column_List" />
    from WAQ_LDM_ENTY
    where RQST_NO = #{rqstNo,jdbcType=VARCHAR}
      and RQST_SNO = #{rqstSno,jdbcType=DECIMAL}
  </select>
  
  <select id="selectwamlist" parameterType="map" resultMap="BaseResultMap" >
  	--물리모델 테이블 추가대상 조회...
     SELECT 'I' AS IBS_STATUS
   	      , ((SELECT NVL(MAX(RQST_SNO), 0) 
   	            FROM WAQ_LDM_ENTY 
   	           WHERE RQST_NO = #{reqmst.rqstNo}) + ROWNUM
   	        ) AS RQST_SNO           
          , A.LDM_ENTY_ID
          , A.LDM_ENTY_LNM           
          , #{reqmst.rqstDcd} AS RQST_DCD
          , A.SUBJ_ID, A.STD_APL_YN          
		  , A.CRG_USER_ID
		  , GET_USER_NM(A.CRG_USER_ID) AS CRG_USER_NM
		  , A.OBJ_DESCN, A.OBJ_VERS 		  
		  , S.FULL_PATH
	  FROM WAM_LDM_ENTY A
	       LEFT JOIN WAA_SUBJ S
	         ON S.EXP_DTM = TO_DATE( '9999-12-31', 'YYYY-MM-DD')
	        AND S.REG_TYP_CD IN ('C', 'U')
	        AND S.SUBJ_ID = A.SUBJ_ID	       
	  WHERE A.LDM_ENTY_ID IN 
	  <foreach collection="list" item="item" open="(" separator="," close=")">
	   	#{item.ldmEntyId}
	  </foreach>
	   AND A.REG_TYP_CD IN ('C', 'U') 	
  </select>
  

  <delete id="deleteByPrimaryKey" parameterType="map" >
    delete from WAQ_LDM_ENTY
    where RQST_NO = #{rqstNo,jdbcType=VARCHAR}
      and RQST_SNO = #{rqstSno,jdbcType=DECIMAL}
  </delete>
  <insert id="insert" parameterType="kr.wise.meta.ldm.service.WaqLdmEnty" >
    insert into WAQ_LDM_ENTY (RQST_NO, RQST_SNO, LDM_ENTY_ID, 
      LDM_ENTY_LNM, PDM_TBL_LNM, BF_LDM_ENTY_LNM, 
      RQST_DCD, RVW_STS_CD, RVW_CONTS, 
      VRF_CD, VRF_RMK, MDL_LNM, 
      UPP_SUBJ_LNM, SUBJ_ID, SUBJ_LNM, 
      STD_APL_YN, PART_TBL_YN, DW_TRG_TBL_YN, 
      CRG_USER_ID, CRG_USER_NM, OBJ_DESCN, 
      OBJ_VERS, REG_TYP_CD, FRS_RQST_DTM, 
      FRS_RQST_USER_ID, RQST_DTM, RQST_USER_ID, 
      APRV_DTM, APRV_USER_ID, CTD_FCY, 
      DEL_CRI, DEL_MTD, BCK_FCY
      )
    values (#{rqstNo,jdbcType=VARCHAR}, #{rqstSno,jdbcType=DECIMAL}, #{ldmEntyId,jdbcType=VARCHAR}, 
      #{ldmEntyLnm,jdbcType=VARCHAR}, #{pdmTblLnm,jdbcType=VARCHAR}, #{bfLdmTblPnm,jdbcType=VARCHAR}, 
      #{rqstDcd,jdbcType=VARCHAR}, #{rvwStsCd,jdbcType=VARCHAR}, #{rvwConts,jdbcType=VARCHAR}, 
      #{vrfCd,jdbcType=VARCHAR}, #{vrfRmk,jdbcType=VARCHAR}, #{mdlLnm,jdbcType=VARCHAR}, 
      #{uppSubjLnm,jdbcType=VARCHAR}, #{subjId,jdbcType=VARCHAR}, #{subjLnm,jdbcType=VARCHAR}, 
      #{stdAplYn,jdbcType=VARCHAR}, #{partTblYn,jdbcType=VARCHAR}, #{dwTrgTblYn,jdbcType=VARCHAR}, 
      #{crgUserId,jdbcType=VARCHAR}, #{crgUserNm,jdbcType=VARCHAR}, #{objDescn,jdbcType=VARCHAR}, 
      #{objVers,jdbcType=DECIMAL}, #{regTypCd,jdbcType=VARCHAR}, #{frsRqstDtm,jdbcType=TIMESTAMP}, 
      #{frsRqstUserId,jdbcType=VARCHAR}, #{rqstDtm,jdbcType=TIMESTAMP}, #{rqstUserId,jdbcType=VARCHAR}, 
      #{aprvDtm,jdbcType=TIMESTAMP}, #{aprvUserId,jdbcType=VARCHAR}, #{ctdFcy,jdbcType=VARCHAR}, 
      #{delCri,jdbcType=VARCHAR}, #{delMtd,jdbcType=VARCHAR}, #{bckFcy,jdbcType=VARCHAR}
      )
  </insert>
  <insert id="insertSelective" parameterType="kr.wise.meta.ldm.service.WaqLdmEnty" >
	<selectKey keyProperty="rqstSno" resultType="int" statementType="PREPARED" order="BEFORE">
	<!--   		<include refid="kr.wise.commons.cmm.service.CommonMapper.getNextrqstSno"/> -->
		SELECT NVL(MAX(RQST_SNO), 0) + 1 
		  FROM WAQ_LDM_ENTY 
		 WHERE RQST_NO = #{rqstNo}
  	</selectKey>
    insert into WAQ_LDM_ENTY
    <trim prefix="(" suffix=")" suffixOverrides="," >
        RQST_NO,
        RQST_SNO,
      <if test="ldmEntyId != null" >
        LDM_ENTY_ID,
      </if>
      <if test="ldmEntyLnm != null" >
        LDM_ENTY_LNM,
      </if>      
      <if test="rqstDcd != null" >
        RQST_DCD,
      </if>
      <if test="rvwStsCd != null" >
        RVW_STS_CD,
      </if>
      <if test="rvwConts != null" >
        RVW_CONTS,
      </if>
      <if test="vrfCd != null" >
        VRF_CD,
      </if>
      <if test="vrfRmk != null" >
        VRF_RMK,
      </if>
      <if test="mdlLnm != null" >
        MDL_LNM,
      </if>
      <if test="uppSubjLnm != null" >
        UPP_SUBJ_LNM,
      </if>
      <if test="subjId != null" >
        SUBJ_ID,
      </if>
      <if test="subjLnm != null" >
        SUBJ_LNM,
      </if>
      <if test="stdAplYn != null" >
        STD_APL_YN,
      </if>      
      <if test="crgUserId != null" >
        CRG_USER_ID,
      </if>
      <if test="crgUserNm != null" >
        CRG_USER_NM,
      </if>
      <if test="objDescn != null" >
        OBJ_DESCN,
      </if>
        OBJ_VERS,
      <if test="regTypCd != null" >
        REG_TYP_CD,
      </if>
        FRS_RQST_DTM,
      <if test="frsRqstUserId != null" >
        FRS_RQST_USER_ID,
      </if>
        RQST_DTM,
      <if test="rqstUserId != null" >
        RQST_USER_ID,
      </if>      
      <if test="fullPath != null" >
        FULL_PATH,
      </if>               
    </trim>
    <trim prefix="values (" suffix=")" suffixOverrides="," >
        #{rqstNo,jdbcType=VARCHAR},
        #{rqstSno,jdbcType=DECIMAL},
      <if test="ldmEntyId != null" >
        #{ldmEntyId,jdbcType=VARCHAR},
      </if>
      <if test="ldmEntyLnm != null" >
        #{ldmEntyLnm,jdbcType=VARCHAR},
      </if>      
      <if test="rqstDcd != null" >
        #{rqstDcd,jdbcType=VARCHAR},
      </if>
      <if test="rvwStsCd != null" >
        #{rvwStsCd,jdbcType=VARCHAR},
      </if>
      <if test="rvwConts != null" >
        #{rvwConts,jdbcType=VARCHAR},
      </if>
      <if test="vrfCd != null" >
        #{vrfCd,jdbcType=VARCHAR},
      </if>
      <if test="vrfRmk != null" >
        #{vrfRmk,jdbcType=VARCHAR},
      </if>
      <if test="mdlLnm != null" >
        #{mdlLnm,jdbcType=VARCHAR},
      </if>
      <if test="uppSubjLnm != null" >
        #{uppSubjLnm,jdbcType=VARCHAR},
      </if>
      <if test="subjId != null" >
        #{subjId,jdbcType=VARCHAR},
      </if>
      <if test="subjLnm != null" >
        #{subjLnm,jdbcType=VARCHAR},
      </if>
      <if test="stdAplYn != null" >
        #{stdAplYn,jdbcType=VARCHAR},
      </if>      
      <if test="crgUserId != null" >
        #{crgUserId,jdbcType=VARCHAR},
      </if>
      <if test="crgUserNm != null" >
        #{crgUserNm,jdbcType=VARCHAR},
      </if>
      <if test="objDescn != null" >
        #{objDescn,jdbcType=VARCHAR},
      </if>
        1 , 
      <if test="regTypCd != null" >
        #{regTypCd,jdbcType=VARCHAR},
      </if>
        SYSDATE ,
      <if test="frsRqstUserId != null" >
        #{frsRqstUserId,jdbcType=VARCHAR},
      </if>
        SYSDATE ,
      <if test="rqstUserId != null" >
        #{rqstUserId,jdbcType=VARCHAR},
      </if>      
      <if test="fullPath != null" >
        #{fullPath,jdbcType=VARCHAR},
      </if>      
    </trim>
  </insert>

  <update id="updateByPrimaryKeySelective" parameterType="kr.wise.meta.ldm.service.WaqLdmEnty" >
    update WAQ_LDM_ENTY
    <set >
      <if test="ldmEntyId != null" >
        LDM_ENTY_ID = #{ldmEntyId,jdbcType=VARCHAR},
      </if>
      <if test="ldmEntyLnm != null" >
        LDM_ENTY_LNM = #{ldmEntyLnm,jdbcType=VARCHAR},
      </if>       
      <if test="rqstDcd != null" >
        RQST_DCD = #{rqstDcd,jdbcType=VARCHAR},
      </if>
      <if test="rvwStsCd != null" >
        RVW_STS_CD = #{rvwStsCd,jdbcType=VARCHAR},
      </if>
      <if test="rvwConts != null" >
        RVW_CONTS = #{rvwConts,jdbcType=VARCHAR},
      </if>
      <if test="vrfCd != null" >
        VRF_CD = #{vrfCd,jdbcType=VARCHAR},
      </if>
      <if test="vrfRmk != null" >
        VRF_RMK = #{vrfRmk,jdbcType=VARCHAR},
      </if>
      <if test="mdlLnm != null" >
        MDL_LNM = #{mdlLnm,jdbcType=VARCHAR},
      </if>
      <if test="uppSubjLnm != null" >
        UPP_SUBJ_LNM = #{uppSubjLnm,jdbcType=VARCHAR},
      </if>
      <if test="subjId != null" >
        SUBJ_ID = #{subjId,jdbcType=VARCHAR},
      </if>
      <if test="subjLnm != null" >
        SUBJ_LNM = #{subjLnm,jdbcType=VARCHAR},
      </if>
        STD_APL_YN = #{stdAplYn,jdbcType=VARCHAR},        
      <if test="crgUserId != null" >
        CRG_USER_ID = #{crgUserId,jdbcType=VARCHAR},
      </if>
      <if test="crgUserNm != null" >
        CRG_USER_NM = #{crgUserNm,jdbcType=VARCHAR},
      </if>
      <if test="objDescn != null" >
        OBJ_DESCN = #{objDescn,jdbcType=VARCHAR},
      </if>
        RQST_DTM = SYSDATE ,
      <if test="rqstUserId != null" >
        RQST_USER_ID = #{rqstUserId,jdbcType=VARCHAR},
      </if>      
      <if test="fullPath != null" >
        FULL_PATH = #{fullPath,jdbcType=VARCHAR},
      </if>       
    </set>
    WHERE RQST_NO  = #{rqstNo,jdbcType=VARCHAR}
      AND RQST_SNO = #{rqstSno,jdbcType=DECIMAL}
  </update>
  <update id="updateByPrimaryKey" parameterType="kr.wise.meta.ldm.service.WaqLdmEnty" >
    update WAQ_LDM_ENTY
    set LDM_ENTY_ID = #{ldmEntyId,jdbcType=VARCHAR},
      LDM_ENTY_LNM = #{ldmEntyLnm,jdbcType=VARCHAR},      
      RQST_DCD = #{rqstDcd,jdbcType=VARCHAR},
      RVW_STS_CD = #{rvwStsCd,jdbcType=VARCHAR},
      RVW_CONTS = #{rvwConts,jdbcType=VARCHAR},
      VRF_CD = #{vrfCd,jdbcType=VARCHAR},
      VRF_RMK = #{vrfRmk,jdbcType=VARCHAR},
      MDL_LNM = #{mdlLnm,jdbcType=VARCHAR},
      UPP_SUBJ_LNM = #{uppSubjLnm,jdbcType=VARCHAR},
      SUBJ_ID = #{subjId,jdbcType=VARCHAR},
      SUBJ_LNM = #{subjLnm,jdbcType=VARCHAR},
      STD_APL_YN = #{stdAplYn,jdbcType=VARCHAR},      
      CRG_USER_ID = #{crgUserId,jdbcType=VARCHAR},
      CRG_USER_NM = #{crgUserNm,jdbcType=VARCHAR},
      OBJ_DESCN = #{objDescn,jdbcType=VARCHAR},
      OBJ_VERS = #{objVers,jdbcType=DECIMAL},
      REG_TYP_CD = #{regTypCd,jdbcType=VARCHAR},
      FRS_RQST_DTM = #{frsRqstDtm,jdbcType=TIMESTAMP},
      FRS_RQST_USER_ID = #{frsRqstUserId,jdbcType=VARCHAR},
      RQST_DTM = #{rqstDtm,jdbcType=TIMESTAMP},
      RQST_USER_ID = #{rqstUserId,jdbcType=VARCHAR},
      APRV_DTM = #{aprvDtm,jdbcType=TIMESTAMP},
      APRV_USER_ID = #{aprvUserId,jdbcType=VARCHAR},       
    where RQST_NO = #{rqstNo,jdbcType=VARCHAR}
      and RQST_SNO = #{rqstSno,jdbcType=DECIMAL}
  </update>
  
  <delete id="deleteByrqstSno" parameterType="kr.wise.meta.ldm.service.WaqLdmEnty">
  	DELETE FROM WAQ_LDM_ENTY
  	 WHERE RQST_NO  = #{rqstNo}
  	   AND RQST_SNO = #{rqstSno}
  </delete>
  
  
  <!-- 검증SQL -->
  <update id="updateCheckInit" parameterType="java.lang.String" >
    UPDATE WAQ_LDM_ENTY A
       SET (A.REG_TYP_CD, A.LDM_ENTY_ID) = 
                          (SELECT CASE WHEN A.RQST_DCD = 'DD' THEN 'D' ELSE CASE WHEN MAX(B.LDM_ENTY_ID ) IS NULL THEN 'C' ELSE 'U' END END
                                , MAX(B.LDM_ENTY_ID) 
                             FROM WAM_LDM_ENTY B 
                                  INNER JOIN WAA_SUBJ C
                                    ON C.EXP_DTM = TO_DATE('9999-12-31', 'YYYY-MM-DD')
	   				   	           AND C.REG_TYP_CD IN ('C', 'U')
	   				   	           AND C.SUBJ_ID = B.SUBJ_ID
                            WHERE B.REG_TYP_CD IN ('C','U')
                              ANd C.FULL_PATH   = A.FULL_PATH
                              AND B.LDM_ENTY_LNM = A.LDM_ENTY_LNM                           
                          )
        , A.VRF_CD = '4'
    WHERE A.RQST_NO = #{rqstNo,jdbcType=VARCHAR}
  </update>  
  
  <update id="updateStndApplybySubj" parameterType="string">
  --주제영역의 표준적용 여부에 따라 테이블 표준적용여부 업데이트
	UPDATE WAQ_LDM_ENTY A
	   SET (A.STD_APL_YN, A.SUBJ_ID ) = 
	               (SELECT NVL(B.STD_APL_YN, 'Y')
					     , B.SUBJ_ID 
					  FROM WAA_SUBJ B
					 WHERE B.EXP_DTM = TO_DATE('9999-12-31', 'YYYY-MM-DD')
					   AND B.REG_TYP_CD IN ('C', 'U')
					   AND B.FULL_PATH = A.FULL_PATH					  
			        )
	 WHERE A.RQST_NO = #{rqstNo}
	   AND EXISTS (SELECT 1
			         FROM WAA_SUBJ B
			        WHERE B.EXP_DTM = TO_DATE('9999-12-31', 'YYYY-MM-DD')
			          AND B.REG_TYP_CD IN ('C', 'U')
			          AND B.FULL_PATH = A.FULL_PATH				
		          )
	   
	   
  </update>
  
  <update id="updateStndApplybyCol" parameterType="string">
 	--비표준 테이블의 컬럼이 모두 표준항목 ID가 있는 경우 표준적용으로 업데이트...
	--사전에 컬럼의 표준항목 ID가 사전에 업데이트 되어 있어야 한다....
	UPDATE WAQ_LDM_ENTY A
	   SET A.STD_APL_YN = 'Y'
	 WHERE A.RQST_NO = #{rqstNo}
	   AND A.STD_APL_YN != 'Y'
	   AND (SELECT COUNT(*) FROM WAQ_LDM_ATTR B 
	   		 WHERE A.RQST_NO = B.RQST_NO
	           AND A.RQST_SNO = B.RQST_SNO ) > 0
	   AND NOT EXISTS (
			SELECT 1 FROM WAQ_LDM_ATTR B
	         WHERE A.RQST_NO = B.RQST_NO
	           AND A.RQST_SNO = B.RQST_SNO
			   AND A.LDM_ENTY_LNM = B.LDM_ENTY_LNM
		       AND B.SDITM_ID IS NULL
			)
  </update>
  
 <insert id="checkRequestTbl" parameterType="map">
  	<include refid="kr.wise.commons.rqstmst.service.WaqRqstVrfDtlsMapper.insertVrfDtlSql"/>
  	--검증쿼리 : 요청중인 테이블 (PT004)
    AND EXISTS (
    		SELECT 1 
    		  FROM WAQ_MSTR E
                   INNER JOIN WAQ_LDM_ENTY D
                      ON D.RQST_NO = E.RQST_NO 
             WHERE E.RQST_NO != #{rqstNo}
               AND E.RQST_STEP_CD = 'Q'
               AND A.LDM_ENTY_LNM = D.LDM_ENTY_LNM
               AND A.FULL_PATH	  = D.FULL_PATH
			   AND NVL(D.RVW_STS_CD, 0) != '2'
               )
  </insert> 

 <insert id="checkDupTbl" parameterType="map">
  	<include refid="kr.wise.commons.rqstmst.service.WaqRqstVrfDtlsMapper.insertVrfDtlSql"/>
  	--검증쿼리 : 요청서내 중복(PT001)
    AND EXISTS (SELECT 1
                  FROM WAQ_LDM_ENTY D
                 WHERE A.RQST_NO = D.RQST_NO
                   AND A.FULL_PATH	= D.FULL_PATH
                   AND A.LDM_ENTY_LNM = D.LDM_ENTY_LNM               
                   AND A.RQST_SNO != D.RQST_SNO
               )
  </insert> 


  <insert id="checkNotExistTbl" parameterType="map">
  	<include refid="kr.wise.commons.rqstmst.service.WaqRqstVrfDtlsMapper.insertVrfDtlSql"/>
      --검증쿼리 : 삭제대상 테이블 미존재(PT002)
      AND A.RQST_DCD = 'DD'
      AND NOT EXISTS (SELECT 1
                  FROM WAM_LDM_ENTY D
                  WHERE A.LDM_ENTY_LNM = D.LDM_ENTY_LNM
               		AND A.FULL_PATH	= D.FULL_PATH
                    AND D.REG_TYP_CD IN ('C', 'U'))  
  </insert>
  
  <insert id="checkNonSubjID" parameterType="map">
	  <include refid="kr.wise.commons.rqstmst.service.WaqRqstVrfDtlsMapper.insertVrfDtlSql"/>
	  --검증쿼리 : 주제영역 미존재(PT003)
	  AND NOT EXISTS ( SELECT 1 
	                     FROM WAA_SUBJ D
	  					WHERE A.FULL_PATH = D.FULL_PATH
	  					  AND D.EXP_DTM  = TO_DATE( '9999-12-31', 'YYYY-MM-DD')
				          AND D.REG_TYP_CD IN ('C', 'U')
	  				)	
  </insert>

  <insert id="checkTblNameLength" parameterType="map">
	  <include refid="kr.wise.commons.rqstmst.service.WaqRqstVrfDtlsMapper.insertVrfDtlSql"/>
	  --검증쿼리 : 테이블명 길이 체크(PT005)
      <![CDATA[
      AND A.RQST_DCD = 'CU'
      AND LENGTH(A.LDM_ENTY_LNM) > 30
      ]]>
  </insert>
  <insert id="checkColCnt" parameterType="map">
	  <include refid="kr.wise.commons.rqstmst.service.WaqRqstVrfDtlsMapper.insertVrfDtlSql"/>
	  --검증쿼리 : 컬럼 존재여부 체크(PT006)
      <![CDATA[
      AND A.RQST_DCD = 'CU'
      AND NOT EXISTS ( SELECT 1
						 FROM WAQ_LDM_ATTR X
						WHERE X.RQST_NO  = A.RQST_NO 
						  AND X.RQST_SNO = A.RQST_SNO 
				      )
      ]]>
  </insert>

  <insert id="checkNotChgData" parameterType="map">
	  <!-- <include refid="kr.wise.commons.rqstmst.service.WaqRqstVrfDtlsMapper.insertVrfDtlSql"/>  -->
	  
	  <include refid="kr.wise.commons.rqstmst.service.WaqRqstVrfDtlsMapper.updateVrfNotChg"/>
	  --검증쿼리 : 변경일 때 변경된 데이터가 없을 경우 (PT000)
      AND A.REG_TYP_CD = 'U'
      AND EXISTS (
      		SELECT 1 
      		  FROM WAM_LDM_ENTY D
      		 WHERE A.FULL_PATH    = D.FULL_PATH
      		   AND A.LDM_ENTY_LNM = D.LDM_ENTY_LNM      		       		        		  
      		   AND NVL(A.OBJ_DESCN, '_') = NVL(D.OBJ_DESCN, '_')      		       		   
      		)
      AND NOT EXISTS (SELECT 1 
      		            FROM WAQ_LDM_ATTR D
      		           WHERE D.RQST_NO = A.RQST_NO
                         AND D.RQST_SNO = A.RQST_SNO
                         AND D.VRF_CD = '1'
      		          )
    
  </insert>
  
  <insert id="checkColErr" parameterType="map">
	  <include refid="kr.wise.commons.rqstmst.service.WaqRqstVrfDtlsMapper.insertVrfDtlSql"/>
	  --검증쿼리 : 컬럼 오류가 있을 경우 체크 (PT999)
	  AND EXISTS (
	  			  SELECT 1 
	  			    FROM WAQ_LDM_ATTR D
	  			   WHERE A.RQST_NO  = D.RQST_NO
	  			     AND A.RQST_SNO = D.RQST_SNO
	  			     AND D.VRF_CD = '2'
	  			     AND EXISTS ( SELECT 1 
	  			                    FROM WAQ_RQST_VRF_DTLS E
	  			     			   WHERE D.RQST_NO 	  = E.RQST_NO
	  			     			     AND D.RQST_SNO 	  = E.RQST_SNO
	  			     			     AND D.RQST_DTL_SNO = E.RQST_DTL_SNO
	  			     			     AND E.VRF_DTL_CD NOT IN ('PC000', 'PR000')
	  			                 )
	  			 )                 	  	  
  </insert>
  
  
  <insert id="checkRelErr" parameterType="map">
	  <include refid="kr.wise.commons.rqstmst.service.WaqRqstVrfDtlsMapper.insertVrfDtlSql"/>
	  --검증쿼리 : 관계 오류가 있을 경우 체크 (PR999)
	  AND EXISTS (
	  			SELECT 1 FROM WAQ_PDM_REL D
	  			 WHERE A.RQST_NO = D.RQST_NO
	  			   AND A.RQST_SNO = D.RQST_SNO
	  			   AND D.VRF_CD = '2'
	  			   AND EXISTS ( SELECT 1 FROM WAQ_RQST_VRF_DTLS E
	  			   			     WHERE D.RQST_NO 	  = E.RQST_NO
	  			   			       AND D.RQST_SNO 	  = E.RQST_SNO
	  			   			       AND D.RQST_DTL_SNO = E.RQST_DTL_SNO
	  			   			       AND E.VRF_DTL_CD != 'PR000'
	  			   ) 
	  	)
  </insert>
  
  
    <insert id="checkObjdesc" parameterType="map">
	  <include refid="kr.wise.commons.rqstmst.service.WaqRqstVrfDtlsMapper.insertVrfDtlSql"/>
	  --검증쿼리 : 설명존재여부 (PT009)
	  AND A.OBJ_DESCN IS NULL
	  AND A.RQST_NO = #{rqstNo}
  </insert>
<!-- 	테이블명 명명규칙 검증 -->
<!-- 	기표원 명명규칙 입니다. -->
<!-- 	사이트별로 변경 사용 하세요 -->
<!-- 	 테이블물리명 명명규칙 : 1번째 자리 : T  +  2.3번째 자리 : 주제영역 약어 2자리    12번째자리 : 테이블유형정의-->
  <insert id="checkTblName" parameterType="map">
	  <include refid="kr.wise.commons.rqstmst.service.WaqRqstVrfDtlsMapper.insertVrfDtlSql"/>
	  --검증쿼리 : 테이블 물리명 명명규칙 (PT007)
	  AND A.REG_TYP_CD IN ('C','U')	  
	  AND A.STD_APL_YN = 'Y'	  
      AND EXISTS (SELECT 1
                    FROM WAA_SUBJ X
                   WHERE X.EXP_DTM = TO_DATE('9999-12-31', 'YYYY-MM-DD')
                     AND X.REG_TYP_CD IN ('C','U')
                     AND X.SUBJ_LVL = 1
                     AND X.FULL_PATH = A.FULL_PATH
                     AND 'PTB_' || X.SUBJ_ABR_NM != SUBSTR(LDM_ENTY_LNM,1,8) || REGEXP_REPLACE(SUBSTR(LDM_ENTY_LNM,9,4),'[0-9,A-Z]','')                                           
			      )
  </insert>
  
   <insert id="checkSubjDbSch" parameterType="map">
  	<include refid="kr.wise.commons.rqstmst.service.WaqRqstVrfDtlsMapper.insertVrfDtlSql"/>
  	--검증쿼리 : 주제영역 스키마 매핑 미존재 (PT008)
    AND NOT EXISTS (
    		SELECT 1 
    		FROM WAA_SUBJ SUB
    		INNER JOIN WAA_SUBJ_DB_SCH_MAP DMP
    		ON SUB.SUBJ_ID = DMP.SUBJ_ID
    		AND SUB.EXP_DTM = TO_DATE('99991231', 'YYYYMMDD')
    		AND SUB.REG_TYP_CD IN ('C', 'U')
    		AND DMP.EXP_DTM = TO_DATE('99991231', 'YYYYMMDD')
    		AND DMP.REG_TYP_CD IN ('C', 'U')  
    		WHERE A.FULL_PATH = SUB.FULL_PATH        
           )
  </insert>
  
     <insert id="checkCommonCol" parameterType="map">
  	<include refid="kr.wise.commons.rqstmst.service.WaqRqstVrfDtlsMapper.insertVrfDtlSql"/>
  	--검증쿼리 : 시스템공통컬럼 미존재 (PT010)
    AND '6' != (
    		SELECT COUNT(PDM_COL_PNM) 
    		FROM WAQ_LDM_ATTR COL
    		WHERE A.RQST_NO = COL.RQST_NO
    		AND A.RQST_SNO = COL.RQST_SNO
    		AND A.LDM_ENTY_LNM = COL.LDM_ENTY_LNM
    		AND COL.PDM_COL_PNM IN ('SYS_REG_DTTM','SYS_RGSR_EMNO','SYS_REG_BRCD','SYS_CHG_DTTM','SYS_EDIR_EMNO','SYS_CHG_BRCD'	)
    		--AND COL.NONUL_YN = 'Y'
           )
  </insert>  
  
  <!-- 승인/반려 업데이트 -->
  <update id="updatervwStsCd" parameterType="kr.wise.meta.ldm.service.WaqLdmEnty" >
  	UPDATE WAQ_LDM_ENTY
  	<set>
  	    RVW_STS_CD 	= #{rvwStsCd} , 
  		RVW_CONTS 	= #{rvwConts} , 
  		APRV_DTM	= SYSDATE ,
  		APRV_USER_ID = #{aprvUserId} ,
  	</set>
    WHERE RQST_NO = #{rqstNo,jdbcType=VARCHAR}
      AND RQST_SNO = #{rqstSno,jdbcType=DECIMAL}
      AND VRF_CD = '1'
      AND NVL(RVW_STS_CD, '_') != '2'
  </update>

  <!-- 적재 SQL -->
  <!--   적재쿼리 
    selectWaqC
    
	int updateWaqCUD(@Param("rqstNo") String rqstNo);
	int updateWaqC(@Param("rqstNo") String rqstNo);
	int deleteWAM(@Param("rqstNo") String rqstNo);
	int insertWAM(@Param("rqstNo") String rqstNo);
	int updateWAH(@Param("rqstNo") String rqstNo);
	int insertWAH(@Param("rqstNo") String rqstNo);
-->

	<sql id="wam_col">
	, LDM_ENTY_LNM
	, SUBJ_ID, STD_APL_YN 	
	, CRG_USER_ID, RQST_NO, RQST_SNO, OBJ_DESCN, OBJ_VERS, REG_TYP_CD, FRS_RQST_DTM, FRS_RQST_USER_ID 
    , RQST_DTM, RQST_USER_ID, APRV_DTM, APRV_USER_ID    
    , FULL_PATH
   </sql>
   
   <select id="selectWaqC" parameterType="map" resultMap="BaseResultMap">
   	--신규 적재 대상 추출
   	SELECT * FROM WAQ_LDM_ENTY
   	WHERE RQST_NO = #{rqstNo}
   	  AND RVW_STS_CD = '1'  --승인
   	  AND REG_TYP_CD = 'C'
   </select>
   
   <update id="updateidByKey" parameterType="kr.wise.meta.ldm.service.WaqLdmEnty">
     --신규 적재 대상 ID 업데이트
     UPDATE WAQ_LDM_ENTY 
        SET LDM_ENTY_ID = #{ldmEntyId,jdbcType=VARCHAR}
  	  WHERE RQST_NO    = #{rqstNo,jdbcType=VARCHAR}
        AND RQST_SNO   = #{rqstSno,jdbcType=DECIMAL}
   </update>

   <update id="updateWaqCUD" parameterType="map">
   	--WAQ ID, VERS 등을 업데이트...
	UPDATE WAQ_LDM_ENTY A
	SET (LDM_ENTY_ID, OBJ_VERS, FRS_RQST_DTM, FRS_RQST_USER_ID) = (
	    SELECT 
	          B.LDM_ENTY_ID AS LDM_ENTY_ID
	        , NVL(B.OBJ_VERS, 0) + 1 AS OBJ_VERS
	        , B.FRS_RQST_DTM
	        , B.FRS_RQST_USER_ID
	    FROM WAM_LDM_ENTY B
	    JOIN WAA_SUBJ C
	      ON B.SUBJ_ID = C.SUBJ_ID
	     AND C.EXP_DTM = TO_DATE( '9999-12-31', 'YYYY-MM-DD')
	     AND C.REG_TYP_CD IN ('C', 'U')
	    WHERE B.LDM_ENTY_LNM = A.LDM_ENTY_LNM 
	      AND C.FULL_PATH = A.FULL_PATH
	      --AND B.REG_TYP_CD IN ('C', 'U')
	)
	WHERE A.RQST_NO = #{rqstNo}
	--AND A.VRF_CD = '1' 		--등록가능
	AND A.RVW_STS_CD = '1'  --승인
	AND EXISTS (
		SELECT 1
		  FROM WAM_LDM_ENTY B
	      JOIN WAA_SUBJ C
	        ON B.SUBJ_ID = C.SUBJ_ID
	       AND C.EXP_DTM = TO_DATE( '9999-12-31', 'YYYY-MM-DD')
	       AND C.REG_TYP_CD IN ('C', 'U')
	     WHERE B.LDM_ENTY_LNM = A.LDM_ENTY_LNM
	       AND C.FULL_PATH   = A.FULL_PATH
	      --AND B.REG_TYP_CD IN ('C', 'U')
	)
   </update>
   
   <update id="updateWaqId" parameterType="map">
   	--주제영역 ID 업데이트...
   	UPDATE WAQ_LDM_ENTY X 
   	   SET (SUBJ_ID) = (
   		SELECT MAX(SUBJ_ID) 
   		  FROM WAA_SUBJ A
   		 WHERE A.FULL_PATH = X.FULL_PATH
   		   AND A.EXP_DTM = TO_DATE( '9999-12-31', 'YYYY-MM-DD')
	       AND A.REG_TYP_CD IN ('C', 'U')
   		)
   	 WHERE RQST_NO = #{rqstNo}
   	   AND RVW_STS_CD = '1' 
   </update>
   
   <delete id="deleteWAM" parameterType="map">
    --WAM 삭제 (등록유형코드가REG_TYP_CD 변경, 삭제일 경우)
	DELETE FROM WAM_LDM_ENTY A
	WHERE EXISTS (
	    SELECT 1 
	      FROM WAQ_LDM_ENTY B
	     WHERE B.RQST_NO = #{rqstNo}
	       AND B.RVW_STS_CD = '1'
	       AND B.LDM_ENTY_ID = A.LDM_ENTY_ID 
	)
   </delete>   

   <insert id="insertWAM" parameterType="map">
   	--WAM 추가 (WAQ 내용을 추가, REG_TYP_CD 가 신규,변경일 경우)
	INSERT INTO WAM_LDM_ENTY 
	(
	   LDM_ENTY_ID 	
	   <include refid="wam_col"/>	
	)
	SELECT LDM_ENTY_ID 	
	       <include refid="wam_col"/>	
	 FROM WAQ_LDM_ENTY A
	WHERE A.RQST_NO = #{rqstNo}
	  AND A.RVW_STS_CD = '1'
	  AND A.REG_TYP_CD IN ('C', 'U')
   </insert>  
   
   <update id="updateWAH"  parameterType="map">
   	--WAH 이력 만료...
	UPDATE WAH_LDM_ENTY A
	   SET EXP_DTM = SYSDATE
	 WHERE EXP_DTM = TO_DATE('9999-12-31', 'YYYY-MM-DD')
	   AND REG_TYP_CD IN ('C','U')
	   AND EXISTS (SELECT 1 
	                 FROM WAQ_LDM_ENTY B
	                WHERE B.RQST_NO = #{rqstNo}
	                  AND B.RVW_STS_CD = '1'
	                  AND B.LDM_ENTY_ID = A.LDM_ENTY_ID
	                )
	
   </update>  

   <insert id="insertWAH"  parameterType="map">
   	--WAH이력 적재...
	INSERT INTO WAH_LDM_ENTY
	(
	    LDM_ENTY_ID
	   , EXP_DTM
	   , STR_DTM 	
	   <include refid="wam_col"/>   
	)
	SELECT A.LDM_ENTY_ID AS LDM_ENTY_ID
	     , TO_DATE( '9999-12-31', 'YYYY-MM-DD') AS EXP_DTM
	     , SYSDATE AS STR_DTM 	
	     <include refid="wam_col"/>   
	 FROM WAQ_LDM_ENTY A
	WHERE A.RQST_NO = #{rqstNo}
	  AND A.RVW_STS_CD = '1'
   </insert>
   
   <update id="updateLdmTblIdForDdltbl">
   --WAM_DDL_TBL의 LDM_ENTY_ID를 업데이트 한다.
   --업데이트 대상은 주제영역 + 테이블이 동일하지만 테이블 ID가 틀린 경우임....
   --물리모델 WAQ to WAM 이후 처리 
	UPDATE WAM_DDL_TBL X 
	   SET LDM_ENTY_ID = (
	            SELECT D.LDM_ENTY_ID     
	             FROM WAH_LDM_ENTY A
	                JOIN WAM_LDM_ENTY D
	                 ON A.LDM_ENTY_LNM = D.LDM_ENTY_LNM
	                AND A.SUBJ_ID = D.SUBJ_ID 
	                AND A.EXP_DTM = TO_DATE('9999-12-31', 'YYYY-MM-DD')
	             WHERE 1=1 
	               
	               AND A.LDM_ENTY_ID = X.LDM_ENTY_ID
	               AND D.LDM_ENTY_ID != X.LDM_ENTY_ID
	   )
	 WHERE 1=1
	   AND EXISTS ( 
	            SELECT 1     
	             FROM WAH_LDM_ENTY A
	                JOIN WAM_LDM_ENTY D
	                 ON A.LDM_ENTY_LNM = D.LDM_ENTY_LNM
	                AND A.SUBJ_ID = D.SUBJ_ID 
	                AND A.EXP_DTM = TO_DATE('9999-12-31', 'YYYY-MM-DD')
	             WHERE 1=1 
	               
	               AND A.LDM_ENTY_ID = X.LDM_ENTY_ID
	               AND D.LDM_ENTY_ID != X.LDM_ENTY_ID   
	   )   
   </update>   
   
   
   <select id="selectmartlist" parameterType="map" resultMap="BaseResultMap" >
  	--물리모델 테이블 추가대상 조회...
	   SELECT RQST_NO
	      , 'I' AS IBS_STATUS
	      ,TRIM(PDM_TBL_LNM) AS PDM_TBL_LNM
	      ,TRIM(LDM_ENTY_LNM) AS LDM_ENTY_LNM
	      ,MAX(DESCRIPTION) AS  DESCRIPTION
	      ,MDL_LNM || '>' || UPP_SUBJ_LNM || '>' || SUBJ_LNM AS 	FULL_PATH
	      , MAX(UDP_ROW_BAK_FCY) AS BCK_FCY
	      , '' AS DEL_CRI
	      , '' AS DEL_MTD
	      , MAX(UDP_ROW_DEL_FCY_UNIT)
	      , MAX(UDP_ROW_CTD_FCY) AS CTD_FCY
	      , MAX(UDP_ROW_CTD_FCY_UNIT)
	      , 'CU' AS RQST_DCD
	      , MDL_LNM, UPP_SUBJ_LNM, SUBJ_LNM
	  FROM (
	        SELECT   DISTINCT #{reqmst.rqstNo} AS RQST_NO 
			      ,A.OBJECTNAME AS MDL_LNM
			      ,D.OBJECTNAME AS UPP_SUBJ_LNM
			      ,F.OBJECTNAME AS SUBJ_LNM
			      ,NVL(H.STRINGVALUE, I.STRINGVALUE) AS PDM_TBL_LNM
			      ,NVL(I.STRINGVALUE, H.STRINGVALUE) AS LDM_ENTY_LNM
			      ,NVL(H.OBJECTID, I.OBJECTID) AS ENTITY_ID
			      ,MMART7.WISE_M7_INFO.GET_ENTITY_DEFINITION(H.OBJECTID) AS DESCRIPTION
			      ,MMART7.WISE_M7_INFO.get_udp_info(d.objectid, h.objectid, '$UDP_ROW_INIT_CNT_NM', 'Logical', 'Entity') AS UDP_ROW_INIT_CNT
			      ,MMART7.WISE_M7_INFO.get_udp_info(d.objectid, h.objectid, '$UDP_ROW_INIT_CNT_UNIT_NM', 'Logical', 'Entity') AS UDP_ROW_INIT_CNT_UNIT
			      ,MMART7.WISE_M7_INFO.get_udp_info(d.objectid, h.objectid, '$UDP_ROW_INC_CNT_NM', 'Logical', 'Entity') AS UDP_ROW_INC_CNT
			      ,MMART7.WISE_M7_INFO.get_udp_info(d.objectid, h.objectid, '$UDP_ROW_INC_CNT_UNIT_NM', 'Logical', 'Entity') AS UDP_ROW_INC_CNT_UNIT
			      ,MMART7.WISE_M7_INFO.get_udp_info(d.objectid, h.objectid, '$UDP_ROW_BAK_FCY_NM', 'Logical', 'Entity') AS UDP_ROW_BAK_FCY
			      ,MMART7.WISE_M7_INFO.get_udp_info(d.objectid, h.objectid, '$UDP_ROW_BAK_FCY_UNIT_NM', 'Logical', 'Entity') AS UDP_ROW_BAK_FCY_UNIT
			      ,MMART7.WISE_M7_INFO.get_udp_info(d.objectid, h.objectid, '$UDP_ROW_CTD_FCY_NM', 'Logical', 'Entity') AS UDP_ROW_CTD_FCY
			      ,MMART7.WISE_M7_INFO.get_udp_info(d.objectid, h.objectid, '$UDP_ROW_CTD_FCY_UNIT_NM', 'Logical', 'Entity') AS UDP_ROW_CTD_FCY_UNIT
			      ,MMART7.WISE_M7_INFO.get_udp_info(d.objectid, h.objectid, '$UDP_ROW_DEL_FCY_NM', 'Logical', 'Entity') AS UDP_ROW_DEL_FCY
			      ,MMART7.WISE_M7_INFO.get_udp_info(d.objectid, h.objectid, '$UDP_ROW_DEL_FCY_UNIT_NM', 'Logical', 'Entity') AS UDP_ROW_DEL_FCY_UNIT
			      ,MMART7.WISE_M7_INFO.get_udp_info(d.objectid, h.objectid, '$UDP_ROW_MAX_CNT_NM', 'Logical', 'Entity') AS UDP_ROW_MAX_CNT
			      ,MMART7.WISE_M7_INFO.get_udp_info(d.objectid, h.objectid, '$UDP_ROW_MAX_CNT_UNIT_NM', 'Logical', 'Entity') AS UDP_ROW_MAX_CNT_UNIT
			      ,MMART7.WISE_M7_INFO.get_udp_info(d.objectid, h.objectid, '$UDP_ROW_OCR_CNT_NM', 'Logical', 'Entity') AS UDP_ROW_OCR_CNT
			      ,MMART7.WISE_M7_INFO.get_udp_info(d.objectid, h.objectid, '$UDP_ROW_OCR_CNT_UNIT_NM', 'Logical', 'Entity') AS UDP_ROW_OCR_CNT_UNIT
			      ,MMART7.WISE_M7_INFO.get_udp_info(d.objectid, h.objectid, '$UDP_PARTITION_NM', 'Logical', 'Entity') AS UDP_PARTITION_YN
			      ,MMART7.WISE_M7_INFO.get_udp_info(d.objectid, h.objectid, '$UDP_ODS_TGT_GB_NM', 'Logical', 'Entity') AS UDP_ODS_TGT_GB
			      ,MMART7.WISE_M7_INFO.get_udp_info(d.objectid, h.objectid, '$UDP_SYNONYM_NM', 'Logical', 'Entity') AS UDP_SYNONYM_NM
			      ,MMART7.WISE_M7_INFO.get_udp_info(d.objectid, h.objectid, '$UDP_DB_NM', 'Logical', 'Entity') AS UDP_DB_NM
			      ,MMART7.WISE_M7_INFO.get_udp_info(d.objectid, h.objectid, '$UDP_OWNER_NM', 'Logical', 'Entity') AS UDP_OWNER_NM
			      ,MMART7.WISE_M7_INFO.get_udp_info(d.objectid, h.objectid, '$UDP_OF_DCR_PLY_DIT_NM', 'Logical', 'Entity') AS UDP_OF_DCR_PLY_DIT_NM
			      ,MMART7.WISE_M7_INFO.get_udp_info(d.objectid, h.objectid, '$UDP_CDM_SUBJ_NM', 'Logical', 'Entity') AS UDP_CDM_SUBJ_NM
			      ,MMART7.WISE_M7_INFO.get_udp_info(d.objectid, h.objectid, '$UDP_ENTITY_DIT_NM', 'Logical', 'Entity') AS UDP_ENTITY_DIT_NM
			      ,MMART7.WISE_M7_INFO.get_udp_info(d.objectid, h.objectid, '$UDP_EXTERNAL_TGT_NM', 'Logical', 'Entity') AS UDP_EXTERNAL_TGT_NM
			      ,MMART7.WISE_M7_INFO.get_udp_info(d.objectid, h.objectid, '$UDP_EXTERNAL_TBL_PTH_NM', 'Logical', 'Entity') AS UDP_EXTERNAL_TBL_PTH_NM
			      ,NVL(MMART7.WISE_M7_INFO.get_udp_info(d.objectid, h.objectid, 'ILM대상여부', 'Logical', 'Entity'),'N') AS ILM_TGT_YN     
			FROM  MMART7.M7LIBRARY A
			      , MMART7.M7OBJECT B
			      , MMART7.M7OBJECT C
			      , MMART7.M7LIBRARY D
			      , MMART7.M7OBJECT E
			      , MMART7.M7LIBRARY F
			      , MMART7.M7OBJECTPROPERTY G
			      , MMART7.M7OBJECTPROPERTY H
			      , MMART7.M7OBJECTPROPERTY I
			      , MMART7.M7OBJECTPROPERTY J
			WHERE A.OBJECTID = B.OBJECTID
			  AND B.CLASSID = 2
			  AND B.ENDVERSION IS NULL
			  AND A.OBJECTID = C.CONTAINERID
			  AND C.CLASSID = 1075838978
			  AND C.ENDVERSION IS NULL
			  AND C.OBJECTID = D.OBJECTID
			  AND D.OBJECTID = E.CONTAINERID
			  AND E.CLASSID = 1075839014
			  AND E.ENDVERSION IS NULL
			  AND E.OBJECTID = F.OBJECTID
			  AND F.OBJECTID = G.OBJECTID
			  AND G.PROPERTYID = 1075849443
			  AND G.VALUEOBJECTID = H.OBJECTID
			  AND H.PROPERTYID = 1073742126
			  AND H.OBJECTID = I.OBJECTID(+)
			  AND I.PROPERTYID(+) = 1075849176
			  AND H.OBJECTID = J.OBJECTID(+)
			  AND J.PROPERTYID(+) = 1073742125
			  AND F.OBJECTNAME != '&lt;Main Subject Area&gt;'
              AND NVL(H.STRINGVALUE, I.STRINGVALUE) IN 
			<foreach collection="list" item="item" open="(" separator="," close=")">
	  		#{item.pdmTblLnm}
	 		</foreach>
			ORDER BY PDM_TBL_LNM   ) A
--          WHERE NOT EXISTS
--          (
--          	 SELECT 1
--          	 FROM WAE_ERMART_R7_ENTY B
--            WHERE A.OF_DATAMODEL      = B.OF_DATAMODEL 
--              AND A.OF_PRIMARY_SUBJ   = B.OF_PRIMARY_SUBJ
--              AND A.OF_SUBJ           = B.OF_SUBJ
--              AND A.OBJ_ENM           = B.OBJ_ENM
--              AND A.REQUEST_ID        = B.REQUEST_ID
--          )
		  GROUP BY RQST_NO,  MDL_LNM, UPP_SUBJ_LNM, SUBJ_LNM, PDM_TBL_LNM, LDM_ENTY_LNM	
  </select>
   
        <insert id="insertWaqRejected" parameterType="map" >
  	       INSERT INTO WAQ_LDM_ENTY(
                     	RQST_NO
                       ,RQST_SNO
                       ,LDM_ENTY_ID
                       ,LDM_ENTY_LNM
                       ,PDM_TBL_LNM
                       ,BF_LDM_ENTY_LNM
                       ,RQST_DCD
                       ,RVW_STS_CD
                       ,RVW_CONTS
                       ,VRF_CD
                       ,VRF_RMK
                       ,MDL_LNM
                       ,UPP_SUBJ_LNM
                       ,SUBJ_ID
                       ,SUBJ_LNM
                       ,STD_APL_YN
                       ,PART_TBL_YN
                       ,DW_TRG_TBL_YN
                       ,CRG_USER_ID
                       ,CRG_USER_NM
                       ,OBJ_DESCN
                       ,OBJ_VERS
                       ,REG_TYP_CD
                       ,FRS_RQST_DTM
                       ,FRS_RQST_USER_ID
                       ,RQST_DTM
                       ,RQST_USER_ID
                       ,APRV_DTM
                       ,APRV_USER_ID
                       ,CTD_FCY
                       ,DEL_CRI
                       ,DEL_MTD
                       ,BCK_FCY
                       ,FULL_PATH
                       ,USER_RQST_CNTN
  	       )
  	       SELECT 
  	                   #{reqmst.rqstNo,jdbcType=VARCHAR}
                       ,RQST_SNO
                       ,LDM_ENTY_ID
                       ,LDM_ENTY_LNM
                       ,PDM_TBL_LNM
                       ,BF_LDM_ENTY_LNM
                       ,RQST_DCD
                       ,'0'
                       ,NULL
                       ,NULL
                       ,NULL
                       ,MDL_LNM
                       ,UPP_SUBJ_LNM
                       ,SUBJ_ID
                       ,SUBJ_LNM
                       ,STD_APL_YN
                       ,PART_TBL_YN
                       ,DW_TRG_TBL_YN
                       ,CRG_USER_ID
                       ,CRG_USER_NM
                       ,OBJ_DESCN
                       ,OBJ_VERS
                       ,REG_TYP_CD
                       ,FRS_RQST_DTM
                       ,FRS_RQST_USER_ID
                       ,RQST_DTM
                       ,RQST_USER_ID
                       ,NULL
                       ,NULL
                       ,CTD_FCY
                       ,DEL_CRI
                       ,DEL_MTD
                       ,BCK_FCY
                       ,FULL_PATH
                       ,USER_RQST_CNTN
  	          FROM WAQ_LDM_ENTY A
  	          WHERE A.RQST_NO = #{oldRqstNo,jdbcType=VARCHAR}
  	          AND A.RVW_STS_CD = '2'
       </insert>
       
    <insert id="checkMstTblExists" parameterType="map">
  	<include refid="kr.wise.commons.rqstmst.service.WaqRqstVrfDtlsMapper.insertVrfDtlSql"/>
  	--검증쿼리 : 마스터 테이블 미존재 (PT011)
    AND EXISTS (
    		     SELECT 1 
    		     FROM WAM_MST_TBL_MAP Z
    		     WHERE Z.EXP_DTM = TO_DATE('99991231', 'YYYYMMDD')
    		     AND Z.REG_TYP_CD IN ('C', 'U') 
    		     AND A.LDM_ENTY_LNM = Z.HIST_DDL_TBL_PNM
    		     AND Z.MST_DDL_TBL_PNM NOT IN (SELECT LDM_ENTY_LNM FROM  WAQ_LDM_ENTY Q WHERE Q.RQST_NO = #{rqstNo,jdbcType=VARCHAR})
               )
  </insert> 
   <insert id="checkHistTblExists" parameterType="map">
  	<include refid="kr.wise.commons.rqstmst.service.WaqRqstVrfDtlsMapper.insertVrfDtlSql"/>
  	--검증쿼리 : 이력 테이블 미존재 (PT012)
    AND EXISTS (
    		     SELECT 1 
    		     FROM WAM_MST_TBL_MAP Z
    		     WHERE Z.EXP_DTM = TO_DATE('99991231', 'YYYYMMDD')
    		     AND Z.REG_TYP_CD IN ('C', 'U') 
    		     AND A.LDM_ENTY_LNM = Z.MST_DDL_TBL_PNM
    		     AND Z.HIST_DDL_TBL_PNM NOT IN (SELECT LDM_ENTY_LNM FROM  WAQ_LDM_ENTY Q WHERE Q.RQST_NO = #{rqstNo,jdbcType=VARCHAR})
               )
  </insert> 
  
   
  <select id="selectSubjDbmsTypCd" parameterType="string" resultType="string" >
    <![CDATA[
   
    SELECT C.DBMS_TYP_CD
	  FROM WAQ_LDM_ENTY A	       
	       INNER JOIN WAA_SUBJ C
	          ON C.EXP_DTM = TO_DATE('9999-12-31','YYYY-MM-DD')
	         AND C.SUBJ_ID = A.SUBJ_ID
	 WHERE A.RQST_NO = #{rqstNo}
	   AND A.RQST_DCD = 'CU'
	   AND ROWNUM <= 1          
     
	 ]]>  
  </select>
   
</mapper>



