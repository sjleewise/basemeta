<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="kr.wise.meta.model.service.WaqPdmTblMapper" >
  <resultMap id="BaseResultMap" type="kr.wise.meta.model.service.WaqPdmTbl" extends="kr.wise.commons.cmm.service.CommonMapper.BaseResultMap" >
    <id column="RQST_NO" property="rqstNo" jdbcType="VARCHAR" />
    <id column="RQST_SNO" property="rqstSno" jdbcType="DECIMAL" />
    <result column="PDM_TBL_ID" property="pdmTblId" jdbcType="VARCHAR" />
    <result column="PDM_TBL_PNM" property="pdmTblPnm" jdbcType="VARCHAR" />
    <result column="PDM_TBL_LNM" property="pdmTblLnm" jdbcType="VARCHAR" />
    <result column="BF_PDM_TBL_PNM" property="bfPdmTblPnm" jdbcType="VARCHAR" />
<!--     <result column="RQST_DCD" property="rqstDcd" jdbcType="VARCHAR" /> -->
<!--     <result column="RVW_STS_CD" property="rvwStsCd" jdbcType="VARCHAR" /> -->
<!--     <result column="RVW_CONTS" property="rvwConts" jdbcType="VARCHAR" /> -->
<!--     <result column="VRF_CD" property="vrfCd" jdbcType="VARCHAR" /> -->
<!--     <result column="VRF_RMK" property="vrfRmk" jdbcType="VARCHAR" /> -->
    <result column="MDL_LNM" property="mdlLnm" jdbcType="VARCHAR" />
    <result column="UPP_SUBJ_LNM" property="uppSubjLnm" jdbcType="VARCHAR" />
    <result column="SUBJ_ID" property="subjId" jdbcType="VARCHAR" />
    <result column="SUBJ_LNM" property="subjLnm" jdbcType="VARCHAR" />
    <result column="STD_APL_YN" property="stdAplYn" jdbcType="VARCHAR" />
    <result column="PART_TBL_YN" property="partTblYn" jdbcType="VARCHAR" />
    <result column="DW_TRG_TBL_YN" property="dwTrgTblYn" jdbcType="VARCHAR" />
    <result column="CRG_USER_ID" property="crgUserId" jdbcType="VARCHAR" />
    <result column="CRG_USER_NM" property="crgUserNm" jdbcType="VARCHAR" />
<!--     <result column="OBJ_DESCN" property="objDescn" jdbcType="VARCHAR" /> -->
<!--     <result column="OBJ_VERS" property="objVers" jdbcType="DECIMAL" /> -->
<!--     <result column="REG_TYP_CD" property="regTypCd" jdbcType="VARCHAR" /> -->
<!--     <result column="FRS_RQST_DTM" property="frsRqstDtm" jdbcType="TIMESTAMP" /> -->
<!--     <result column="FRS_RQST_USER_ID" property="frsRqstUserId" jdbcType="VARCHAR" /> -->
<!--     <result column="RQST_DTM" property="rqstDtm" jdbcType="TIMESTAMP" /> -->
<!--     <result column="RQST_USER_ID" property="rqstUserId" jdbcType="VARCHAR" /> -->
<!--     <result column="APRV_DTM" property="aprvDtm" jdbcType="TIMESTAMP" /> -->
<!--     <result column="APRV_USER_ID" property="aprvUserId" jdbcType="VARCHAR" /> -->
    <result column="CTD_FCY" property="ctdFcy" jdbcType="VARCHAR" />
    <result column="DEL_CRI" property="delCri" jdbcType="VARCHAR" />
    <result column="DEL_MTD" property="delMtd" jdbcType="VARCHAR" />
    <result column="BCK_FCY" property="bckFcy" jdbcType="VARCHAR" />
    <result column="USER_RQST_CNTN" property="userRqstCntn" jdbcType="VARCHAR" />
    <result column="SUBJ_NM"  		property="subjNm" 		jdbcType="VARCHAR" />
	<result column="PRSV_TERM"  	property="prsvTerm" 	jdbcType="VARCHAR" />
	<result column="TBL_TYP_NM"  	property="tblTypNm" 	jdbcType="VARCHAR" />
	<result column="TBL_VOL"  		property="tblVol" 		jdbcType="VARCHAR" />
	<result column="OPEN_RSN_CD"	property="openRsnCd" 	jdbcType="VARCHAR" />
	<result column="NOPEN_RSN"  	property="nopenRsn" 	jdbcType="VARCHAR" />
	<result column="NOPEN_DTL_REL_BSS"  property="nopenDtlRelBss" jdbcType="VARCHAR" />
	<result column="OPEN_DATA_LST"  property="openDataLst" 	jdbcType="VARCHAR" />
	<result column="OCCR_CYL"  		property="occrCyl" 		jdbcType="VARCHAR" />
	<result column="DQ_DGNS_YN"  	property="dqDgnsYn" 	jdbcType="VARCHAR" />
  </resultMap>                                                   
  <sql id="Base_Column_List" >
    RQST_NO, RQST_SNO, PDM_TBL_ID, PDM_TBL_PNM, PDM_TBL_LNM, BF_PDM_TBL_PNM, RQST_DCD, 
    RVW_STS_CD, RVW_CONTS, VRF_CD, VRF_RMK, MDL_LNM, UPP_SUBJ_LNM, SUBJ_ID, SUBJ_LNM, 
    STD_APL_YN, PART_TBL_YN, DW_TRG_TBL_YN, CRG_USER_ID, CRG_USER_NM, OBJ_DESCN, OBJ_VERS, 
    REG_TYP_CD, FRS_RQST_DTM, FRS_RQST_USER_ID, RQST_DTM, RQST_USER_ID, APRV_DTM, APRV_USER_ID, 
    CTD_FCY, DEL_CRI, DEL_MTD, BCK_FCY, FULL_PATH,USER_RQST_CNTN
    ,SUBJ_NM
	,PRSV_TERM
	,TBL_TYP_NM
	,TBL_VOL
	,OPEN_RSN_CD
	,NOPEN_RSN
	,NOPEN_DTL_REL_BSS
	,OPEN_DATA_LST
	,OCCR_CYL
	,DQ_DGNS_YN
  </sql>

  <sql id="waq_Column_List" >
    RQST_NO, RQST_SNO, PDM_TBL_ID, PDM_TBL_PNM, PDM_TBL_LNM, BF_PDM_TBL_PNM, RQST_DCD, 
    RVW_CONTS, VRF_CD, VRF_RMK, MDL_LNM, UPP_SUBJ_LNM, SUBJ_ID, SUBJ_LNM, 
    STD_APL_YN, PART_TBL_YN, DW_TRG_TBL_YN, CRG_USER_ID, CRG_USER_NM, OBJ_DESCN, OBJ_VERS, 
    REG_TYP_CD, FRS_RQST_DTM, FRS_RQST_USER_ID, RQST_DTM, RQST_USER_ID, APRV_DTM, APRV_USER_ID, 
    CTD_FCY, DEL_CRI, DEL_MTD, BCK_FCY, FULL_PATH,USER_RQST_CNTN
    ,SUBJ_NM
	,PRSV_TERM
	,TBL_TYP_NM
	,TBL_VOL
	,OPEN_RSN_CD
	,NOPEN_RSN
	,NOPEN_DTL_REL_BSS
	,OPEN_DATA_LST
	,OCCR_CYL
	,DQ_DGNS_YN
  </sql>
  
  <select id="selectPdmTblListbyMst" parameterType="kr.wise.commons.rqstmst.service.WaqMstr" resultMap="BaseResultMap">
  	--물리모델 테이블 요청서 리스트 조회
  	SELECT 
    A.RQST_NO, A.RQST_SNO, A.PDM_TBL_ID, A.PDM_TBL_PNM, A.PDM_TBL_LNM, A.BF_PDM_TBL_PNM, A.RQST_DCD, 
    A.RVW_CONTS, A.VRF_CD, A.VRF_RMK, A.MDL_LNM, A.UPP_SUBJ_LNM, A.SUBJ_ID, A.SUBJ_LNM, 
    A.STD_APL_YN, A.PART_TBL_YN, A.DW_TRG_TBL_YN, A.CRG_USER_ID, A.CRG_USER_NM, A.OBJ_DESCN, A.OBJ_VERS, 
    A.REG_TYP_CD, A.FRS_RQST_DTM, A.FRS_RQST_USER_ID, A.RQST_DTM, A.RQST_USER_ID, A.APRV_DTM, A.APRV_USER_ID, 
    A.CTD_FCY, A.DEL_CRI, A.DEL_MTD, A.BCK_FCY, A.FULL_PATH
    ,A.SUBJ_NM
	,A.PRSV_TERM
	,A.TBL_TYP_NM
	,A.TBL_VOL
	,A.OPEN_RSN_CD
	,A.NOPEN_RSN
	,A.NOPEN_DTL_REL_BSS
	,A.OPEN_DATA_LST
	,A.OCCR_CYL
	,A.DQ_DGNS_YN
    <if test='rqstStepCd == "Q" '>
     , CASE WHEN A.RVW_STS_CD = '2' THEN '2' ELSE '0' END AS RVW_STS_CD
     </if>
     <if test='rqstStepCd != "Q" '>
     , A.RVW_STS_CD
     </if>
     , CASE WHEN A.VRF_CD = '2' THEN '#FF0000' ELSE CASE WHEN A.VRF_CD = '5' THEN '#0000FF'  END END AS FontColor
     , U.USER_NM AS RQST_USER_NM
     , A.USER_RQST_CNTN
    FROM WAQ_PDM_TBL A
    LEFT OUTER JOIN WAA_USER U
      ON A.RQST_USER_ID = U.USER_ID
     AND U.EXP_DTM = TO_DATE('9999-12-31', 'YYYY-MM-DD')
     AND U.REG_TYP_CD IN ('C', 'U')
    WHERE A.RQST_NO = #{rqstNo,jdbcType=VARCHAR}
    <if test='rqstStepCd == "Q" or rqstStepCd == "A" '>
    	AND A.VRF_CD = '1'
    </if>
    ORDER BY A.RQST_SNO  	
  </select>

  <select id="selectByPrimaryKey" resultMap="BaseResultMap" parameterType="map" >
    select 
    <include refid="Base_Column_List" />
    from WAQ_PDM_TBL
    where RQST_NO = #{rqstNo,jdbcType=VARCHAR}
      and RQST_SNO = #{rqstSno,jdbcType=DECIMAL}
  </select>

  <select id="selectPdmTblDetail" resultMap="BaseResultMap" parameterType="kr.wise.meta.model.service.WaqPdmTbl" >
    -- 물리모델 테이블 요청 상세정보 조회
    select 
    <include refid="Base_Column_List" />
    from WAQ_PDM_TBL
    where RQST_NO = #{rqstNo,jdbcType=VARCHAR}
      and RQST_SNO = #{rqstSno,jdbcType=DECIMAL}
  </select>
  
  <select id="selectwamlist" parameterType="map" resultMap="BaseResultMap" >
  	--물리모델 테이블 추가대상 조회...
   		SELECT 
  			((SELECT COALESCE(MAX(RQST_SNO), 0) FROM WAQ_PDM_TBL WHERE RQST_NO = #{reqmst.rqstNo}) + (ROW_NUMBER() OVER())) AS RQST_SNO
  		   , 'I' AS IBS_STATUS
		   , A.PDM_TBL_ID, A.PDM_TBL_PNM, A.PDM_TBL_LNM
		   , #{reqmst.rqstDcd} AS RQST_DCD
		   , A.SUBJ_ID, A.STD_APL_YN, A.PART_TBL_YN, A.DW_TRG_TBL_YN
		  , A.CRG_USER_ID, B.USER_NM AS CRG_USER_NM, A.OBJ_DESCN, A.OBJ_VERS, A.CTD_FCY, A.DEL_CRI, A.DEL_MTD, A.BCK_FCY, S.FULL_PATH
		  	,A.SUBJ_NM
			,A.PRSV_TERM
			,A.TBL_TYP_NM
			,A.TBL_VOL
			,A.OPEN_RSN_CD
			,A.NOPEN_RSN
			,A.NOPEN_DTL_REL_BSS
			,A.OPEN_DATA_LST
			,A.OCCR_CYL
			,A.DQ_DGNS_YN
			,A.USER_RQST_CNTN
	  FROM WAM_PDM_TBL A
	  LEFT OUTER JOIN WAA_SUBJ S
	    ON A.SUBJ_ID = S.SUBJ_ID
	   AND S.EXP_DTM = TO_DATE( '9999-12-31', 'YYYY-MM-DD')
	   AND S.REG_TYP_CD IN ('C', 'U')
	  LEFT OUTER JOIN WAA_USER B
	    ON A.CRG_USER_ID = B.USER_ID
	   AND B.EXP_DTM = TO_DATE( '9999-12-31', 'YYYY-MM-DD')
	   AND B.REG_TYP_CD IN ('C', 'U')
	  WHERE  A.PDM_TBL_ID IN 
	 <foreach collection="list" item="item" open="(" separator="," close=")">
	  	#{item.pdmTblId}
	 </foreach>
	   AND A.REG_TYP_CD IN ('C', 'U') 	
  </select>
  

  <delete id="deleteByPrimaryKey" parameterType="map" >
    delete from WAQ_PDM_TBL
    where RQST_NO = #{rqstNo,jdbcType=VARCHAR}
      and RQST_SNO = #{rqstSno,jdbcType=DECIMAL}
  </delete>
  <insert id="insert" parameterType="kr.wise.meta.model.service.WaqPdmTbl" >
    insert into WAQ_PDM_TBL (RQST_NO, RQST_SNO, PDM_TBL_ID, 
      PDM_TBL_PNM, PDM_TBL_LNM, BF_PDM_TBL_PNM, 
      RQST_DCD, RVW_STS_CD, RVW_CONTS, 
      VRF_CD, VRF_RMK, MDL_LNM, 
      UPP_SUBJ_LNM, SUBJ_ID, SUBJ_LNM, 
      STD_APL_YN, PART_TBL_YN, DW_TRG_TBL_YN, 
      CRG_USER_ID, CRG_USER_NM, OBJ_DESCN, 
      OBJ_VERS, REG_TYP_CD, FRS_RQST_DTM, 
      FRS_RQST_USER_ID, RQST_DTM, RQST_USER_ID, 
      APRV_DTM, APRV_USER_ID, CTD_FCY, 
      DEL_CRI, DEL_MTD, BCK_FCY
      )
    values (#{rqstNo,jdbcType=VARCHAR}, #{rqstSno,jdbcType=DECIMAL}, #{pdmTblId,jdbcType=VARCHAR}, 
      #{pdmTblPnm,jdbcType=VARCHAR}, #{pdmTblLnm,jdbcType=VARCHAR}, #{bfPdmTblPnm,jdbcType=VARCHAR}, 
      #{rqstDcd,jdbcType=VARCHAR}, #{rvwStsCd,jdbcType=VARCHAR}, #{rvwConts,jdbcType=VARCHAR}, 
      #{vrfCd,jdbcType=VARCHAR}, #{vrfRmk,jdbcType=VARCHAR}, #{mdlLnm,jdbcType=VARCHAR}, 
      #{uppSubjLnm,jdbcType=VARCHAR}, #{subjId,jdbcType=VARCHAR}, #{subjLnm,jdbcType=VARCHAR}, 
      #{stdAplYn,jdbcType=VARCHAR}, #{partTblYn,jdbcType=VARCHAR}, #{dwTrgTblYn,jdbcType=VARCHAR}, 
      #{crgUserId,jdbcType=VARCHAR}, #{crgUserNm,jdbcType=VARCHAR}, #{objDescn,jdbcType=VARCHAR}, 
      #{objVers,jdbcType=DECIMAL}, #{regTypCd,jdbcType=VARCHAR}, #{frsRqstDtm,jdbcType=TIMESTAMP}, 
      #{frsRqstUserId,jdbcType=VARCHAR}, #{rqstDtm,jdbcType=TIMESTAMP}, #{rqstUserId,jdbcType=VARCHAR}, 
      #{aprvDtm,jdbcType=TIMESTAMP}, #{aprvUserId,jdbcType=VARCHAR}, #{ctdFcy,jdbcType=VARCHAR}, 
      #{delCri,jdbcType=VARCHAR}, #{delMtd,jdbcType=VARCHAR}, #{bckFcy,jdbcType=VARCHAR}
      )
  </insert>
  <insert id="insertSelective" parameterType="kr.wise.meta.model.service.WaqPdmTbl" >
	<selectKey keyProperty="rqstSno" resultType="int" statementType="PREPARED" order="BEFORE">
	<!--   		<include refid="kr.wise.commons.cmm.service.CommonMapper.getNextrqstSno"/> -->
		SELECT COALESCE(MAX(RQST_SNO), 0) + 1 FROM WAQ_PDM_TBL WHERE RQST_NO = #{rqstNo}
  	</selectKey>
    insert into WAQ_PDM_TBL
    <trim prefix="(" suffix=")" suffixOverrides="," >
        RQST_NO,
        RQST_SNO,
      <if test="pdmTblId != null" >
        PDM_TBL_ID,
      </if>
      <if test="pdmTblPnm != null" >
        PDM_TBL_PNM,
      </if>
      <if test="pdmTblLnm != null" >
        PDM_TBL_LNM,
      </if>
      <if test="bfPdmTblPnm != null" >
        BF_PDM_TBL_PNM,
      </if>
      <if test="rqstDcd != null" >
        RQST_DCD,
      </if>
      <if test="rvwStsCd != null" >
        RVW_STS_CD,
      </if>
      <if test="rvwConts != null" >
        RVW_CONTS,
      </if>
      <if test="vrfCd != null" >
        VRF_CD,
      </if>
      <if test="vrfRmk != null" >
        VRF_RMK,
      </if>
      <if test="mdlLnm != null" >
        MDL_LNM,
      </if>
      <if test="uppSubjLnm != null" >
        UPP_SUBJ_LNM,
      </if>
      <if test="subjId != null" >
        SUBJ_ID,
      </if>
      <if test="subjLnm != null" >
        SUBJ_LNM,
      </if>
      <if test="stdAplYn != null" >
        STD_APL_YN,
      </if>
      <if test="partTblYn != null" >
        PART_TBL_YN,
      </if>
      <if test="dwTrgTblYn != null" >
        DW_TRG_TBL_YN,
      </if>
      <if test="crgUserId != null" >
        CRG_USER_ID,
      </if>
      <if test="crgUserNm != null" >
        CRG_USER_NM,
      </if>
      <if test="objDescn != null" >
        OBJ_DESCN,
      </if>
        OBJ_VERS,
      <if test="regTypCd != null" >
        REG_TYP_CD,
      </if>
        FRS_RQST_DTM,
      <if test="frsRqstUserId != null" >
        FRS_RQST_USER_ID,
      </if>
        RQST_DTM,
      <if test="rqstUserId != null" >
        RQST_USER_ID,
      </if>
      <if test="ctdFcy != null" >
        CTD_FCY,
      </if>
      <if test="delCri != null" >
        DEL_CRI,
      </if>
      <if test="delMtd != null" >
        DEL_MTD,
      </if>
      <if test="bckFcy != null" >
        BCK_FCY,
      </if>
      <if test="fullPath != null" >
        FULL_PATH,
      </if>      
      <if test="userRqstCntn != null" >
        USER_RQST_CNTN,
      </if>      
      <if test="subjNm != null" >
        SUBJ_NM,
      </if>      
      <if test="prsvTerm != null" >
        PRSV_TERM,
      </if> 
      <if test="tblTypNm != null" >
        TBL_TYP_NM,
      </if>      
      <if test="tblVol != null" >
        TBL_VOL,
      </if>      
      <if test="openRsnCd != null" >
        OPEN_RSN_CD,
      </if>
      <if test="nopenRsn != null" >
        NOPEN_RSN,
      </if>
      <if test="nopenDtlRelBss != null" >
        NOPEN_DTL_REL_BSS,
      </if>     
      <if test="openDataLst != null" >
        OPEN_DATA_LST,
      </if>     
      <if test="occrCyl != null" >
        OCCR_CYL,
      </if>     
      <if test="dqDgnsYn != null" >
        DQ_DGNS_YN
      </if>    
    </trim>
    <trim prefix="values (" suffix=")" suffixOverrides="," >
        #{rqstNo,jdbcType=VARCHAR},
        #{rqstSno,jdbcType=DECIMAL},
      <if test="pdmTblId != null" >
        #{pdmTblId,jdbcType=VARCHAR},
      </if>
      <if test="pdmTblPnm != null" >
        #{pdmTblPnm,jdbcType=VARCHAR},
      </if>
      <if test="pdmTblLnm != null" >
        #{pdmTblLnm,jdbcType=VARCHAR},
      </if>
      <if test="bfPdmTblPnm != null" >
        #{bfPdmTblPnm,jdbcType=VARCHAR},
      </if>
      <if test="rqstDcd != null" >
        #{rqstDcd,jdbcType=VARCHAR},
      </if>
      <if test="rvwStsCd != null" >
        #{rvwStsCd,jdbcType=VARCHAR},
      </if>
      <if test="rvwConts != null" >
        #{rvwConts,jdbcType=VARCHAR},
      </if>
      <if test="vrfCd != null" >
        #{vrfCd,jdbcType=VARCHAR},
      </if>
      <if test="vrfRmk != null" >
        #{vrfRmk,jdbcType=VARCHAR},
      </if>
      <if test="mdlLnm != null" >
        #{mdlLnm,jdbcType=VARCHAR},
      </if>
      <if test="uppSubjLnm != null" >
        #{uppSubjLnm,jdbcType=VARCHAR},
      </if>
      <if test="subjId != null" >
        #{subjId,jdbcType=VARCHAR},
      </if>
      <if test="subjLnm != null" >
        #{subjLnm,jdbcType=VARCHAR},
      </if>
      <if test="stdAplYn != null" >
        #{stdAplYn,jdbcType=VARCHAR},
      </if>
      <if test="partTblYn != null" >
        #{partTblYn,jdbcType=VARCHAR},
      </if>
      <if test="dwTrgTblYn != null" >
        #{dwTrgTblYn,jdbcType=VARCHAR},
      </if>
      <if test="crgUserId != null" >
        #{crgUserId,jdbcType=VARCHAR},
      </if>
      <if test="crgUserNm != null" >
        #{crgUserNm,jdbcType=VARCHAR},
      </if>
      <if test="objDescn != null" >
        #{objDescn,jdbcType=VARCHAR},
      </if>
        1 , 
      <if test="regTypCd != null" >
        #{regTypCd,jdbcType=VARCHAR},
      </if>
        NOW() ,
      <if test="frsRqstUserId != null" >
        #{frsRqstUserId,jdbcType=VARCHAR},
      </if>
        NOW() ,
      <if test="rqstUserId != null" >
        #{rqstUserId,jdbcType=VARCHAR},
      </if>
      <if test="ctdFcy != null" >
        #{ctdFcy,jdbcType=VARCHAR},
      </if>
      <if test="delCri != null" >
        #{delCri,jdbcType=VARCHAR},
      </if>
      <if test="delMtd != null" >
        #{delMtd,jdbcType=VARCHAR},
      </if>
      <if test="bckFcy != null" >
        #{bckFcy,jdbcType=VARCHAR},
      </if>
      <if test="fullPath != null" >
        #{fullPath,jdbcType=VARCHAR},
      </if>
      <if test="userRqstCntn != null" >
         #{userRqstCntn,jdbcType=VARCHAR},
      </if>      
      <if test="subjNm != null" >
         #{subjNm,jdbcType=VARCHAR},
      </if>      
      <if test="prsvTerm != null" >
         #{prsvTerm,jdbcType=VARCHAR},
      </if>  
      <if test="tblTypNm != null" >
        #{tblTypNm,jdbcType=VARCHAR},
      </if>     
      <if test="tblVol != null" >
         #{tblVol,jdbcType=VARCHAR},
      </if>      
      <if test="openRsnCd != null" >
         #{openRsnCd,jdbcType=VARCHAR},
      </if>     
      <if test="nopenRsn != null" >
         #{nopenRsn,jdbcType=VARCHAR},
      </if>
      <if test="nopenDtlRelBss != null" >
         #{nopenDtlRelBss,jdbcType=VARCHAR},
      </if> 
      <if test="openDataLst != null" >
         #{openDataLst,jdbcType=VARCHAR},
      </if> 
      <if test="occrCyl != null" >
         #{occrCyl,jdbcType=VARCHAR},
      </if> 
      <if test="dqDgnsYn != null" >
         #{dqDgnsYn,jdbcType=VARCHAR}
      </if> 
    </trim>
  </insert>

  <update id="updateByPrimaryKeySelective" parameterType="kr.wise.meta.model.service.WaqPdmTbl" >
    update WAQ_PDM_TBL
    <set >
      <if test="pdmTblId != null" >
        PDM_TBL_ID = #{pdmTblId,jdbcType=VARCHAR},
      </if>
      <if test="pdmTblPnm != null" >
        PDM_TBL_PNM = #{pdmTblPnm,jdbcType=VARCHAR},
      </if>
      <if test="pdmTblLnm != null" >
        PDM_TBL_LNM = #{pdmTblLnm,jdbcType=VARCHAR},
      </if>
      <if test="bfPdmTblPnm != null" >
        BF_PDM_TBL_PNM = #{bfPdmTblPnm,jdbcType=VARCHAR},
      </if>
      <if test="rqstDcd != null" >
        RQST_DCD = #{rqstDcd,jdbcType=VARCHAR},
      </if>
      <if test="rvwStsCd != null" >
        RVW_STS_CD = #{rvwStsCd,jdbcType=VARCHAR},
      </if>
      <if test="rvwConts != null" >
        RVW_CONTS = #{rvwConts,jdbcType=VARCHAR},
      </if>
      <if test="vrfCd != null" >
        VRF_CD = #{vrfCd,jdbcType=VARCHAR},
      </if>
      <if test="vrfRmk != null" >
        VRF_RMK = #{vrfRmk,jdbcType=VARCHAR},
      </if>
      <if test="mdlLnm != null" >
        MDL_LNM = #{mdlLnm,jdbcType=VARCHAR},
      </if>
      <if test="uppSubjLnm != null" >
        UPP_SUBJ_LNM = #{uppSubjLnm,jdbcType=VARCHAR},
      </if>
      <if test="subjId != null" >
        SUBJ_ID = #{subjId,jdbcType=VARCHAR},
      </if>
      <if test="subjLnm != null" >
        SUBJ_LNM = #{subjLnm,jdbcType=VARCHAR},
      </if>
        STD_APL_YN = #{stdAplYn,jdbcType=VARCHAR},
        PART_TBL_YN = #{partTblYn,jdbcType=VARCHAR},
        DW_TRG_TBL_YN = #{dwTrgTblYn,jdbcType=VARCHAR},
      <if test="crgUserId != null" >
        CRG_USER_ID = #{crgUserId,jdbcType=VARCHAR},
      </if>
      <if test="crgUserNm != null" >
        CRG_USER_NM = #{crgUserNm,jdbcType=VARCHAR},
      </if>
      <if test="objDescn != null" >
        OBJ_DESCN = #{objDescn,jdbcType=VARCHAR},
      </if>
        RQST_DTM = NOW() ,
      <if test="rqstUserId != null" >
        RQST_USER_ID = #{rqstUserId,jdbcType=VARCHAR},
      </if>
      <if test="ctdFcy != null" >
        CTD_FCY = #{ctdFcy,jdbcType=VARCHAR},
      </if>
      <if test="delCri != null" >
        DEL_CRI = #{delCri,jdbcType=VARCHAR},
      </if>
      <if test="delMtd != null" >
        DEL_MTD = #{delMtd,jdbcType=VARCHAR},
      </if>
      <if test="bckFcy != null" >
        BCK_FCY = #{bckFcy,jdbcType=VARCHAR},
      </if>
      <if test="fullPath != null" >
        FULL_PATH = #{fullPath,jdbcType=VARCHAR},
      </if> 
      <if test="userRqstCntn != null" >
         USER_RQST_CNTN = #{userRqstCntn,jdbcType=VARCHAR},
      </if>      
      <if test="subjNm != null" >
         SUBJ_NM = #{subjNm,jdbcType=VARCHAR},
      </if>      
      <if test="prsvTerm != null" >
         PRSV_TERM = #{prsvTerm,jdbcType=VARCHAR},
      </if>
      <if test="tblTypNm != null">
      	TBL_TYP_NM = #{tblTypNm,jdbcType=VARCHAR},
      </if>      
      <if test="tblVol != null" >
         TBL_VOL = #{tblVol,jdbcType=VARCHAR},
      </if>      
      <if test="openRsnCd != null" >
         OPEN_RSN_CD = #{openRsnCd,jdbcType=VARCHAR},
      </if>  
      	 NOPEN_RSN = #{nopenRsn,jdbcType=VARCHAR},   
      <if test="nopenDtlRelBss != null" >
         NOPEN_DTL_REL_BSS = #{nopenDtlRelBss,jdbcType=VARCHAR},
      </if>   
      <if test="openDataLst != null" >
         OPEN_DATA_LST = #{openDataLst,jdbcType=VARCHAR},
      </if>   
      <if test="occrCyl != null" >
         OCCR_CYL = #{occrCyl,jdbcType=VARCHAR},
      </if>   
      <if test="dqDgnsYn != null" >
         DQ_DGNS_YN = #{dqDgnsYn,jdbcType=VARCHAR}
      </if>  
    </set>
    where RQST_NO = #{rqstNo,jdbcType=VARCHAR}
      and RQST_SNO = #{rqstSno,jdbcType=DECIMAL}
  </update>
  <update id="updateByPrimaryKey" parameterType="kr.wise.meta.model.service.WaqPdmTbl" >
    update WAQ_PDM_TBL
    set PDM_TBL_ID = #{pdmTblId,jdbcType=VARCHAR},
      PDM_TBL_PNM = #{pdmTblPnm,jdbcType=VARCHAR},
      PDM_TBL_LNM = #{pdmTblLnm,jdbcType=VARCHAR},
      BF_PDM_TBL_PNM = #{bfPdmTblPnm,jdbcType=VARCHAR},
      RQST_DCD = #{rqstDcd,jdbcType=VARCHAR},
      RVW_STS_CD = #{rvwStsCd,jdbcType=VARCHAR},
      RVW_CONTS = #{rvwConts,jdbcType=VARCHAR},
      VRF_CD = #{vrfCd,jdbcType=VARCHAR},
      VRF_RMK = #{vrfRmk,jdbcType=VARCHAR},
      MDL_LNM = #{mdlLnm,jdbcType=VARCHAR},
      UPP_SUBJ_LNM = #{uppSubjLnm,jdbcType=VARCHAR},
      SUBJ_ID = #{subjId,jdbcType=VARCHAR},
      SUBJ_LNM = #{subjLnm,jdbcType=VARCHAR},
      STD_APL_YN = #{stdAplYn,jdbcType=VARCHAR},
      PART_TBL_YN = #{partTblYn,jdbcType=VARCHAR},
      DW_TRG_TBL_YN = #{dwTrgTblYn,jdbcType=VARCHAR},
      CRG_USER_ID = #{crgUserId,jdbcType=VARCHAR},
      CRG_USER_NM = #{crgUserNm,jdbcType=VARCHAR},
      OBJ_DESCN = #{objDescn,jdbcType=VARCHAR},
      OBJ_VERS = #{objVers,jdbcType=DECIMAL},
      REG_TYP_CD = #{regTypCd,jdbcType=VARCHAR},
      FRS_RQST_DTM = #{frsRqstDtm,jdbcType=TIMESTAMP},
      FRS_RQST_USER_ID = #{frsRqstUserId,jdbcType=VARCHAR},
      RQST_DTM = #{rqstDtm,jdbcType=TIMESTAMP},
      RQST_USER_ID = #{rqstUserId,jdbcType=VARCHAR},
      APRV_DTM = #{aprvDtm,jdbcType=TIMESTAMP},
      APRV_USER_ID = #{aprvUserId,jdbcType=VARCHAR},
      CTD_FCY = #{ctdFcy,jdbcType=VARCHAR},
      DEL_CRI = #{delCri,jdbcType=VARCHAR},
      DEL_MTD = #{delMtd,jdbcType=VARCHAR},
      BCK_FCY = #{bckFcy,jdbcType=VARCHAR},
      USER_RQST_CNTN = #{userRqstCntn,jdbcType=VARCHAR}
    where RQST_NO = #{rqstNo,jdbcType=VARCHAR}
      and RQST_SNO = #{rqstSno,jdbcType=DECIMAL}
  </update>
  
  <delete id="deleteByrqstSno" parameterType="kr.wise.meta.model.service.WaqPdmTbl">
  	DELETE FROM WAQ_PDM_TBL
  	 WHERE RQST_NO  = #{rqstNo}
  	   AND RQST_SNO = #{rqstSno}
  </delete>
  
  
  <!-- 검증SQL -->
  <update id="updateCheckInit" parameterType="java.lang.String" >
    UPDATE WAQ_PDM_TBL A
       SET (REG_TYP_CD, PDM_TBL_ID) = 
                          (SELECT CASE WHEN A.RQST_DCD = 'DD' THEN 'D' ELSE CASE WHEN NULLIF(MAX(B.PDM_TBL_ID ), '') IS NULL THEN 'C' ELSE 'U' END END
                                , MAX(B.PDM_TBL_ID) AS PDM_TBL_ID
                             FROM WAM_PDM_TBL B 
                                  INNER JOIN WAA_SUBJ C
                                    ON C.EXP_DTM = TO_DATE('9999-12-31', 'YYYY-MM-DD')
	   				   	           AND C.REG_TYP_CD IN ('C', 'U')
	   				   	           AND C.SUBJ_ID = B.SUBJ_ID
                            WHERE B.REG_TYP_CD IN ('C','U')
                              AND B.PDM_TBL_PNM = A.PDM_TBL_PNM
                              AND C.FULL_PATH   = A.FULL_PATH 
                          --  GROUP BY B.PDM_TBL_ID, A.RQST_DCD                           
                          )
        , VRF_CD = '4'
    WHERE A.RQST_NO = #{rqstNo,jdbcType=VARCHAR}
  </update>  
  
  <update id="updateStndApplybySubj" parameterType="string">
  --주제영역의 표준적용 여부에 따라 테이블 표준적용여부 업데이트
	UPDATE WAQ_PDM_TBL A
	   SET (STD_APL_YN, SUBJ_ID, STND_ASRT) = 
	               (SELECT COALESCE(B.STD_APL_YN, 'Y')
					     , B.SUBJ_ID 
					     , B.STND_ASRT
					  FROM WAA_SUBJ B
					 WHERE B.EXP_DTM = TO_DATE('9999-12-31', 'YYYY-MM-DD')
					   AND B.REG_TYP_CD IN ('C', 'U')
					   AND B.FULL_PATH = A.FULL_PATH					  
			        )
	 WHERE A.RQST_NO = #{rqstNo}
	   AND EXISTS (SELECT 1
			         FROM WAA_SUBJ B
			        WHERE B.EXP_DTM = TO_DATE('9999-12-31', 'YYYY-MM-DD')
			          AND B.REG_TYP_CD IN ('C', 'U')
			          AND B.FULL_PATH = A.FULL_PATH				
		          )
	   
	   
  </update>
  
  <update id="updateStndApplybyCol" parameterType="string">
 	--비표준 테이블의 컬럼이 모두 표준항목 ID가 있는 경우 표준적용으로 업데이트...
	--사전에 컬럼의 표준항목 ID가 사전에 업데이트 되어 있어야 한다....
	UPDATE WAQ_PDM_TBL A
	   SET STD_APL_YN = 'Y'
	 WHERE A.RQST_NO = #{rqstNo}
	   AND A.STD_APL_YN != 'Y'
	   AND (SELECT COUNT(*) FROM WAQ_PDM_COL B 
	   		 WHERE A.RQST_NO = B.RQST_NO
	           AND A.RQST_SNO = B.RQST_SNO ) > 0
	   AND NOT EXISTS (
			SELECT 1 FROM WAQ_PDM_COL B
	         WHERE A.RQST_NO = B.RQST_NO
	           AND A.RQST_SNO = B.RQST_SNO
			   AND A.PDM_TBL_PNM = B.PDM_TBL_PNM
		       AND B.SDITM_ID IS NULL
			)
  </update>
  
 <insert id="checkRequestTbl" parameterType="map">
  	<include refid="kr.wise.commons.rqstmst.service.WaqRqstVrfDtlsMapper.insertVrfDtlSql"/>
  	--검증쿼리 : 요청중인 테이블 (PT004)
    AND EXISTS (
    		SELECT 1 FROM WAQ_MSTR E
             INNER JOIN WAQ_PDM_TBL D
             	ON E.RQST_NO = D.RQST_NO
             WHERE E.RQST_NO != #{rqstNo}
               AND E.RQST_STEP_CD = 'Q'
               AND A.PDM_TBL_PNM = D.PDM_TBL_PNM
<!--                AND A.PDM_TBL_LNM = D.PDM_TBL_LNM -->
               AND A.FULL_PATH	= D.FULL_PATH
			   AND COALESCE(D.RVW_STS_CD, '0') != '2'
               )
  </insert> 

 <insert id="checkDupTbl" parameterType="map">
  	<include refid="kr.wise.commons.rqstmst.service.WaqRqstVrfDtlsMapper.insertVrfDtlSql"/>
  	--검증쿼리 : 요청서내 중복(PT001)
    AND EXISTS (SELECT 1
             FROM WAQ_PDM_TBL D
             WHERE A.RQST_NO = D.RQST_NO
               AND A.PDM_TBL_PNM = D.PDM_TBL_PNM
<!--                AND A.PDM_TBL_LNM = D.PDM_TBL_LNM -->
               AND A.FULL_PATH	= D.FULL_PATH
               AND A.RQST_SNO != D.RQST_SNO)
  </insert> 


  <insert id="checkNotExistTbl" parameterType="map">
  	<include refid="kr.wise.commons.rqstmst.service.WaqRqstVrfDtlsMapper.insertVrfDtlSql"/>
      --검증쿼리 : 삭제대상 테이블 미존재(PT002)
      AND A.RQST_DCD = 'DD'
      AND NOT EXISTS (SELECT 1
                  FROM WAM_PDM_TBL D
                  WHERE A.PDM_TBL_PNM = D.PDM_TBL_PNM
<!--                		AND A.PDM_TBL_LNM = D.PDM_TBL_LNM -->
               		AND A.FULL_PATH	= D.FULL_PATH
                    AND D.REG_TYP_CD IN ('C', 'U'))  
  </insert>
  
  <insert id="checkNonSubjID" parameterType="map">
	  <include refid="kr.wise.commons.rqstmst.service.WaqRqstVrfDtlsMapper.insertVrfDtlSql"/>
	  --검증쿼리 : 주제영역 미존재(PT003)
	  AND NOT EXISTS ( SELECT 1 FROM WAA_SUBJ D
	  					WHERE A.FULL_PATH = D.FULL_PATH
	  					  AND D.EXP_DTM  = TO_DATE( '9999-12-31', 'YYYY-MM-DD')
				          AND D.REG_TYP_CD IN ('C', 'U')
	  				)	
  </insert>

  <insert id="checkTblNameLength" parameterType="map">
	  <include refid="kr.wise.commons.rqstmst.service.WaqRqstVrfDtlsMapper.insertVrfDtlSql"/>
	  --검증쿼리 : 테이블명 길이 체크(PT005)
      <![CDATA[
      AND A.RQST_DCD = 'CU'
      AND LENGTH(A.PDM_TBL_PNM) > 25
      ]]>
  </insert>
  <insert id="checkColCnt" parameterType="map">
	  <include refid="kr.wise.commons.rqstmst.service.WaqRqstVrfDtlsMapper.insertVrfDtlSql"/>
	  --검증쿼리 : 컬럼 존재여부 체크(PT006)
      <![CDATA[
      AND A.RQST_DCD = 'CU'
      AND NOT EXISTS ( SELECT 1
						       FROM WAQ_PDM_COL X
						      WHERE X.RQST_NO = A.RQST_NO 
						         AND X.RQST_SNO = A.RQST_SNO )
      ]]>
  </insert>

  <insert id="checkNotChgData" parameterType="map">
	  <!-- <include refid="kr.wise.commons.rqstmst.service.WaqRqstVrfDtlsMapper.insertVrfDtlSql"/>  -->
	  
	  <include refid="kr.wise.commons.rqstmst.service.WaqRqstVrfDtlsMapper.updateVrfNotChg"/>
	  --검증쿼리 : 변경일 때 변경된 데이터가 없을 경우 (PT000)
      AND A.REG_TYP_CD = 'U'
      AND EXISTS (
      		SELECT 1 
      		  FROM WAM_PDM_TBL D
      		 WHERE A.FULL_PATH   = D.FULL_PATH
      		   AND A.PDM_TBL_PNM = D.PDM_TBL_PNM
      		   AND COALESCE(NULLIF(A.PDM_TBL_LNM, ''),'_') = COALESCE(NULLIF(D.PDM_TBL_LNM, ''),'_')      		  
      		   AND COALESCE(A.STD_APL_YN, '_') 	= COALESCE(D.STD_APL_YN, '_')
      		   --AND COALESCE(A.PART_TBL_YN, '_') 	= COALESCE(D.PART_TBL_YN, '_')
      		   --AND COALESCE(A.DW_TRG_TBL_YN, '_') 	= COALESCE(D.DW_TRG_TBL_YN, '_')
      		   --AND COALESCE(A.CRG_USER_ID, '_') 	= COALESCE(D.CRG_USER_ID, '_')
      		   --AND COALESCE(A.CRG_USER_NM, '_') 	= COALESCE(D.CRG_USER_NM, '_')
      		   AND COALESCE(NULLIF(A.USER_RQST_CNTN, ''), '_') = COALESCE(NULLIF(D.USER_RQST_CNTN, ''), '_')
      		   AND COALESCE(NULLIF(A.OBJ_DESCN, ''), '_') 		= COALESCE(NULLIF(D.OBJ_DESCN, ''), '_')
      		   AND COALESCE(A.CTD_FCY, '_') 		= COALESCE(D.CTD_FCY, '_')
      		   AND COALESCE(A.DEL_CRI, '_') 		= COALESCE(D.DEL_CRI, '_')
      		   AND COALESCE(A.DEL_MTD, '_') 		= COALESCE(D.DEL_MTD, '_')
      		   AND COALESCE(A.BCK_FCY, '_') 		= COALESCE(D.BCK_FCY, '_')
      		   AND COALESCE(NULLIF(A.SUBJ_NM, ''), '_')    	= COALESCE(NULLIF(D.SUBJ_NM, ''), '_')
			   AND COALESCE(NULLIF(A.PRSV_TERM, ''), '_')  	= COALESCE(NULLIF(D.PRSV_TERM, ''), '_')
			   AND COALESCE(NULLIF(A.TBL_TYP_NM, ''), '_')  = COALESCE(NULLIF(D.TBL_TYP_NM, ''), '_')
			   AND COALESCE(NULLIF(A.TBL_VOL, ''), '_')    	= COALESCE(NULLIF(D.TBL_VOL, ''), '_')
			   AND COALESCE(NULLIF(A.OPEN_RSN_CD, ''), '_')	= COALESCE(NULLIF(D.OPEN_RSN_CD, ''), '_')
			   AND COALESCE(NULLIF(A.NOPEN_RSN, ''), '_')	= COALESCE(NULLIF(D.NOPEN_RSN, ''), '_')
			   AND COALESCE(NULLIF(A.NOPEN_DTL_REL_BSS, ''), '_')	= COALESCE(NULLIF(D.NOPEN_DTL_REL_BSS, ''), '_')
			   AND COALESCE(NULLIF(A.OPEN_DATA_LST, ''), '_')	= COALESCE(NULLIF(D.OPEN_DATA_LST, ''), '_')
			   AND COALESCE(NULLIF(A.OCCR_CYL, ''), '_')	= COALESCE(NULLIF(D.OCCR_CYL, ''), '_')
			   AND COALESCE(NULLIF(A.DQ_DGNS_YN, ''), '_')	= COALESCE(NULLIF(D.DQ_DGNS_YN, ''), '_')
      		)
      AND NOT EXISTS (
      		SELECT 1 FROM WAQ_PDM_COL D
      		 WHERE D.RQST_NO = A.RQST_NO
               AND D.RQST_SNO = A.RQST_SNO
               AND D.VRF_CD = '1'
      		)
      AND NOT EXISTS (
      		SELECT 1 FROM WAQ_PDM_REL E
      		 WHERE E.RQST_NO = A.RQST_NO
               AND E.RQST_SNO = A.RQST_SNO
               AND E.VRF_CD = '1'
      		)
  </insert>
  
  <insert id="checkColErr" parameterType="map">
	  <include refid="kr.wise.commons.rqstmst.service.WaqRqstVrfDtlsMapper.insertVrfDtlSql"/>
	  --검증쿼리 : 컬럼 오류가 있을 경우 체크 (PT999)
	  AND EXISTS (
	  			SELECT 1 FROM WAQ_PDM_COL D
	  			 WHERE A.RQST_NO = D.RQST_NO
	  			   AND A.RQST_SNO = D.RQST_SNO
	  			   AND D.VRF_CD = '2'
	  			   AND EXISTS ( SELECT 1 FROM WAQ_RQST_VRF_DTLS E
	  			   			     WHERE D.RQST_NO 	  = E.RQST_NO
	  			   			       AND D.RQST_SNO 	  = E.RQST_SNO
	  			   			       AND D.RQST_DTL_SNO = E.RQST_DTL_SNO
	  			   			       AND E.VRF_DTL_CD NOT IN ('PC000', 'PR000')
	  			   ) 
	  	)
	  OR EXISTS (
	  			SELECT 1 FROM WAQ_PDM_REL D
	  			 WHERE A.RQST_NO = D.RQST_NO
	  			   AND A.RQST_SNO = D.RQST_SNO
	  			   AND D.VRF_CD = '2'
	  			   AND EXISTS ( SELECT 1 FROM WAQ_RQST_VRF_DTLS E
	  			   			     WHERE D.RQST_NO 	  = E.RQST_NO
	  			   			       AND D.RQST_SNO 	  = E.RQST_SNO
	  			   			       AND D.RQST_DTL_SNO = E.RQST_DTL_SNO
	  			   			       AND E.VRF_DTL_CD NOT IN ('PC000', 'PR000')
	  			   ) 
	  	)
  </insert>
  <insert id="checkRelErr" parameterType="map">
	  <include refid="kr.wise.commons.rqstmst.service.WaqRqstVrfDtlsMapper.insertVrfDtlSql"/>
	  --검증쿼리 : 관계 오류가 있을 경우 체크 (PR999)
	  AND EXISTS (
	  			SELECT 1 FROM WAQ_PDM_REL D
	  			 WHERE A.RQST_NO = D.RQST_NO
	  			   AND A.RQST_SNO = D.RQST_SNO
	  			   AND D.VRF_CD = '2'
	  			   AND EXISTS ( SELECT 1 FROM WAQ_RQST_VRF_DTLS E
	  			   			     WHERE D.RQST_NO 	  = E.RQST_NO
	  			   			       AND D.RQST_SNO 	  = E.RQST_SNO
	  			   			       AND D.RQST_DTL_SNO = E.RQST_DTL_SNO
	  			   			       AND E.VRF_DTL_CD != 'PR000'
	  			   ) 
	  	)
  </insert>
  
  
    <insert id="checkObjdesc" parameterType="map">
	  <include refid="kr.wise.commons.rqstmst.service.WaqRqstVrfDtlsMapper.insertVrfDtlSql"/>
	  --검증쿼리 : 설명존재여부 (PT009)
	  AND A.OBJ_DESCN IS NULL
	  AND A.RQST_NO = #{rqstNo}
  </insert>
<!-- 	테이블명 명명규칙 검증 -->
<!-- 	기표원 명명규칙 입니다. -->
<!-- 	사이트별로 변경 사용 하세요 -->
<!-- 	 테이블물리명 명명규칙 : 1번째 자리 : T  +  2.3번째 자리 : 주제영역 약어 2자리    12번째자리 : 테이블유형정의-->
  <insert id="checkTblName" parameterType="map">
	  <include refid="kr.wise.commons.rqstmst.service.WaqRqstVrfDtlsMapper.insertVrfDtlSql"/>
	  --검증쿼리 : 테이블 물리명 명명규칙 (PT007)
	  AND A.REG_TYP_CD IN ('C','U')	  
	  AND A.STD_APL_YN = 'Y'	  
      AND EXISTS (SELECT 1
                    FROM WAA_SUBJ X
                   WHERE X.EXP_DTM = TO_DATE('9999-12-31', 'YYYY-MM-DD')
                     AND X.REG_TYP_CD IN ('C','U')
                     AND X.SUBJ_LVL = 1
                     AND X.FULL_PATH = A.FULL_PATH
                     AND 'PTB_' || X.SUBJ_ABR_NM != SUBSTR(PDM_TBL_PNM,1,8) || REGEXP_REPLACE(SUBSTR(PDM_TBL_PNM,9,4),'[0-9,A-Z]','')                                           
			      )
  </insert>
  
   <insert id="checkSubjDbSch" parameterType="map">
  	<include refid="kr.wise.commons.rqstmst.service.WaqRqstVrfDtlsMapper.insertVrfDtlSql"/>
  	--검증쿼리 : 주제영역 스키마 매핑 미존재 (PT008)
    AND NOT EXISTS (
    		SELECT 1 
    		FROM WAA_SUBJ SUB
    		INNER JOIN WAA_SUBJ_DB_SCH_MAP DMP
    		ON SUB.SUBJ_ID = DMP.SUBJ_ID
    		AND SUB.EXP_DTM = TO_DATE('99991231', 'YYYYMMDD')
    		AND SUB.REG_TYP_CD IN ('C', 'U')
    		AND DMP.EXP_DTM = TO_DATE('99991231', 'YYYYMMDD')
    		AND DMP.REG_TYP_CD IN ('C', 'U')  
    		WHERE A.FULL_PATH = SUB.FULL_PATH        
           )
  </insert>
  
     <insert id="checkCommonCol" parameterType="map">
  	<include refid="kr.wise.commons.rqstmst.service.WaqRqstVrfDtlsMapper.insertVrfDtlSql"/>
  	--검증쿼리 : 시스템공통컬럼 미존재 (PT010)
    AND '6' != (
    		SELECT COUNT(PDM_COL_PNM) 
    		FROM WAQ_PDM_COL COL
    		WHERE A.RQST_NO = COL.RQST_NO
    		AND A.RQST_SNO = COL.RQST_SNO
    		AND A.PDM_TBL_PNM = COL.PDM_TBL_PNM
    		AND COL.PDM_COL_PNM IN ('SYS_REG_DTTM','SYS_RGSR_EMNO','SYS_REG_BRCD','SYS_CHG_DTTM','SYS_EDIR_EMNO','SYS_CHG_BRCD'	)
    		--AND COL.NONUL_YN = 'Y'
           )
  </insert>  
  
  <!-- 승인/반려 업데이트 -->
  <update id="updatervwStsCd" parameterType="kr.wise.meta.model.service.WaqPdmTbl" >
  	UPDATE WAQ_PDM_TBL
  	<set>
  	    RVW_STS_CD 	= #{rvwStsCd} , 
  		RVW_CONTS 	= #{rvwConts} , 
  		APRV_DTM	= NOW() ,
  		APRV_USER_ID = #{aprvUserId} ,
  	</set>
    WHERE RQST_NO = #{rqstNo,jdbcType=VARCHAR}
      AND RQST_SNO = #{rqstSno,jdbcType=DECIMAL}
      AND VRF_CD = '1'
      AND COALESCE(RVW_STS_CD, '_') != '2'
  </update>

  <!-- 적재 SQL -->
  <!--   적재쿼리 
    selectWaqC
    
	int updateWaqCUD(@Param("rqstNo") String rqstNo);
	int updateWaqC(@Param("rqstNo") String rqstNo);
	int deleteWAM(@Param("rqstNo") String rqstNo);
	int insertWAM(@Param("rqstNo") String rqstNo);
	int updateWAH(@Param("rqstNo") String rqstNo);
	int insertWAH(@Param("rqstNo") String rqstNo);
-->

	<sql id="wam_col">
	, PDM_TBL_PNM, PDM_TBL_LNM, SUBJ_ID, STD_APL_YN, PART_TBL_YN, DW_TRG_TBL_YN
	, CRG_USER_ID, RQST_NO, RQST_SNO, OBJ_DESCN, OBJ_VERS, REG_TYP_CD, FRS_RQST_DTM, FRS_RQST_USER_ID 
    , RQST_DTM, RQST_USER_ID, APRV_DTM, APRV_USER_ID, CTD_FCY, DEL_CRI, DEL_MTD, BCK_FCY, FULL_PATH, USER_RQST_CNTN
    , SUBJ_NM
	, PRSV_TERM
	, TBL_TYP_NM
	, TBL_VOL
	, OPEN_RSN_CD
	, NOPEN_RSN
	, NOPEN_DTL_REL_BSS
	, OPEN_DATA_LST
	, OCCR_CYL
	, DQ_DGNS_YN
   </sql>
   
   <select id="selectWaqC" parameterType="map" resultMap="BaseResultMap">
   	--신규 적재 대상 추출
   	SELECT * FROM WAQ_PDM_TBL
   	WHERE RQST_NO = #{rqstNo}
   	  AND RVW_STS_CD = '1'  --승인
   	  AND REG_TYP_CD = 'C'
   </select>
   
   <update id="updateidByKey" parameterType="kr.wise.meta.model.service.WaqPdmTbl">
     --신규 적재 대상 ID 업데이트
     UPDATE WAQ_PDM_TBL 
        SET PDM_TBL_ID = #{pdmTblId,jdbcType=VARCHAR}
  	  WHERE RQST_NO    = #{rqstNo,jdbcType=VARCHAR}
        AND RQST_SNO   = #{rqstSno,jdbcType=DECIMAL}
   </update>

   <update id="updateWaqCUD" parameterType="map">
   	--WAQ ID, VERS 등을 업데이트...
	UPDATE WAQ_PDM_TBL A
	SET (PDM_TBL_ID, OBJ_VERS, FRS_RQST_DTM, FRS_RQST_USER_ID) = (
	    SELECT 
	          B.PDM_TBL_ID AS PDM_TBL_ID
	        , COALESCE(B.OBJ_VERS, 0) + 1 AS OBJ_VERS
	        , B.FRS_RQST_DTM
	        , B.FRS_RQST_USER_ID
	    FROM WAM_PDM_TBL B
	    JOIN WAA_SUBJ C
	      ON B.SUBJ_ID = C.SUBJ_ID
	     AND C.EXP_DTM = TO_DATE( '9999-12-31', 'YYYY-MM-DD')
	     AND C.REG_TYP_CD IN ('C', 'U')
	    WHERE B.PDM_TBL_PNM = A.PDM_TBL_PNM 
	      AND C.FULL_PATH = A.FULL_PATH
	      --AND B.REG_TYP_CD IN ('C', 'U')
	)
	WHERE A.RQST_NO = #{rqstNo}
	--AND A.VRF_CD = '1' 		--등록가능
	AND A.RVW_STS_CD = '1'  --승인
	AND EXISTS (
		SELECT 1
		  FROM WAM_PDM_TBL B
	      JOIN WAA_SUBJ C
	        ON B.SUBJ_ID = C.SUBJ_ID
	       AND C.EXP_DTM = TO_DATE( '9999-12-31', 'YYYY-MM-DD')
	       AND C.REG_TYP_CD IN ('C', 'U')
	     WHERE B.PDM_TBL_PNM = A.PDM_TBL_PNM
	       AND C.FULL_PATH   = A.FULL_PATH
	      --AND B.REG_TYP_CD IN ('C', 'U')
	)
   </update>
   
   <update id="updateWaqId" parameterType="map">
   	--주제영역 ID 업데이트...
   	UPDATE WAQ_PDM_TBL X 
   	   SET (SUBJ_ID) = (
   		SELECT MAX(SUBJ_ID) 
   		  FROM WAA_SUBJ A
   		 WHERE A.FULL_PATH = X.FULL_PATH
   		   AND A.EXP_DTM = TO_DATE( '9999-12-31', 'YYYY-MM-DD')
	       AND A.REG_TYP_CD IN ('C', 'U')
   		)
   	 WHERE RQST_NO = #{rqstNo}
   	   AND RVW_STS_CD = '1' 
   </update>
   
   <delete id="deleteWAM" parameterType="map">
    --WAM 삭제 (등록유형코드가REG_TYP_CD 변경, 삭제일 경우)
	DELETE FROM WAM_PDM_TBL A
	WHERE EXISTS (
	    SELECT 1 
	      FROM WAQ_PDM_TBL B
	     WHERE B.RQST_NO = #{rqstNo}
	       AND B.RVW_STS_CD = '1'
	       AND B.PDM_TBL_ID = A.PDM_TBL_ID 
	)
   </delete>   

   <insert id="insertWAM" parameterType="map">
   	--WAM 추가 (WAQ 내용을 추가, REG_TYP_CD 가 신규,변경일 경우)
	INSERT INTO WAM_PDM_TBL 
	(
	   PDM_TBL_ID 	
	   <include refid="wam_col"/>	
	)
	SELECT PDM_TBL_ID 	
	       <include refid="wam_col"/>	
	 FROM WAQ_PDM_TBL A
	WHERE A.RQST_NO = #{rqstNo}
	  AND A.RVW_STS_CD = '1'
	  AND A.REG_TYP_CD IN ('C', 'U')
   </insert>  
   
   <update id="updateWAH"  parameterType="map">
   	--WAH 이력 만료...
	UPDATE WAH_PDM_TBL A
	   SET EXP_DTM = NOW()
	 WHERE EXP_DTM = TO_DATE('9999-12-31', 'YYYY-MM-DD')
	   AND REG_TYP_CD IN ('C','U')
	   AND EXISTS (SELECT 1 
	                 FROM WAQ_PDM_TBL B
	                WHERE B.RQST_NO = #{rqstNo}
	                  AND B.RVW_STS_CD = '1'
	                  AND B.PDM_TBL_ID = A.PDM_TBL_ID
	                )
	
   </update>  

   <insert id="insertWAH"  parameterType="map">
   	--WAH이력 적재...
	INSERT INTO WAH_PDM_TBL
	(
	    PDM_TBL_ID
	   , EXP_DTM
	   , STR_DTM 	
	   <include refid="wam_col"/>   
	)
	SELECT A.PDM_TBL_ID AS PDM_TBL_ID
	     , TO_DATE( '9999-12-31', 'YYYY-MM-DD') AS EXP_DTM
	     , NOW() AS STR_DTM 	
	     <include refid="wam_col"/>   
	 FROM WAQ_PDM_TBL A
	WHERE A.RQST_NO = #{rqstNo}
	  AND A.RVW_STS_CD = '1'
   </insert>
   
   <update id="updatePdmTblIdForDdltbl">
   --WAM_DDL_TBL의 PDM_TBL_ID를 업데이트 한다.
   --업데이트 대상은 주제영역 + 테이블이 동일하지만 테이블 ID가 틀린 경우임....
   --물리모델 WAQ to WAM 이후 처리 
	UPDATE WAM_DDL_TBL X 
	   SET PDM_TBL_ID = (
	            SELECT D.PDM_TBL_ID     
	             FROM WAH_PDM_TBL A
	                JOIN WAM_PDM_TBL D
	                 ON A.PDM_TBL_PNM = D.PDM_TBL_PNM
	                AND A.SUBJ_ID = D.SUBJ_ID 
	                AND A.EXP_DTM = TO_DATE('9999-12-31', 'YYYY-MM-DD')
	             WHERE 1=1 
	               
	               AND A.PDM_TBL_ID = X.PDM_TBL_ID
	               AND D.PDM_TBL_ID != X.PDM_TBL_ID
	   )
	 WHERE 1=1
	   AND EXISTS (
	            SELECT 1     
	             FROM WAH_PDM_TBL A
	                JOIN WAM_PDM_TBL D
	                 ON A.PDM_TBL_PNM = D.PDM_TBL_PNM
	                AND A.SUBJ_ID = D.SUBJ_ID 
	                AND A.EXP_DTM = TO_DATE('9999-12-31', 'YYYY-MM-DD')
	             WHERE 1=1 
	               
	               AND A.PDM_TBL_ID = X.PDM_TBL_ID
	               AND D.PDM_TBL_ID != X.PDM_TBL_ID   
	   )   
   </update>   
   
   
   <select id="selectmartlist" parameterType="map" resultMap="BaseResultMap" >
  	--물리모델 테이블 추가대상 조회...
	   SELECT RQST_NO
	      , 'I' AS IBS_STATUS
	      ,TRIM(PDM_TBL_LNM) AS PDM_TBL_LNM
	      ,TRIM(PDM_TBL_PNM) AS PDM_TBL_PNM
	      ,MAX(DESCRIPTION) AS  DESCRIPTION
	      ,MDL_LNM || '>' || UPP_SUBJ_LNM || '>' || SUBJ_LNM AS 	FULL_PATH
	      , MAX(UDP_ROW_BAK_FCY) AS BCK_FCY
	      , '' AS DEL_CRI
	      , '' AS DEL_MTD
	      , MAX(UDP_ROW_DEL_FCY_UNIT)
	      , MAX(UDP_ROW_CTD_FCY) AS CTD_FCY
	      , MAX(UDP_ROW_CTD_FCY_UNIT)
	      , 'CU' AS RQST_DCD
	      , MDL_LNM, UPP_SUBJ_LNM, SUBJ_LNM
	  FROM (
	        SELECT   DISTINCT #{reqmst.rqstNo} AS RQST_NO 
			      ,A.OBJECTNAME AS MDL_LNM
			      ,D.OBJECTNAME AS UPP_SUBJ_LNM
			      ,F.OBJECTNAME AS SUBJ_LNM
			      ,COALESCE(H.STRINGVALUE, I.STRINGVALUE) AS PDM_TBL_LNM
			      ,COALESCE(I.STRINGVALUE, H.STRINGVALUE) AS PDM_TBL_PNM
			      ,COALESCE(H.OBJECTID, I.OBJECTID) AS ENTITY_ID
			      ,MMART7.WISE_M7_INFO.GET_ENTITY_DEFINITION(H.OBJECTID) AS DESCRIPTION
			      ,MMART7.WISE_M7_INFO.get_udp_info(d.objectid, h.objectid, '$UDP_ROW_INIT_CNT_NM', 'Logical', 'Entity') AS UDP_ROW_INIT_CNT
			      ,MMART7.WISE_M7_INFO.get_udp_info(d.objectid, h.objectid, '$UDP_ROW_INIT_CNT_UNIT_NM', 'Logical', 'Entity') AS UDP_ROW_INIT_CNT_UNIT
			      ,MMART7.WISE_M7_INFO.get_udp_info(d.objectid, h.objectid, '$UDP_ROW_INC_CNT_NM', 'Logical', 'Entity') AS UDP_ROW_INC_CNT
			      ,MMART7.WISE_M7_INFO.get_udp_info(d.objectid, h.objectid, '$UDP_ROW_INC_CNT_UNIT_NM', 'Logical', 'Entity') AS UDP_ROW_INC_CNT_UNIT
			      ,MMART7.WISE_M7_INFO.get_udp_info(d.objectid, h.objectid, '$UDP_ROW_BAK_FCY_NM', 'Logical', 'Entity') AS UDP_ROW_BAK_FCY
			      ,MMART7.WISE_M7_INFO.get_udp_info(d.objectid, h.objectid, '$UDP_ROW_BAK_FCY_UNIT_NM', 'Logical', 'Entity') AS UDP_ROW_BAK_FCY_UNIT
			      ,MMART7.WISE_M7_INFO.get_udp_info(d.objectid, h.objectid, '$UDP_ROW_CTD_FCY_NM', 'Logical', 'Entity') AS UDP_ROW_CTD_FCY
			      ,MMART7.WISE_M7_INFO.get_udp_info(d.objectid, h.objectid, '$UDP_ROW_CTD_FCY_UNIT_NM', 'Logical', 'Entity') AS UDP_ROW_CTD_FCY_UNIT
			      ,MMART7.WISE_M7_INFO.get_udp_info(d.objectid, h.objectid, '$UDP_ROW_DEL_FCY_NM', 'Logical', 'Entity') AS UDP_ROW_DEL_FCY
			      ,MMART7.WISE_M7_INFO.get_udp_info(d.objectid, h.objectid, '$UDP_ROW_DEL_FCY_UNIT_NM', 'Logical', 'Entity') AS UDP_ROW_DEL_FCY_UNIT
			      ,MMART7.WISE_M7_INFO.get_udp_info(d.objectid, h.objectid, '$UDP_ROW_MAX_CNT_NM', 'Logical', 'Entity') AS UDP_ROW_MAX_CNT
			      ,MMART7.WISE_M7_INFO.get_udp_info(d.objectid, h.objectid, '$UDP_ROW_MAX_CNT_UNIT_NM', 'Logical', 'Entity') AS UDP_ROW_MAX_CNT_UNIT
			      ,MMART7.WISE_M7_INFO.get_udp_info(d.objectid, h.objectid, '$UDP_ROW_OCR_CNT_NM', 'Logical', 'Entity') AS UDP_ROW_OCR_CNT
			      ,MMART7.WISE_M7_INFO.get_udp_info(d.objectid, h.objectid, '$UDP_ROW_OCR_CNT_UNIT_NM', 'Logical', 'Entity') AS UDP_ROW_OCR_CNT_UNIT
			      ,MMART7.WISE_M7_INFO.get_udp_info(d.objectid, h.objectid, '$UDP_PARTITION_NM', 'Logical', 'Entity') AS UDP_PARTITION_YN
			      ,MMART7.WISE_M7_INFO.get_udp_info(d.objectid, h.objectid, '$UDP_ODS_TGT_GB_NM', 'Logical', 'Entity') AS UDP_ODS_TGT_GB
			      ,MMART7.WISE_M7_INFO.get_udp_info(d.objectid, h.objectid, '$UDP_SYNONYM_NM', 'Logical', 'Entity') AS UDP_SYNONYM_NM
			      ,MMART7.WISE_M7_INFO.get_udp_info(d.objectid, h.objectid, '$UDP_DB_NM', 'Logical', 'Entity') AS UDP_DB_NM
			      ,MMART7.WISE_M7_INFO.get_udp_info(d.objectid, h.objectid, '$UDP_OWNER_NM', 'Logical', 'Entity') AS UDP_OWNER_NM
			      ,MMART7.WISE_M7_INFO.get_udp_info(d.objectid, h.objectid, '$UDP_OF_DCR_PLY_DIT_NM', 'Logical', 'Entity') AS UDP_OF_DCR_PLY_DIT_NM
			      ,MMART7.WISE_M7_INFO.get_udp_info(d.objectid, h.objectid, '$UDP_CDM_SUBJ_NM', 'Logical', 'Entity') AS UDP_CDM_SUBJ_NM
			      ,MMART7.WISE_M7_INFO.get_udp_info(d.objectid, h.objectid, '$UDP_ENTITY_DIT_NM', 'Logical', 'Entity') AS UDP_ENTITY_DIT_NM
			      ,MMART7.WISE_M7_INFO.get_udp_info(d.objectid, h.objectid, '$UDP_EXTERNAL_TGT_NM', 'Logical', 'Entity') AS UDP_EXTERNAL_TGT_NM
			      ,MMART7.WISE_M7_INFO.get_udp_info(d.objectid, h.objectid, '$UDP_EXTERNAL_TBL_PTH_NM', 'Logical', 'Entity') AS UDP_EXTERNAL_TBL_PTH_NM
			      ,COALESCE(MMART7.WISE_M7_INFO.get_udp_info(d.objectid, h.objectid, 'ILM대상여부', 'Logical', 'Entity'),'N') AS ILM_TGT_YN     
			FROM  MMART7.M7LIBRARY A
			      , MMART7.M7OBJECT B
			      , MMART7.M7OBJECT C
			      , MMART7.M7LIBRARY D
			      , MMART7.M7OBJECT E
			      , MMART7.M7LIBRARY F
			      , MMART7.M7OBJECTPROPERTY G
			      , MMART7.M7OBJECTPROPERTY H
			      , MMART7.M7OBJECTPROPERTY I
			      , MMART7.M7OBJECTPROPERTY J
			WHERE A.OBJECTID = B.OBJECTID
			  AND B.CLASSID = 2
			  AND B.ENDVERSION IS NULL
			  AND A.OBJECTID = C.CONTAINERID
			  AND C.CLASSID = 1075838978
			  AND C.ENDVERSION IS NULL
			  AND C.OBJECTID = D.OBJECTID
			  AND D.OBJECTID = E.CONTAINERID
			  AND E.CLASSID = 1075839014
			  AND E.ENDVERSION IS NULL
			  AND E.OBJECTID = F.OBJECTID
			  AND F.OBJECTID = G.OBJECTID
			  AND G.PROPERTYID = 1075849443
			  AND G.VALUEOBJECTID = H.OBJECTID
			  AND H.PROPERTYID = 1073742126
			  AND H.OBJECTID = I.OBJECTID(+)
			  AND I.PROPERTYID(+) = 1075849176
			  AND H.OBJECTID = J.OBJECTID(+)
			  AND J.PROPERTYID(+) = 1073742125
			  AND F.OBJECTNAME != '&lt;Main Subject Area&gt;'
              AND COALESCE(H.STRINGVALUE, I.STRINGVALUE) IN 
			<foreach collection="list" item="item" open="(" separator="," close=")">
	  		#{item.pdmTblLnm}
	 		</foreach>
			ORDER BY PDM_TBL_LNM   ) A
--          WHERE NOT EXISTS
--          (
--          	 SELECT 1
--          	 FROM WAE_ERMART_R7_ENTY B
--            WHERE A.OF_DATAMODEL      = B.OF_DATAMODEL 
--              AND A.OF_PRIMARY_SUBJ   = B.OF_PRIMARY_SUBJ
--              AND A.OF_SUBJ           = B.OF_SUBJ
--              AND A.OBJ_ENM           = B.OBJ_ENM
--              AND A.REQUEST_ID        = B.REQUEST_ID
--          )
		  GROUP BY RQST_NO,  MDL_LNM, UPP_SUBJ_LNM, SUBJ_LNM, PDM_TBL_LNM, PDM_TBL_PNM	
  </select>
   
        <insert id="insertWaqRejected" parameterType="map" >
  	       INSERT INTO WAQ_PDM_TBL(
                     	RQST_NO
                       ,RQST_SNO
                       ,PDM_TBL_ID
                       ,PDM_TBL_PNM
                       ,PDM_TBL_LNM
                       ,BF_PDM_TBL_PNM
                       ,RQST_DCD
                       ,RVW_STS_CD
                       ,RVW_CONTS
                       ,VRF_CD
                       ,VRF_RMK
                       ,MDL_LNM
                       ,UPP_SUBJ_LNM
                       ,SUBJ_ID
                       ,SUBJ_LNM
                       ,STD_APL_YN
                       ,PART_TBL_YN
                       ,DW_TRG_TBL_YN
                       ,CRG_USER_ID
                       ,CRG_USER_NM
                       ,OBJ_DESCN
                       ,OBJ_VERS
                       ,REG_TYP_CD
                       ,FRS_RQST_DTM
                       ,FRS_RQST_USER_ID
                       ,RQST_DTM
                       ,RQST_USER_ID
                       ,APRV_DTM
                       ,APRV_USER_ID
                       ,CTD_FCY
                       ,DEL_CRI
                       ,DEL_MTD
                       ,BCK_FCY
                       ,FULL_PATH
                       ,USER_RQST_CNTN
  	       )
  	       SELECT 
  	                   #{reqmst.rqstNo,jdbcType=VARCHAR}
                       ,RQST_SNO
                       ,PDM_TBL_ID
                       ,PDM_TBL_PNM
                       ,PDM_TBL_LNM
                       ,BF_PDM_TBL_PNM
                       ,RQST_DCD
                       ,'0'
                       ,NULL
                       ,NULL
                       ,NULL
                       ,MDL_LNM
                       ,UPP_SUBJ_LNM
                       ,SUBJ_ID
                       ,SUBJ_LNM
                       ,STD_APL_YN
                       ,PART_TBL_YN
                       ,DW_TRG_TBL_YN
                       ,CRG_USER_ID
                       ,CRG_USER_NM
                       ,OBJ_DESCN
                       ,OBJ_VERS
                       ,REG_TYP_CD
                       ,FRS_RQST_DTM
                       ,FRS_RQST_USER_ID
                       ,RQST_DTM
                       ,RQST_USER_ID
                       ,NULL
                       ,NULL
                       ,CTD_FCY
                       ,DEL_CRI
                       ,DEL_MTD
                       ,BCK_FCY
                       ,FULL_PATH
                       ,USER_RQST_CNTN
  	          FROM WAQ_PDM_TBL A
  	          WHERE A.RQST_NO = #{oldRqstNo,jdbcType=VARCHAR}
  	          AND A.RVW_STS_CD = '2'
       </insert>
       
    <insert id="checkMstTblExists" parameterType="map">
  	<include refid="kr.wise.commons.rqstmst.service.WaqRqstVrfDtlsMapper.insertVrfDtlSql"/>
  	--검증쿼리 : 마스터 테이블 미존재 (PT011)
    AND EXISTS (
    		     SELECT 1 
    		     FROM WAM_MST_TBL_MAP Z
    		     WHERE Z.EXP_DTM = TO_DATE('99991231', 'YYYYMMDD')
    		     AND Z.REG_TYP_CD IN ('C', 'U') 
    		     AND A.PDM_TBL_PNM = Z.HIST_DDL_TBL_PNM
    		     AND Z.MST_DDL_TBL_PNM NOT IN (SELECT PDM_TBL_PNM FROM  WAQ_PDM_TBL Q WHERE Q.RQST_NO = #{rqstNo,jdbcType=VARCHAR})
               )
  </insert> 
   <insert id="checkHistTblExists" parameterType="map">
  	<include refid="kr.wise.commons.rqstmst.service.WaqRqstVrfDtlsMapper.insertVrfDtlSql"/>
  	--검증쿼리 : 이력 테이블 미존재 (PT012)
    AND EXISTS (
    		     SELECT 1 
    		     FROM WAM_MST_TBL_MAP Z
    		     WHERE Z.EXP_DTM = TO_DATE('99991231', 'YYYYMMDD')
    		     AND Z.REG_TYP_CD IN ('C', 'U') 
    		     AND A.PDM_TBL_PNM = Z.MST_DDL_TBL_PNM
    		     AND Z.HIST_DDL_TBL_PNM NOT IN (SELECT PDM_TBL_PNM FROM  WAQ_PDM_TBL Q WHERE Q.RQST_NO = #{rqstNo,jdbcType=VARCHAR})
               )
  </insert> 
  
   
  <select id="selectSubjDbmsTypCd" parameterType="string" resultType="HashMap" >
    <![CDATA[
   
    SELECT C.DBMS_TYP_CD, C.STND_ASRT 
	  FROM WAQ_PDM_TBL A	       
	       INNER JOIN WAA_SUBJ C
	          ON C.EXP_DTM = TO_DATE('9999-12-31','YYYY-MM-DD')
	         AND C.SUBJ_ID = A.SUBJ_ID
	 WHERE A.RQST_NO = #{rqstNo}
	 LIMIT 1         
     
	 ]]>  
  </select>
   
    <select id="checkEmptyRqst" parameterType="string" resultType="boolean" >
     SELECT CASE WHEN count(*) > 0 THEN 0 ELSE 1 END 
 	 FROM WAQ_PDM_TBL
	 WHERE RQST_NO = #{rqstNo}  
  </select>
  
  <update id="changeOwner" parameterType="kr.wise.meta.model.service.WaqPdmTbl" >
    UPDATE WAM_PDM_TBL 
	SET CRG_USER_ID = #{nxtUserId,jdbcType=VARCHAR}
	WHERE PDM_TBL_ID = #{pdmTblId,jdbcType=VARCHAR}
  </update>
  
  <insert id="checkprsvTerm" parameterType="map">
	  <include refid="kr.wise.commons.rqstmst.service.WaqRqstVrfDtlsMapper.insertVrfDtlSql"/>
	  --검증쿼리 : 범정부 연계 항목 중 미입력된 항목이 있을 경우 체크_보존기간(PT028)
	  AND A.RQST_DCD = 'CU'
	  AND EXISTS (
	  				SELECT 1 FROM WAQ_PDM_TBL D
	  				WHERE A.RQST_NO = D.RQST_NO
	  			   	  AND A.RQST_SNO = D.RQST_SNO
	  			   	  AND NULLIF(D.PRSV_TERM, '') IS NULL
	  )
  </insert>
  
  <insert id="checkdqDgnsYn" parameterType="map">
	  <include refid="kr.wise.commons.rqstmst.service.WaqRqstVrfDtlsMapper.insertVrfDtlSql"/>
	  --검증쿼리 : 범정부 연계 항목 중 미입력된 항목이 있을 경우 체크_품질진단여부(PT029)
	  AND A.RQST_DCD = 'CU'
	  AND EXISTS (
	  				SELECT 1 FROM WAQ_PDM_TBL D
	  				WHERE A.RQST_NO = D.RQST_NO
	  			   	  AND A.RQST_SNO = D.RQST_SNO
	  			   	  AND NULLIF(D.DQ_DGNS_YN, '') IS NULL
	  )
  </insert>
  
  <insert id="checknopenDtlRelBss" parameterType="map">
	  <include refid="kr.wise.commons.rqstmst.service.WaqRqstVrfDtlsMapper.insertVrfDtlSql"/>
	  --검증쿼리 : 범정부 연계 항목 중 미입력된 항목이 있을 경우 체크_상세관련근거(PT030)
	  AND A.RQST_DCD = 'CU'
	  AND EXISTS (
	  				SELECT 1 FROM WAQ_PDM_TBL D
	  				WHERE A.RQST_NO = D.RQST_NO
	  			   	  AND A.RQST_SNO = D.RQST_SNO
	  			   	  AND NULLIF(D.NOPEN_DTL_REL_BSS, '') IS NULL
	  )
  </insert>
  
  <insert id="checkoccrCyl" parameterType="map">
	  <include refid="kr.wise.commons.rqstmst.service.WaqRqstVrfDtlsMapper.insertVrfDtlSql"/>
	  --검증쿼리 : 범정부 연계 항목 중 미입력된 항목이 있을 경우 체크_발생주기(PT032)
	  AND A.RQST_DCD = 'CU'
	  AND EXISTS (
	  				SELECT 1 FROM WAQ_PDM_TBL D
	  				WHERE A.RQST_NO = D.RQST_NO
	  			   	  AND A.RQST_SNO = D.RQST_SNO
	  			   	  AND NULLIF(D.OCCR_CYL, '') IS NULL
	  )
  </insert>
  
  <insert id="checkopenDataLst" parameterType="map">
	  <include refid="kr.wise.commons.rqstmst.service.WaqRqstVrfDtlsMapper.insertVrfDtlSql"/>
	  --검증쿼리 : 범정부 연계 항목 중 미입력된 항목이 있을 경우 체크_개방데이터목록(PT033)
	  AND A.RQST_DCD = 'CU'
	  AND EXISTS (
	  				SELECT 1 FROM WAQ_PDM_TBL D
	  				WHERE A.RQST_NO = D.RQST_NO
	  			   	  AND A.RQST_SNO = D.RQST_SNO
	  			   	  AND NULLIF(D.OPEN_DATA_LST, '') IS NULL
	  )
  </insert>
  
  <insert id="checkopenRsnCd" parameterType="map">
	  <include refid="kr.wise.commons.rqstmst.service.WaqRqstVrfDtlsMapper.insertVrfDtlSql"/>
	  --검증쿼리 : 범정부 연계 항목 중 미입력된 항목이 있을 경우 체크_공개/비공개여부(PT034)
	  AND A.RQST_DCD = 'CU'
	  AND EXISTS (
	  				SELECT 1 FROM WAQ_PDM_TBL D
	  				WHERE A.RQST_NO = D.RQST_NO
	  			   	  AND A.RQST_SNO = D.RQST_SNO
	  			   	  AND NULLIF(D.OPEN_RSN_CD, '') IS NULL
	  )
  </insert>
  
  <insert id="checktblTypNm" parameterType="map">
	  <include refid="kr.wise.commons.rqstmst.service.WaqRqstVrfDtlsMapper.insertVrfDtlSql"/>
	  --검증쿼리 : 범정부 연계 항목 중 미입력된 항목이 있을 경우 체크_테이블유형(PT035)
	  AND A.RQST_DCD = 'CU'
	  AND EXISTS (
	  				SELECT 1 FROM WAQ_PDM_TBL D
	  				WHERE A.RQST_NO = D.RQST_NO
	  			   	  AND A.RQST_SNO = D.RQST_SNO
	  			   	  AND NULLIF(D.TBL_TYP_NM, '') IS NULL
	  )
  </insert>
  
  <insert id="checktblVol" parameterType="map">
	  <include refid="kr.wise.commons.rqstmst.service.WaqRqstVrfDtlsMapper.insertVrfDtlSql"/>
	  --검증쿼리 : 범정부 연계 항목 중 미입력된 항목이 있을 경우 체크_테이블볼륨(PT036)
	  AND A.RQST_DCD = 'CU'
	  AND EXISTS (
	  				SELECT 1 FROM WAQ_PDM_TBL D
	  				WHERE A.RQST_NO = D.RQST_NO
	  			   	  AND A.RQST_SNO = D.RQST_SNO
	  			   	  AND NULLIF(D.TBL_VOL, '') IS NULL
	  )
  </insert>
  
  <insert id="checknopenRsn" parameterType="map">
	  <include refid="kr.wise.commons.rqstmst.service.WaqRqstVrfDtlsMapper.insertVrfDtlSql"/>
	  --검증쿼리 : 범정부 연계 항목 중 공개/비공개 여부가 비공개인 경우 비공개 사유를 입력해야 한다(PT037)
	  AND A.RQST_DCD = 'CU'
	  AND EXISTS (
	  				SELECT 1 FROM WAQ_PDM_TBL D
	  				WHERE A.RQST_NO = D.RQST_NO
	  			   	  AND A.RQST_SNO = D.RQST_SNO
	  			   	  AND D.OPEN_RSN_CD = '02'
	  			   	  AND NULLIF(D.NOPEN_RSN, '') IS NULL
	  )
  </insert>
</mapper>



