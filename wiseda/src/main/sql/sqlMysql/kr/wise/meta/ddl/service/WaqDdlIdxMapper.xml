<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="kr.wise.meta.ddl.service.WaqDdlIdxMapper" >
  <resultMap id="BaseResultMap" type="kr.wise.meta.ddl.service.WaqDdlIdx" extends="kr.wise.commons.cmm.service.CommonMapper.BaseResultMap">
<!--     <id column="RQST_NO" property="rqstNo" jdbcType="VARCHAR" /> -->
<!--     <id column="RQST_SNO" property="rqstSno" jdbcType="DECIMAL" /> -->
    <result column="DDL_IDX_ID" property="ddlIdxId" jdbcType="VARCHAR" />
    <result column="DDL_IDX_PNM" property="ddlIdxPnm" jdbcType="VARCHAR" />
    <result column="DDL_IDX_LNM" property="ddlIdxLnm" jdbcType="VARCHAR" />
<!--     <result column="RQST_DCD" property="rqstDcd" jdbcType="VARCHAR" /> -->
<!--     <result column="RVW_STS_CD" property="rvwStsCd" jdbcType="VARCHAR" /> -->
<!--     <result column="RVW_CONTS" property="rvwConts" jdbcType="VARCHAR" /> -->
<!--     <result column="VRF_CD" property="vrfCd" jdbcType="VARCHAR" /> -->
<!--     <result column="VRF_RMK" property="vrfRmk" jdbcType="VARCHAR" /> -->
    <result column="DB_CONN_TRG_ID" property="dbConnTrgId" jdbcType="VARCHAR" />
    <result column="DB_CONN_TRG_PNM" property="dbConnTrgPnm" jdbcType="VARCHAR" />
    <result column="DB_SCH_ID" property="dbSchId" jdbcType="VARCHAR" />
    <result column="DB_SCH_PNM" property="dbSchPnm" jdbcType="VARCHAR" />
    <result column="DDL_TBL_ID" property="ddlTblId" jdbcType="VARCHAR" />
    <result column="DDL_TBL_PNM" property="ddlTblPnm" jdbcType="VARCHAR" />
    <result column="DDL_TBL_LNM" property="ddlTblLnm" jdbcType="VARCHAR" />
    <result column="IDX_SPAC_ID" property="idxSpacId" jdbcType="VARCHAR" />
    <result column="IDX_SPAC_PNM" property="idxSpacPnm" jdbcType="VARCHAR" />
    <result column="PK_IDX_YN" property="pkIdxYn" jdbcType="VARCHAR" />
    <result column="UK_IDX_YN" property="ukIdxYn" jdbcType="VARCHAR" />
    <result column="IDX_TYP_CD" property="idxTypCd" jdbcType="VARCHAR" />
    
    <result column="DDL_TRG_DCD"     property="ddlTrgDcd"    jdbcType="VARCHAR" />
    
    <result column="OBJ_DCD"             property="objDcd"          jdbcType="VARCHAR" />
    <result column="SRC_DDL_TRG_DCD"     property="srcDdlTrgDcd"    jdbcType="VARCHAR" />
    <result column="SRC_DB_CONN_TRG_PNM" property="srcDbConnTrgPnm" jdbcType="VARCHAR" />
    <result column="SRC_DB_SCH_PNM"      property="srcDbSchPnm"     jdbcType="VARCHAR" />
    <result column="SRC_DB_SCH_ID"       property="srcDbSchId"      jdbcType="VARCHAR" />
   
    <result column="TGT_DDL_TRG_DCD"      property="tgtDdlTrgDcd"    jdbcType="VARCHAR" />
    <result column="TGT_DB_CONN_TRG_PNM"  property="tgtDbConnTrgPnm" jdbcType="VARCHAR" />
    <result column="TGT_DB_SCH_PNM"       property="tgtDbSchPnm"     jdbcType="VARCHAR" />
    <result column="TGT_DB_SCH_ID"        property="tgtDbSchId"      jdbcType="VARCHAR" />
    
    <result column="DDL_IDX_COL_ASM"      property="ddlIdxColAsm"    jdbcType="VARCHAR" />
    
    <result column="OBJ_DESCN" property="objDescn" jdbcType="VARCHAR" />
<!--     <result column="OBJ_VERS" property="objVers" jdbcType="DECIMAL" /> -->
<!--     <result column="REG_TYP_CD" property="regTypCd" jdbcType="VARCHAR" /> -->
<!--     <result column="FRS_RQST_DTM" property="frsRqstDtm" jdbcType="TIMESTAMP" /> -->
<!--     <result column="FRS_RQST_USER_ID" property="frsRqstUserId" jdbcType="VARCHAR" /> -->
<!--     <result column="RQST_DTM" property="rqstDtm" jdbcType="TIMESTAMP" /> -->
<!--     <result column="RQST_USER_ID" property="rqstUserId" jdbcType="VARCHAR" /> -->
<!--     <result column="APRV_DTM" property="aprvDtm" jdbcType="TIMESTAMP" /> -->
<!--     <result column="APRV_USER_ID" property="aprvUserId" jdbcType="VARCHAR" /> -->
  </resultMap>
  <resultMap id="ResultMapWithBLOBs" type="kr.wise.meta.ddl.service.WaqDdlIdx" extends="BaseResultMap" >
    <result column="SCRT_INFO" property="scrtInfo" jdbcType="CLOB" />
  </resultMap>
  <sql id="Base_Column_List" >
    RQST_NO, RQST_SNO, RQST_DTL_SNO, DDL_IDX_ID, DDL_IDX_PNM, DDL_IDX_LNM, RQST_DCD, RVW_STS_CD, RVW_CONTS, 
    VRF_CD, VRF_RMK, DB_CONN_TRG_ID, DB_CONN_TRG_PNM, DB_SCH_ID, DB_SCH_PNM, DDL_TBL_ID, DDL_TBL_PNM, 
    IDX_SPAC_ID, IDX_SPAC_PNM, PK_IDX_YN, UK_IDX_YN, IDX_TYP_CD, OBJ_DESCN, OBJ_VERS, 
    REG_TYP_CD, FRS_RQST_DTM, FRS_RQST_USER_ID, RQST_DTM, RQST_USER_ID, APRV_DTM, APRV_USER_ID,
    DDL_IDX_COL_ASM
  </sql>
  
  <sql id="Blob_Column_List" >
    SCRT_INFO
  </sql>
  
  <sql id="waq_Column_List" >
    A.RQST_NO, A.RQST_SNO, A.RQST_DTL_SNO, A.DDL_IDX_ID, A.DDL_IDX_PNM, A.DDL_IDX_LNM, A.RQST_DCD, A.RVW_CONTS, 
    A.VRF_CD, A.VRF_RMK, A.DB_CONN_TRG_ID, A.DB_CONN_TRG_PNM, A.DB_SCH_ID, A.DB_SCH_PNM, A.DDL_TBL_ID, A.DDL_TBL_PNM, 
    A.IDX_SPAC_ID, A.IDX_SPAC_PNM, A.PK_IDX_YN, A.UK_IDX_YN, A.IDX_TYP_CD, A.OBJ_DESCN, A.OBJ_VERS, 
    A.REG_TYP_CD, A.FRS_RQST_DTM, A.FRS_RQST_USER_ID, A.RQST_DTM, A.RQST_USER_ID, A.APRV_DTM, A.APRV_USER_ID,
    A.DDL_IDX_COL_ASM
  </sql>
  
  
  <select id="selectByPrimaryKey" resultMap="ResultMapWithBLOBs" parameterType="map" >
  
    select /* WaqDdlIdxMapper.selectByPrimaryKey */
    <include refid="Base_Column_List" />
    ,
    <include refid="Blob_Column_List" />
    from WAQ_DDL_IDX
    where RQST_NO = #{rqstNo,jdbcType=VARCHAR}
      and RQST_SNO = #{rqstSno,jdbcType=DECIMAL}
      
  </select>
  
  <delete id="deleteByPrimaryKey" parameterType="map" >
  
    delete /* WaqDdlIdxMapper.deleteByPrimaryKey */
    from WAQ_DDL_IDX
    where RQST_NO = #{rqstNo,jdbcType=VARCHAR}
      and RQST_SNO = #{rqstSno,jdbcType=DECIMAL}
      
  </delete>
  
  <delete id="deleteByRqstNo" parameterType="map" >
  
    delete /* WaqDdlIdxMapper.deleteByRqstNo */
    from WAQ_DDL_IDX
    where RQST_NO = #{rqstNo,jdbcType=VARCHAR}
    
  </delete>
  
  <delete id="deleteByRqstSno" parameterType="map">
  
	DELETE /* WaqDdlIdxMapper.deleteByRqstSno */
	FROM WAQ_DDL_IDX
	WHERE RQST_NO = #{rqstNo,jdbcType=VARCHAR}
	  AND RQST_SNO = #{rqstSno,jdbcType=DECIMAL}
		
  </delete>
  
  <insert id="insert" parameterType="kr.wise.meta.ddl.service.WaqDdlIdx" >
  
    insert /* WaqDdlIdxMapper.insert */
    	into WAQ_DDL_IDX (RQST_NO, RQST_SNO, DDL_IDX_ID, 
      DDL_IDX_PNM, DDL_IDX_LNM, RQST_DCD, 
      RVW_STS_CD, RVW_CONTS, VRF_CD, 
      VRF_RMK, DB_CONN_TRG_ID, DB_CONN_TRG_PNM, DB_SCH_ID, 
      DB_SCH_PNM, DDL_TBL_ID, DDL_TBL_PNM, 
      IDX_SPAC_ID, IDX_SPAC_PNM, PK_IDX_YN, 
      UK_IDX_YN, IDX_TYP_CD, OBJ_DESCN, 
      OBJ_VERS, REG_TYP_CD, FRS_RQST_DTM, 
      FRS_RQST_USER_ID, RQST_DTM, RQST_USER_ID, 
      APRV_DTM, APRV_USER_ID, SCRT_INFO
      )
    values (#{rqstNo,jdbcType=VARCHAR}, #{rqstSno,jdbcType=DECIMAL}, #{ddlIdxId,jdbcType=VARCHAR}, 
      #{ddlIdxPnm,jdbcType=VARCHAR}, #{ddlIdxLnm,jdbcType=VARCHAR}, #{rqstDcd,jdbcType=VARCHAR}, 
      #{rvwStsCd,jdbcType=VARCHAR}, #{rvwConts,jdbcType=VARCHAR}, #{vrfCd,jdbcType=VARCHAR}, 
      #{vrfRmk,jdbcType=VARCHAR}, #{dbConnTrgId,jdbcType=VARCHAR},#{dbConnTrgPnm,jdbcType=VARCHAR}, #{dbSchId,jdbcType=VARCHAR}, 
      #{dbSchPnm,jdbcType=VARCHAR}, #{ddlTblId,jdbcType=VARCHAR}, #{ddlTblPnm,jdbcType=VARCHAR}, 
      #{idxSpacId,jdbcType=VARCHAR}, #{idxSpacPnm,jdbcType=VARCHAR}, #{pkIdxYn,jdbcType=VARCHAR}, 
      #{ukIdxYn,jdbcType=VARCHAR}, #{idxTypCd,jdbcType=VARCHAR}, #{objDescn,jdbcType=VARCHAR}, 
      #{objVers,jdbcType=DECIMAL}, #{regTypCd,jdbcType=VARCHAR}, #{frsRqstDtm,jdbcType=TIMESTAMP}, 
      #{frsRqstUserId,jdbcType=VARCHAR}, #{rqstDtm,jdbcType=TIMESTAMP}, #{rqstUserId,jdbcType=VARCHAR}, 
      #{aprvDtm,jdbcType=TIMESTAMP}, #{aprvUserId,jdbcType=VARCHAR}, #{scrtInfo,jdbcType=CLOB}
      )
      
  </insert>
  
  <select id="selectExistsRqstSno" resultMap="BaseResultMap" parameterType="kr.wise.meta.ddl.service.WaqDdlIdx" >
  
  	 SELECT /* WaqDdlIdxMapper.selectExistsRqstSno */
  	 		MAX(RQST_SNO) AS RQST_SNO
  	   FROM WAQ_DDL_IDX 
  	  WHERE RQST_NO     = #{rqstNo, jdbcType=VARCHAR}
  	    AND DDL_TBL_PNM = #{ddlTblPnm, jdbcType=VARCHAR}
  	  GROUP BY DDL_TBL_PNM 
  </select>
  
  <select id="selectMaxRqstSno" resultMap="BaseResultMap" parameterType="kr.wise.meta.ddl.service.WaqDdlIdx" >
  
  	 SELECT /* WaqDdlIdxMapper.selectMaxRqstSno */
  	 		IFNULL(MAX(RQST_SNO),0) + 1  AS RQST_SNO
  	   FROM WAQ_DDL_IDX 
  	  WHERE RQST_NO     = #{rqstNo, jdbcType=VARCHAR}

  </select>
  
  <insert id="insertSelective" parameterType="kr.wise.meta.ddl.service.WaqDdlIdx" >
  
  	<selectKey keyProperty="rqstDtlSno" resultType="int" statementType="PREPARED" order="BEFORE">
		SELECT IFNULL(MAX(RQST_DTL_SNO), 0) + 1 
		  FROM WAQ_DDL_IDX 
		 WHERE RQST_NO  = #{rqstNo, jdbcType=VARCHAR}
		   AND RQST_SNO = #{rqstSno, jdbcType=DECIMAL}
  	</selectKey>
    insert 	/* WaqDdlIdxMapper.insertSelective */
    		into WAQ_DDL_IDX
    <trim prefix="(" suffix=")" suffixOverrides="," >
        RQST_NO,
        RQST_SNO,
        RQST_DTL_SNO,
      <if test="ddlIdxId != null" >
        DDL_IDX_ID,
      </if>
      <if test="ddlIdxPnm != null" >
        DDL_IDX_PNM,
      </if>
      <if test="ddlIdxPnm != null" >
        DDL_IDX_LNM,
      </if>
      <if test="rqstDcd != null" >
        RQST_DCD,
      </if>
      <if test="rvwStsCd != null" >
        RVW_STS_CD,
      </if>
      <if test="rvwConts != null" >
        RVW_CONTS,
      </if>
      <if test="vrfCd != null" >
        VRF_CD,
      </if>
      <if test="vrfRmk != null" >
        VRF_RMK,
      </if>
      <if test="dbConnTrgId != null" >
        DB_CONN_TRG_ID,
      </if>
      <if test="dbConnTrgPnm != null" >
        DB_CONN_TRG_PNM,
      </if>
      <if test="dbSchId != null" >
        DB_SCH_ID,
      </if>
      <if test="dbSchPnm != null" >
        DB_SCH_PNM,
      </if>
      <if test="ddlTblId != null" >
        DDL_TBL_ID,
      </if>
      <if test="ddlTblPnm != null" >
        DDL_TBL_PNM,
      </if>
      <if test="idxSpacId != null" >
        IDX_SPAC_ID,
      </if>
      <if test="idxSpacPnm != null" >
        IDX_SPAC_PNM,
      </if>
      <if test="pkIdxYn != null" >
        PK_IDX_YN,
      </if>
      <if test="ukIdxYn != null" >
        UK_IDX_YN,
      </if>
      <if test="idxTypCd != null" >
        IDX_TYP_CD,
      </if>
      <if test="objDescn != null" >
        OBJ_DESCN,
      </if>
        OBJ_VERS,
      <if test="regTypCd != null" >
        REG_TYP_CD,
      </if>
        FRS_RQST_DTM,
        FRS_RQST_USER_ID,
        RQST_DTM,
      <if test="rqstUserId != null" >
        RQST_USER_ID,
      </if>
      <if test="aprvDtm != null" >
        APRV_DTM,
      </if>
      <if test="aprvUserId != null" >
        APRV_USER_ID,
      </if>
      <if test="scrtInfo != null" >
        SCRT_INFO,
      </if>
      <if test="ddlIdxColAsm != null" >
        DDL_IDX_COL_ASM,
      </if>
    </trim>
    <trim prefix="values (" suffix=")" suffixOverrides="," >
        #{rqstNo,jdbcType=VARCHAR},
        #{rqstSno,jdbcType=DECIMAL},
         #{rqstDtlSno,jdbcType=DECIMAL},
      <if test="ddlIdxId != null" >
        #{ddlIdxId,jdbcType=VARCHAR},
      </if>
      <if test="ddlIdxPnm != null" >
        TRIM(UPPER(#{ddlIdxPnm,jdbcType=VARCHAR})),
      </if>
      <if test="ddlIdxPnm != null" >
        #{ddlIdxPnm,jdbcType=VARCHAR},
      </if>
      <if test="rqstDcd != null" >
        #{rqstDcd,jdbcType=VARCHAR},
      </if>
      <if test="rvwStsCd != null" >
        #{rvwStsCd,jdbcType=VARCHAR},
      </if>
      <if test="rvwConts != null" >
        #{rvwConts,jdbcType=VARCHAR},
      </if>
      <if test="vrfCd != null" >
        #{vrfCd,jdbcType=VARCHAR},
      </if>
      <if test="vrfRmk != null" >
        #{vrfRmk,jdbcType=VARCHAR},
      </if>
      <if test="dbConnTrgId != null" >
        #{dbConnTrgId,jdbcType=VARCHAR},
      </if>
      <if test="dbConnTrgPnm != null" >
        #{dbConnTrgPnm,jdbcType=VARCHAR},
      </if>
      <if test="dbSchId != null" >
        #{dbSchId,jdbcType=VARCHAR},
      </if>
      <if test="dbSchPnm != null" >
        #{dbSchPnm,jdbcType=VARCHAR},
      </if>
      <if test="ddlTblId != null" >
        #{ddlTblId,jdbcType=VARCHAR},
      </if>
      <if test="ddlTblPnm != null" >
        #{ddlTblPnm,jdbcType=VARCHAR},
      </if>
      <if test="idxSpacId != null" >
        #{idxSpacId,jdbcType=VARCHAR},
      </if>
      <if test="idxSpacPnm != null" >
        #{idxSpacPnm,jdbcType=VARCHAR},
      </if>
      <if test="pkIdxYn != null" >
        #{pkIdxYn,jdbcType=VARCHAR},
      </if>
      <if test="ukIdxYn != null" >
        #{ukIdxYn,jdbcType=VARCHAR},
      </if>
      <if test="idxTypCd != null" >
        #{idxTypCd,jdbcType=VARCHAR},
      </if>
      <if test="objDescn != null" >
        #{objDescn,jdbcType=VARCHAR},
      </if>
        1 ,
      <if test="regTypCd != null" >
        #{regTypCd,jdbcType=VARCHAR},
      </if>
        NOW(),
        #{frsRqstUserId,jdbcType=VARCHAR},
        NOW(),
      <if test="rqstUserId != null" >
        #{rqstUserId,jdbcType=VARCHAR},
      </if>
      <if test="aprvDtm != null" >
        #{aprvDtm,jdbcType=TIMESTAMP},
      </if>
      <if test="aprvUserId != null" >
        #{aprvUserId,jdbcType=VARCHAR},
      </if>
      <if test="scrtInfo != null" >
        #{scrtInfo,jdbcType=CLOB},
      </if>
      <if test="ddlIdxColAsm != null" >
        #{ddlIdxColAsm,jdbcType=VARCHAR},
      </if>
    </trim>
    
  </insert>
  
  <update id="updateByPrimaryKeySelective" parameterType="kr.wise.meta.ddl.service.WaqDdlIdx" >
  
    update 	/* WaqDdlIdxMapper.updateByPrimaryKeySelective */
    		WAQ_DDL_IDX
    <set >
      <if test="ddlIdxId != null" >
        DDL_IDX_ID = #{ddlIdxId,jdbcType=VARCHAR},
      </if>
      <if test="ddlIdxPnm != null" >
        DDL_IDX_PNM = TRIM(UPPER(#{ddlIdxPnm,jdbcType=VARCHAR})),
      </if>
      <if test="ddlIdxPnm != null" >
        DDL_IDX_LNM = #{ddlIdxPnm,jdbcType=VARCHAR},
      </if>
      <if test="rqstDcd != null" >
        RQST_DCD = #{rqstDcd,jdbcType=VARCHAR},
      </if>
      <if test="rvwStsCd != null" >
        RVW_STS_CD = #{rvwStsCd,jdbcType=VARCHAR},
      </if>
      <if test="rvwConts != null" >
        RVW_CONTS = #{rvwConts,jdbcType=VARCHAR},
      </if>
      <if test="vrfCd != null" >
        VRF_CD = #{vrfCd,jdbcType=VARCHAR},
      </if>
      <if test="vrfRmk != null" >
        VRF_RMK = #{vrfRmk,jdbcType=VARCHAR},
      </if>
      <if test="dbConnTrgId != null" >
        DB_CONN_TRG_ID = #{dbConnTrgId,jdbcType=VARCHAR},
      </if>
      <if test="dbConnTrgPnm != null" >
        DB_CONN_TRG_PNM = #{dbConnTrgPnm,jdbcType=VARCHAR},
      </if>
      <if test="dbSchId != null" >
        DB_SCH_ID = #{dbSchId,jdbcType=VARCHAR},
      </if>
      <if test="dbSchPnm != null" >
        DB_SCH_PNM = #{dbSchPnm,jdbcType=VARCHAR},
      </if>
      <if test="ddlTblId != null" >
        DDL_TBL_ID = #{ddlTblId,jdbcType=VARCHAR},
      </if>
      <if test="ddlTblPnm != null" >
        DDL_TBL_PNM = #{ddlTblPnm,jdbcType=VARCHAR},
      </if>
      <if test="idxSpacId != null" >
        IDX_SPAC_ID = #{idxSpacId,jdbcType=VARCHAR},
      </if>
      <if test="idxSpacPnm != null" >
        IDX_SPAC_PNM = #{idxSpacPnm,jdbcType=VARCHAR},
      </if>
      <if test="pkIdxYn != null" >
        PK_IDX_YN = #{pkIdxYn,jdbcType=VARCHAR},
      </if>
      <if test="ukIdxYn != null" >
        UK_IDX_YN = #{ukIdxYn,jdbcType=VARCHAR},
      </if>
      <if test="idxTypCd != null" >
        IDX_TYP_CD = #{idxTypCd,jdbcType=VARCHAR},
      </if>
      <if test="objDescn != null" >
        OBJ_DESCN = #{objDescn,jdbcType=VARCHAR},
      </if>
      <if test="objVers != null" >
        OBJ_VERS = #{objVers,jdbcType=DECIMAL},
      </if>
      <if test="regTypCd != null" >
        REG_TYP_CD = #{regTypCd,jdbcType=VARCHAR},
      </if>
      <if test="frsRqstDtm != null" >
        FRS_RQST_DTM = #{frsRqstDtm,jdbcType=TIMESTAMP},
      </if>
      <if test="frsRqstUserId != null" >
        FRS_RQST_USER_ID = #{frsRqstUserId,jdbcType=VARCHAR},
      </if>
      <if test="rqstDtm != null" >
        RQST_DTM = #{rqstDtm,jdbcType=TIMESTAMP},
      </if>
      <if test="rqstUserId != null" >
        RQST_USER_ID = #{rqstUserId,jdbcType=VARCHAR},
      </if>
      <if test="aprvDtm != null" >
        APRV_DTM = #{aprvDtm,jdbcType=TIMESTAMP},
      </if>
      <if test="aprvUserId != null" >
        APRV_USER_ID = #{aprvUserId,jdbcType=VARCHAR},
      </if>
      <if test="scrtInfo != null" >
        SCRT_INFO = #{scrtInfo,jdbcType=CLOB},
      </if>
      <if test="ddlIdxColAsm != null" >
        DDL_IDX_COL_ASM = #{ddlIdxColAsm,jdbcType=VARCHAR},
      </if>
    </set>
    where RQST_NO = #{rqstNo,jdbcType=VARCHAR}
      and RQST_SNO = #{rqstSno,jdbcType=DECIMAL}
      and RQST_DTL_SNO = #{rqstDtlSno,jdbcType=DECIMAL}
      
  </update>
  
  <update id="updateByPrimaryKeyWithBLOBs" parameterType="kr.wise.meta.ddl.service.WaqDdlIdx" >
  
    update 	/* WaqDdlIdxMapper.updateByPrimaryKeyWithBLOBs */
    		WAQ_DDL_IDX
    set DDL_IDX_ID = #{ddlIdxId,jdbcType=VARCHAR},
      DDL_IDX_PNM = #{ddlIdxPnm,jdbcType=VARCHAR},
      DDL_IDX_LNM = #{ddlIdxLnm,jdbcType=VARCHAR},
      RQST_DCD = #{rqstDcd,jdbcType=VARCHAR},
      RVW_STS_CD = #{rvwStsCd,jdbcType=VARCHAR},
      RVW_CONTS = #{rvwConts,jdbcType=VARCHAR},
      VRF_CD = #{vrfCd,jdbcType=VARCHAR},
      VRF_RMK = #{vrfRmk,jdbcType=VARCHAR},
      DB_CONN_TRG_ID = #{dbConnTrgId,jdbcType=VARCHAR},
      DB_CONN_TRG_PNM = #{dbConnTrgPnm,jdbcType=VARCHAR},
      DB_SCH_ID = #{dbSchId,jdbcType=VARCHAR},
      DB_SCH_PNM = #{dbSchPnm,jdbcType=VARCHAR},
      DDL_TBL_ID = #{ddlTblId,jdbcType=VARCHAR},
      DDL_TBL_PNM = #{ddlTblPnm,jdbcType=VARCHAR},
      IDX_SPAC_ID = #{idxSpacId,jdbcType=VARCHAR},
      IDX_SPAC_PNM = #{idxSpacPnm,jdbcType=VARCHAR},
      PK_IDX_YN = #{pkIdxYn,jdbcType=VARCHAR},
      UK_IDX_YN = #{ukIdxYn,jdbcType=VARCHAR},
      IDX_TYP_CD = #{idxTypCd,jdbcType=VARCHAR},
      OBJ_DESCN = #{objDescn,jdbcType=VARCHAR},
      OBJ_VERS = #{objVers,jdbcType=DECIMAL},
      REG_TYP_CD = #{regTypCd,jdbcType=VARCHAR},
      FRS_RQST_DTM = #{frsRqstDtm,jdbcType=TIMESTAMP},
      FRS_RQST_USER_ID = #{frsRqstUserId,jdbcType=VARCHAR},
      RQST_DTM = #{rqstDtm,jdbcType=TIMESTAMP},
      RQST_USER_ID = #{rqstUserId,jdbcType=VARCHAR},
      APRV_DTM = #{aprvDtm,jdbcType=TIMESTAMP},
      APRV_USER_ID = #{aprvUserId,jdbcType=VARCHAR},
      SCRT_INFO = #{scrtInfo,jdbcType=CLOB}
    where RQST_NO = #{rqstNo,jdbcType=VARCHAR}
      and RQST_SNO = #{rqstSno,jdbcType=DECIMAL}
  </update>
  
  <update id="updateByPrimaryKey" parameterType="kr.wise.meta.ddl.service.WaqDdlIdx" >
  
    update 	/* WaqDdlIdxMapper.updateByPrimaryKey */
    		WAQ_DDL_IDX
    set DDL_IDX_ID = #{ddlIdxId,jdbcType=VARCHAR},
      DDL_IDX_PNM = #{ddlIdxPnm,jdbcType=VARCHAR},
      DDL_IDX_LNM = #{ddlIdxLnm,jdbcType=VARCHAR},
      RQST_DCD = #{rqstDcd,jdbcType=VARCHAR},
      RVW_STS_CD = #{rvwStsCd,jdbcType=VARCHAR},
      RVW_CONTS = #{rvwConts,jdbcType=VARCHAR},
      VRF_CD = #{vrfCd,jdbcType=VARCHAR},
      VRF_RMK = #{vrfRmk,jdbcType=VARCHAR},
      DB_CONN_TRG_ID = #{dbConnTrgId,jdbcType=VARCHAR},
      DB_CONN_TRG_PNM = #{dbConnTrgPnm,jdbcType=VARCHAR},
      DB_SCH_ID = #{dbSchId,jdbcType=VARCHAR},
      DB_SCH_PNM = #{dbSchPnm,jdbcType=VARCHAR},
      DDL_TBL_ID = #{ddlTblId,jdbcType=VARCHAR},
      DDL_TBL_PNM = #{ddlTblPnm,jdbcType=VARCHAR},
      IDX_SPAC_ID = #{idxSpacId,jdbcType=VARCHAR},
      IDX_SPAC_PNM = #{idxSpacPnm,jdbcType=VARCHAR},
      PK_IDX_YN = #{pkIdxYn,jdbcType=VARCHAR},
      UK_IDX_YN = #{ukIdxYn,jdbcType=VARCHAR},
      IDX_TYP_CD = #{idxTypCd,jdbcType=VARCHAR},
      OBJ_DESCN = #{objDescn,jdbcType=VARCHAR},
      OBJ_VERS = #{objVers,jdbcType=DECIMAL},
      REG_TYP_CD = #{regTypCd,jdbcType=VARCHAR},
      FRS_RQST_DTM = #{frsRqstDtm,jdbcType=TIMESTAMP},
      FRS_RQST_USER_ID = #{frsRqstUserId,jdbcType=VARCHAR},
      RQST_DTM = #{rqstDtm,jdbcType=TIMESTAMP},
      RQST_USER_ID = #{rqstUserId,jdbcType=VARCHAR},
      APRV_DTM = #{aprvDtm,jdbcType=TIMESTAMP},
      APRV_USER_ID = #{aprvUserId,jdbcType=VARCHAR}
    where RQST_NO = #{rqstNo,jdbcType=VARCHAR}
      and RQST_SNO = #{rqstSno,jdbcType=DECIMAL}
      
  </update>
  
  	<!-- DDL 인덱스 요청서 리스트 조회 -->
    <select id="selectDdlIdxListbyMst" parameterType="kr.wise.commons.rqstmst.service.WaqMstr" resultMap="BaseResultMap">
    
  	SELECT /* WaqDdlIdxMapper.selectDdlIdxListbyMst */
	       <include refid="waq_Column_List"/>
	       <choose>
	       		<when test='rqstStepCd == "Q" '>
			     	, CASE WHEN A.RVW_STS_CD = '2' THEN '2' ELSE '0' END AS RVW_STS_CD
			    </when>
			    <otherwise>
			    	, A.RVW_STS_CD
			    </otherwise>
	       </choose>	     
	     , CASE WHEN A.VRF_CD = '2' THEN '#FF0000' ELSE CASE WHEN A.VRF_CD = '5' THEN '#0000FF'  END END AS FontColor 
	     , GET_USER_NM(A.RQST_USER_ID) AS RQST_USER_NM
	     , B.DDL_TBL_LNM 
  	  FROM WAQ_DDL_IDX A
  	       LEFT JOIN WAM_DDL_TBL B
  	         ON B.DDL_TBL_ID = A.DDL_TBL_ID
  	 WHERE A.RQST_NO = #{rqstNo}
  	 
  	 <if test='rqstStepCd == "Q" or rqstStepCd == "A" '>
    	AND A.VRF_CD = '1'
    </if>
  	 ORDER BY RQST_SNO
  	        , RQST_DTL_SNO
  	
  </select>
  
    <select id="selectDdlIdxDetail" parameterType="kr.wise.meta.ddl.service.WaqDdlIdx" resultMap="ResultMapWithBLOBs">
    
  	<!-- DDL 인덱스 요청서 상세조회 -->
  	  SELECT 	/* WaqDdlIdxMapper.selectDdlIdxDetail */
  	  			A.*
      	   		, B.DDL_TBL_LNM
        FROM WAQ_DDL_IDX A 
             LEFT JOIN WAM_DDL_TBL B
               ON B.DDL_TBL_ID = A.DDL_TBL_ID
       WHERE A.RQST_NO  = #{rqstNo,jdbcType=VARCHAR}
         AND A.RQST_SNO = #{rqstSno,jdbcType=DECIMAL}
         AND A.RQST_DTL_SNO = #{rqstDtlSno,jdbcType=DECIMAL}

  </select>
  
  <delete id="deleteByrqstSno" parameterType="kr.wise.meta.ddl.service.WaqDdlIdx">
  
  	DELETE /* WaqDdlIdxMapper.deleteByrqstSno */
	  FROM WAQ_DDL_IDX
  	 WHERE RQST_NO      = #{rqstNo}
  	   AND RQST_SNO     = #{rqstSno}
  	   AND RQST_DTL_SNO = #{rqstDtlSno}
  	   
  </delete>
  
  <!-- 검증쿼리 : 요청서내 중복(DDX01) -->
  <insert id="checkDupIdx" parameterType="map">
  
  	/* WaqDdlIdxMapper.checkDupIdx */
  	
  	<include refid="kr.wise.commons.rqstmst.service.WaqRqstVrfDtlsMapper.insertVrfDtlSnoSql"/>
  	
    AND EXISTS (SELECT 1
	              FROM WAQ_DDL_IDX D
	             WHERE A.RQST_NO = D.RQST_NO	               
	               AND A.DDL_IDX_PNM = D.DDL_IDX_PNM
	               AND A.DDL_TBL_ID = D.DDL_TBL_ID
	               AND A.DB_SCH_ID = D.DB_SCH_ID
	               AND A.DB_CONN_TRG_ID = D.DB_CONN_TRG_ID               
	               AND A.RQST_SNO     = D.RQST_SNO
	               AND A.RQST_DTL_SNO != D.RQST_DTL_SNO
	              )
  </insert>
  
  <!-- 검증쿼리 : 삭제대상 인덱스 미존재(DDX02) -->
  <insert id="checkNotExistIdx" parameterType="map">
  
  	/* WaqDdlIdxMapper.checkNotExistIdx */
  	
  	<include refid="kr.wise.commons.rqstmst.service.WaqRqstVrfDtlsMapper.insertVrfDtlSnoSql"/>
      
      AND A.RQST_DCD = 'DD'
      AND NOT EXISTS (SELECT 1
                  FROM WAM_DDL_IDX D
                  WHERE A.DDL_IDX_PNM = D.DDL_IDX_PNM
               		AND A.DDL_TBL_ID = D.DDL_TBL_ID
	                AND A.DB_SCH_ID = D.DB_SCH_ID
	                AND A.DB_CONN_TRG_ID = D.DB_CONN_TRG_ID	               
                    AND D.REG_TYP_CD IN ('C', 'U'))  
  </insert>
 
 <!-- 검증쿼리 : 요청중인 인덱스 (DDX03) -->
  <insert id="checkRequestIdx" parameterType="map">
  
  	/* WaqDdlIdxMapper.checkRequestIdx */
  	
  	<include refid="kr.wise.commons.rqstmst.service.WaqRqstVrfDtlsMapper.insertVrfDtlSnoSql"/>
  	
    AND EXISTS (
    		SELECT 1 FROM WAQ_MSTR E
             INNER JOIN WAQ_DDL_IDX D
             	ON E.RQST_NO = D.RQST_NO
             WHERE E.RQST_NO != #{rqstNo}
               AND E.RQST_STEP_CD = 'Q'
               AND A.DDL_IDX_PNM = D.DDL_IDX_PNM
               AND A.DDL_TBL_ID = D.DDL_TBL_ID
               AND A.DB_SCH_ID = D.DB_SCH_ID
               AND A.DB_CONN_TRG_ID = D.DB_CONN_TRG_ID    
			   AND IFNULL(D.RVW_STS_CD, 0) != '2'
               )
  </insert>
  
  <insert id="checkRequestDdlTbl" parameterType="map">
  
  	/* WaqDdlIdxMapper.checkRequestDdlTbl */
  	
  	<include refid="kr.wise.commons.rqstmst.service.WaqRqstVrfDtlsMapper.insertVrfDtlSnoSql"/>
  	-- 검증쿼리 : 요청중인 DDL테이블 (DDX13)
    AND EXISTS (
    		SELECT 1 
    		  FROM WAQ_DDL_TBL E                    
                   INNER JOIN WAQ_MSTR F
                      ON F.RQST_NO = E.RQST_NO
                     AND F.RQST_STEP_CD = 'Q'    	  
             WHERE E.DDL_TBL_ID = A.DDL_TBL_ID
               AND IFNULL(E.RVW_STS_CD, 0) != '2'  
             )
  </insert>
  
  <!-- 검증쿼리 : DB접속정보 미존재(DDX04) -->
  <insert id="checkNonDbConnTrg" parameterType="map">
  
  	/* WaqDdlIdxMapper.checkNonDbConnTrg */
  	
	<include refid="kr.wise.commons.rqstmst.service.WaqRqstVrfDtlsMapper.insertVrfDtlSnoSql"/>
	  
	AND A.RQST_DCD = 'CU'
	AND A.DB_CONN_TRG_ID IS NULL
		
  </insert>
  
  <!-- 검증쿼리 : DB스키마 미존재(DDX05) -->
  <insert id="checkNonDbSch" parameterType="map">
  
  	/* WaqDdlIdxMapper.checkNonDbSch */
  	
	<include refid="kr.wise.commons.rqstmst.service.WaqRqstVrfDtlsMapper.insertVrfDtlSnoSql"/>
	
	AND A.RQST_DCD = 'CU'
	AND IFNULL(A.DB_SCH_ID,'') = ''
		
  </insert>
  
  
  <!-- 검증쿼리 : DDL테이블 미존재(DDX06) -->
  <insert id="checkNonDdlTbl" parameterType="map">
  
  	/* WaqDdlIdxMapper.checkNonDdlTbl */
  	
	<include refid="kr.wise.commons.rqstmst.service.WaqRqstVrfDtlsMapper.insertVrfDtlSnoSql"/>
	
	AND A.RQST_DCD = 'CU'
	AND A.DDL_TBL_ID IS NULL
	
  </insert>
  
  <!-- 검증쿼리 : 인덱스스페이스 미존재(DDX07) -->
  <insert id="checkNonIdxSpac" parameterType="map">
  
  	/* WaqDdlIdxMapper.checkNonIdxSpac */
  	
	<include refid="kr.wise.commons.rqstmst.service.WaqRqstVrfDtlsMapper.insertVrfDtlSql"/>
	
	AND A.RQST_DCD = 'CU'
	AND A.IDX_SPAC_ID IS NULL
	
  </insert>
  
  <!-- 검증쿼리 : 컬럼 존재여부 체크(DDX08) -->
  <insert id="checkNonExistCol" parameterType="map">
  
  	/* WaqDdlIdxMapper.checkNonExistCol */
  	
	<include refid="kr.wise.commons.rqstmst.service.WaqRqstVrfDtlsMapper.insertVrfDtlSnoSql"/>
	  
      <![CDATA[
      AND A.RQST_DCD = 'CU'
      AND NOT EXISTS ( SELECT 1
				         FROM WAQ_DDL_IDX_COL X
				        WHERE X.RQST_NO      = A.RQST_NO 
				          AND X.RQST_SNO     = A.RQST_SNO 
				          AND X.RQST_DTL_SNO = A.RQST_DTL_SNO
				     )
      ]]>
  </insert>
  
  <!-- 검증쿼리 : 인덱스 명명규칙 위반 (DDX09) -->
  <insert id="checkIdxPnmConst" parameterType="map">
  
  	/* WaqDdlIdxMapper.checkIdxPnmConst */
  	
	<include refid="kr.wise.commons.rqstmst.service.WaqRqstVrfDtlsMapper.insertVrfDtlSnoSql"/>
	   
      
      AND A.RQST_DCD = 'CU'            
      AND EXISTS (SELECT 1
                    FROM WAM_DDL_TBL B
                         LEFT JOIN WAM_PDM_TBL C
                           ON C.PDM_TBL_ID = B.PDM_TBL_ID
                   WHERE B.DDL_TBL_ID = A.DDL_TBL_ID 
                     AND C.STD_APL_YN = 'Y'     <!-- 표준준수영역만 -->                    
                  )
      AND NOT EXISTS (SELECT 1
	                    FROM WAM_DDL_TBL B
	                         LEFT JOIN WAM_PDM_TBL C
	                           ON C.PDM_TBL_ID = B.PDM_TBL_ID
	                   WHERE B.DDL_TBL_ID = A.DDL_TBL_ID 	                     	                         
	                     AND CONCAT(B.DDL_TBL_PNM ,'_IDX') = REGEXP_REPLACE(A.DDL_IDX_PNM,'[_,0-9]+$','')	                     	                     
	                  )            
  </insert>
  
<!--
  <insert id="checkIdxPnmConstUk" parameterType="map">
  
  	/* WaqDdlIdxMapper.checkIdxPnmConstUk */
  	
	<include refid="kr.wise.commons.rqstmst.service.WaqRqstVrfDtlsMapper.insertVrfDtlSnoSql"/>
	   
      
      AND A.REG_TYP_CD = 'C'            
      AND EXISTS (SELECT 1
                    FROM WAM_DDL_TBL B
                         LEFT JOIN WAM_PDM_TBL C
                           ON C.PDM_TBL_ID = B.PDM_TBL_ID
                          AND C.STND_ASRT = B.STND_ASRT
                   WHERE B.STND_ASRT = A.STND_ASRT
                     AND B.DDL_TBL_ID = A.DDL_TBL_ID 
                     AND C.STD_APL_YN = 'Y'     # 표준준수영역만                   
                  )
      AND A.UK_IDX_YN = 'Y'
      AND NOT EXISTS (SELECT 1
	                    FROM WAM_DDL_TBL B
	                         LEFT JOIN WAM_PDM_TBL C
	                           ON C.STND_ASRT = B.STND_ASRT
	                          AND C.PDM_TBL_ID = B.PDM_TBL_ID
	                   WHERE B.STND_ASRT = A.STND_ASRT 
	                     AND B.DDL_TBL_ID = A.DDL_TBL_ID 	                     	                         
	                     AND CONCAT(B.DDL_TBL_PNM ,'_UK_') = REGEXP_REPLACE(A.DDL_IDX_PNM,'[0-9]+$','')	                     	                     
	                  )            
  </insert>
  
  <insert id="checkIdxPnmConstNotUk" parameterType="map">
  
  	/* WaqDdlIdxMapper.checkIdxPnmConstNotUk */
  	
	<include refid="kr.wise.commons.rqstmst.service.WaqRqstVrfDtlsMapper.insertVrfDtlSnoSql"/>
	   
      
      AND A.REG_TYP_CD = 'C'                     
      AND EXISTS (SELECT 1
                    FROM WAM_DDL_TBL B
                         LEFT JOIN WAM_PDM_TBL C
                           ON C.PDM_TBL_ID = B.PDM_TBL_ID
                          AND C.STND_ASRT = B.STND_ASRT
                   WHERE B.STND_ASRT = A.STND_ASRT
                     AND B.DDL_TBL_ID = A.DDL_TBL_ID 
                     AND C.STD_APL_YN = 'Y'     # 표준준수영역만                     
                  )
      AND (A.UK_IDX_YN = 'N' OR IFNULL(A.UK_IDX_YN,'') = '')
      AND NOT EXISTS (SELECT 1
	                    FROM WAM_DDL_TBL B
	                         LEFT JOIN WAM_PDM_TBL C
	                           ON C.STND_ASRT = B.STND_ASRT
	                          AND C.PDM_TBL_ID = B.PDM_TBL_ID
	                   WHERE B.STND_ASRT = A.STND_ASRT 
	                     AND B.DDL_TBL_ID = A.DDL_TBL_ID 	                     	                         
	                     AND CONCAT(B.DDL_TBL_PNM ,'_IX_') = REGEXP_REPLACE(A.DDL_IDX_PNM,'[0-9]+$','')	                         	                     
	                  )            
  </insert>
-->
  
  <!-- 검증쿼리 : 변경일 때 변경된 데이터가 없을 경우 (DDX00) -->
  <insert id="checkNotChgData" parameterType="map">
  
  	/* WaqDdlIdxMapper.checkNotChgData */
	  
	<include refid="kr.wise.commons.rqstmst.service.WaqRqstVrfDtlsMapper.updateVrfNotChg"/> 
	  
      AND A.REG_TYP_CD = 'U'
      AND EXISTS (
      		SELECT 1 
      		  FROM WAM_DDL_IDX D
      		 WHERE A.DB_SCH_ID   = D.DB_SCH_ID    
      		   AND A.DDL_IDX_PNM = D.DDL_IDX_PNM  		         		      		          		            		  
      		   AND IFNULL(A.UK_IDX_YN, 'N') = IFNULL(D.UK_IDX_YN, 'N')      		          		   
      		)
      AND NOT EXISTS (
      		SELECT 1 
      		  FROM WAQ_DDL_IDX_COL D
      		 WHERE D.RQST_NO      = A.RQST_NO
               AND D.RQST_SNO     = A.RQST_SNO
               AND D.RQST_DTL_SNO = A.RQST_DTL_SNO
               AND D.VRF_CD = '1'
      		)
  </insert>
  
<!--
  <insert id="checkDdlTbl" parameterType="map">
  
  	/* WaqDdlIdxMapper.checkDdlTbl */
	  
	<include refid="kr.wise.commons.rqstmst.service.WaqRqstVrfDtlsMapper.insertVrfDtlSnoSql"/> 
	  
      AND A.REG_TYP_CD IN ('U','C')
      AND NOT EXISTS (
      		SELECT 1 
      		  FROM WAM_DDL_TBL D
      		 WHERE A.DB_SCH_ID   = D.DB_SCH_ID    
      		   AND A.STND_ASRT = D.STND_ASRT
      		   AND A.DDL_TBL_PNM = D.DDL_TBL_PNM  	
      		   UNION ALL
      		   SELECT 1 
      		  FROM WAQ_DDL_TBL D
      		 WHERE D.STND_ASRT  = A.STND_ASRT        
      		   AND D.RQST_NO      = A.RQST_NO
      		   AND D.DDL_TBL_PNM = A.DDL_TBL_PNM
      		   	         		      		          		            		  
      		)
  </insert>
-->
  <!-- 검증쿼리 : 변경일 때 변경된 데이터가 없을 경우 (DDX00) -->
  <insert id="checkInsNotChgData" parameterType="map">
  
  	/* WaqDdlIdxMapper.checkInsNotChgData */
  	
	  <!-- <include refid="kr.wise.commons.rqstmst.service.WaqRqstVrfDtlsMapper.insertVrfDtlSnoSql"/>  -->
	  
	  <include refid="kr.wise.commons.rqstmst.service.WaqRqstVrfDtlsMapper.updateVrfNotChg"/>  
	  
      AND A.REG_TYP_CD = 'U'
      AND EXISTS (
      		SELECT 1 
      		  FROM WAM_DDL_IDX D
      		 WHERE A.DB_SCH_ID   = D.DB_SCH_ID    
      		   AND A.DDL_IDX_PNM = D.DDL_IDX_PNM  		   
      		   AND IFNULL(A.DB_CONN_TRG_ID, '')   = IFNULL(D.DB_CONN_TRG_ID, '')
      		   AND IFNULL(A.DB_SCH_ID, '') 	  	  = IFNULL(D.DB_SCH_ID, '')
      		   AND IFNULL(A.DDL_TBL_ID, '') 	  = IFNULL(D.DDL_TBL_ID, '')
      		   AND IFNULL(A.IDX_SPAC_ID, '') 	  = IFNULL(D.IDX_SPAC_ID, '')      		         		   
      		   AND IFNULL(A.UK_IDX_YN, 'N') 	  = IFNULL(D.UK_IDX_YN, 'N')        		   
      		   
      		)
      AND NOT EXISTS (
      		SELECT 1 
      		  FROM WAQ_DDL_IDX_COL D
      		 WHERE D.RQST_NO      = A.RQST_NO
               AND D.RQST_SNO     = A.RQST_SNO
               AND D.RQST_DTL_SNO = A.RQST_DTL_SNO
               AND D.VRF_CD = '1'
      		)
  </insert>
  
  <!-- 검증쿼리 : 컬럼 오류가 있을 경우 체크 (DDX99) -->
  <insert id="checkColErr" parameterType="map">
  
  	/* WaqDdlIdxMapper.checkColErr */
  	
	  <include refid="kr.wise.commons.rqstmst.service.WaqRqstVrfDtlsMapper.insertVrfDtlSnoSql"/>
	  
	  AND EXISTS (
	  			SELECT 1 
	  			  FROM WAQ_DDL_IDX_COL D
	  			 WHERE A.RQST_NO      = D.RQST_NO
	  			   AND A.RQST_SNO     = D.RQST_SNO
	  			   AND A.RQST_DTL_SNO = D.RQST_DTL_SNO
	  			   AND D.VRF_CD = '2'          
	  	)
  </insert>
  
  <!-- 요청구분 업데이트 -->
    <update id="updateCheckInit" parameterType="string">
    
    /* WaqDdlIdxMapper.updateCheckInit */
  	<!--
    UPDATE WAQ_DDL_IDX A
	LEFT OUTER JOIN 
	(
		SELECT     
	    		  B.DDL_IDX_ID AS DDL_IDX_ID     	
				 , B.DB_SCH_ID
				 , B.DDL_IDX_PNM
				 , B.STND_ASRT				     				  
	      FROM WAM_DDL_IDX B					   	      
	     INNER JOIN WAA_DB_SCH S
			  ON S.STND_ASRT = B.STND_ASRT
			 AND S.DB_SCH_ID = B.DB_SCH_ID  
			 AND S.EXP_DTM = STR_TO_DATE('9999-12-31', '%Y-%m-%d')
			 AND S.REG_TYP_CD IN ('C', 'U') 					   	      					   	                                                                                                                                          
	) B
	  ON B.STND_ASRT = A.STND_ASRT
	 AND B.DB_SCH_ID   = A.DB_SCH_ID
	 AND B.DDL_IDX_PNM = A.DDL_IDX_PNM      
	 SET  A.REG_TYP_CD = CASE WHEN A.RQST_DCD = 'DD' THEN 'D' ELSE CASE WHEN B.DDL_IDX_ID IS NULL THEN 'C' ELSE 'U' END END
	    , A.DDL_IDX_ID = B.DDL_IDX_ID
        , A.VRF_CD = '4'
    WHERE A.RQST_NO = #{rqstNo,jdbcType=VARCHAR}
    -->
   
    UPDATE WAQ_DDL_IDX A
    	   LEFT JOIN WAM_DDL_IDX B					   	      
    	     ON B.DB_SCH_ID   = A.DB_SCH_ID
            AND B.DDL_IDX_PNM = A.DDL_IDX_PNM
		   LEFT JOIN WAA_DB_SCH S
		      ON S.DB_SCH_ID = B.DB_SCH_ID   
			 AND S.EXP_DTM = STR_TO_DATE('9999-12-31', '%Y-%m-%d')
			 AND S.REG_TYP_CD IN ('C', 'U') 
       SET A.REG_TYP_CD = CASE WHEN A.RQST_DCD = 'DD' THEN 'D' ELSE CASE WHEN B.DDL_IDX_ID IS NULL THEN 'C' ELSE 'U' END END     
         , A.DDL_IDX_ID = B.DDL_IDX_ID
         , A.VRF_CD = '4'
     WHERE A.RQST_NO = #{rqstNo,jdbcType=VARCHAR} 
  </update>
  
  <!-- 각종 ID 업데이트 -->
  <update id="updateKeyId" parameterType="string">
  
	/* WaqDdlIdxMapper.updateKeyId */
  	<!--
   UPDATE WAQ_DDL_IDX A
	INNER JOIN WAM_DDL_TBL B
	   ON A.STND_ASRT = B.STND_ASRT
	  AND A.DB_SCH_ID = B.DB_SCH_ID
	  AND A.DDL_TBL_PNM = B.DDL_TBL_PNM
	INNER JOIN WAA_DB_SCH C
	   ON C.EXP_DTM = STR_TO_DATE('9999-12-31', '%Y-%m-%d')
	  AND C.REG_TYP_CD IN ('C', 'U')
	  AND C.STND_ASRT = B.STND_ASRT
	  AND C.DB_SCH_ID = B.DB_SCH_ID  
	  AND C.DB_SCH_PNM      = A.DB_SCH_PNM 
	INNER JOIN WAA_DB_CONN_TRG D
		ON D.EXP_DTM = STR_TO_DATE('9999-12-31', '%Y-%m-%d')
	  AND D.REG_TYP_CD IN ('C', 'U')
	  AND A.STND_ASRT = D.STND_ASRT
	  AND D.DB_CONN_TRG_ID = C.DB_CONN_TRG_ID
	   AND D.DB_CONN_TRG_PNM = A.DB_CONN_TRG_PNM
	   AND D.INFO_SYS_CD != 'E'
	SET A.DB_CONN_TRG_ID = D.DB_CONN_TRG_ID, # max가필요할 경우 쿼리 수정 2020-02-21 cyy
	    A.DB_SCH_ID      = C.DB_SCH_ID, 
		A.DDL_TBL_ID     = B.DDL_TBL_ID
    WHERE A.RQST_NO = #{rqstNo,jdbcType=VARCHAR}  	
      AND EXISTS (
       		      SELECT 1
                    FROM WAM_DDL_TBL B 
                         INNER JOIN WAA_DB_SCH C
                            ON C.EXP_DTM = STR_TO_DATE('9999-12-31', '%Y-%m-%d')
			    	       AND C.REG_TYP_CD IN ('C', 'U')
			    	       AND C.DB_SCH_ID = B.DB_SCH_ID 
			    	     INNER JOIN WAA_DB_CONN_TRG D
			    	        ON D.EXP_DTM = STR_TO_DATE('9999-12-31', '%Y-%m-%d')
			    	       AND D.REG_TYP_CD IN ('C', 'U')
			    	       AND D.DB_CONN_TRG_ID = C.DB_CONN_TRG_ID
			    	     LEFT JOIN WAA_TBL_SPAC E
			    	        ON E.EXP_DTM = STR_TO_DATE('9999-12-31', '%Y-%m-%d')
			    	       AND E.REG_TYP_CD IN ('C', 'U')
			    	       AND E.DB_TBL_SPAC_ID = C.DB_IDX_SPAC_ID
                   WHERE 1 = 1
                     AND D.DB_CONN_TRG_PNM = A.DB_CONN_TRG_PNM
                     AND C.DB_SCH_PNM      = A.DB_SCH_PNM                           
                     AND B.DDL_TBL_PNM     = A.DDL_TBL_PNM                                                        
                   ) 
    -->
    
    UPDATE WAQ_DDL_IDX A
    	   LEFT JOIN WAM_DDL_TBL B 
     	     ON B.DDL_TBL_PNM     = A.DDL_TBL_PNM
	       INNER JOIN WAA_DB_SCH C
	          ON C.EXP_DTM = STR_TO_DATE('9999-12-31', '%Y-%m-%d')
	   		 AND C.REG_TYP_CD IN ('C', 'U')
	   		 AND C.DB_SCH_ID 	= B.DB_SCH_ID 
	   		 AND C.DB_SCH_PNM   = A.DB_SCH_PNM
	   	   INNER JOIN WAA_DB_CONN_TRG D
	   		  ON D.EXP_DTM = STR_TO_DATE('9999-12-31', '%Y-%m-%d')
	   		 AND D.REG_TYP_CD IN ('C', 'U')
	   		 AND D.DB_CONN_TRG_ID = C.DB_CONN_TRG_ID
	   		 AND D.DB_CONN_TRG_PNM = A.DB_CONN_TRG_PNM
	   	   LEFT JOIN WAA_TBL_SPAC E
	   		 ON E.EXP_DTM = STR_TO_DATE('9999-12-31', '%Y-%m-%d')
	   		AND E.REG_TYP_CD IN ('C', 'U')
	   		AND E.DB_TBL_SPAC_ID = C.DB_IDX_SPAC_ID
      
       SET A.DB_CONN_TRG_ID = D.DB_CONN_TRG_ID
         , A.DB_SCH_ID		= C.DB_SCH_ID
         , A.DDL_TBL_ID		= B.DDL_TBL_ID
         , A.IDX_SPAC_ID	= E.DB_TBL_SPAC_ID
         , A.IDX_SPAC_PNM   = E.DB_TBL_SPAC_PNM               
    WHERE A.RQST_NO = #{rqstNo,jdbcType=VARCHAR}  	
      AND EXISTS (
       		      SELECT 1
                    FROM WAM_DDL_TBL B 
                         INNER JOIN WAA_DB_SCH C
                            ON C.EXP_DTM = STR_TO_DATE('9999-12-31', '%Y-%m-%d')
			    	       AND C.REG_TYP_CD IN ('C', 'U')
			    	       AND C.DB_SCH_ID = B.DB_SCH_ID 
			    	     INNER JOIN WAA_DB_CONN_TRG D
			    	        ON D.EXP_DTM = STR_TO_DATE('9999-12-31', '%Y-%m-%d')
			    	       AND D.REG_TYP_CD IN ('C', 'U')
			    	       AND D.DB_CONN_TRG_ID = C.DB_CONN_TRG_ID
			    	     LEFT JOIN WAA_TBL_SPAC E
			    	        ON E.EXP_DTM = STR_TO_DATE('9999-12-31', '%Y-%m-%d')
			    	       AND E.REG_TYP_CD IN ('C', 'U')
			    	       AND E.DB_TBL_SPAC_ID = C.DB_IDX_SPAC_ID
                   WHERE 1 = 1
                     AND D.DB_CONN_TRG_PNM = A.DB_CONN_TRG_PNM
                     AND C.DB_SCH_PNM      = A.DB_SCH_PNM                           
                     AND B.DDL_TBL_PNM     = A.DDL_TBL_PNM                                                        
                   )    
  </update>
  
  
  <update id="updateKeyId2" parameterType="string">
  
	/* WaqDdlIdxMapper.updateKeyId2 */
  	
   UPDATE WAQ_DDL_IDX A
	INNER JOIN WAM_DDL_TBL B
	   ON A.STND_ASRT = B.STND_ASRT
	  AND A.DB_SCH_ID = B.DB_SCH_ID
	  AND A.DDL_TBL_PNM = B.DDL_TBL_PNM
	INNER JOIN WAA_DB_SCH C
	   ON C.EXP_DTM = STR_TO_DATE('9999-12-31', '%Y-%m-%d')
	  AND C.REG_TYP_CD IN ('C', 'U')
	  AND C.STND_ASRT = B.STND_ASRT
	  AND C.DB_SCH_ID = B.DB_SCH_ID  
	  AND C.DB_SCH_PNM      = A.DB_SCH_PNM 
	INNER JOIN WAA_DB_CONN_TRG D
		ON D.EXP_DTM = STR_TO_DATE('9999-12-31', '%Y-%m-%d')
	  AND D.REG_TYP_CD IN ('C', 'U')
	  AND A.STND_ASRT = D.STND_ASRT
	  AND D.DB_CONN_TRG_ID = C.DB_CONN_TRG_ID
	   AND D.DB_CONN_TRG_PNM = A.DB_CONN_TRG_PNM
	   AND D.INFO_SYS_CD != 'E'
	SET A.DB_CONN_TRG_ID = D.DB_CONN_TRG_ID, <!-- max가필요할 경우 쿼리 수정 2020-02-21 cyy -->
	    A.DB_SCH_ID      = C.DB_SCH_ID
    WHERE A.RQST_NO = #{rqstNo,jdbcType=VARCHAR}  	
  </update>
  
  <update id="updateTgtDbmsSchId" parameterType="string">
  
	/* WaqDdlIdxMapper.updateTgtDbmsSchId */
   UPDATE WAQ_DDL_IDX A
	INNER JOIN WAA_DB_SCH B
	     ON A.STND_ASRT = B.STND_ASRT
	   AND A.DB_SCH_PNM = B.DB_SCH_PNM
	   AND B.EXP_DTM = STR_TO_DATE('9999-12-31', '%Y-%m-%d')
	   AND B.REG_TYP_CD IN ('C', 'U')
	INNER JOIN WAA_DB_CONN_TRG C
	      ON B.STND_ASRT = C.STND_ASRT
	   AND B.DB_CONN_TRG_ID = C.DB_CONN_TRG_ID
	   AND A.DB_CONN_TRG_PNM = C.DB_CONN_TRG_PNM
	   AND C.EXP_DTM = STR_TO_DATE('9999-12-31', '%Y-%m-%d')
	   AND C.REG_TYP_CD IN ('C', 'U')
	   AND C.INFO_SYS_CD != 'E'
	  SET A.DB_CONN_TRG_ID = C.DB_CONN_TRG_ID
         ,A.DB_SCH_ID = B.DB_SCH_ID
    WHERE A.RQST_NO = #{rqstNo,jdbcType=VARCHAR}  
     AND IFNULL(A.DB_SCH_ID,'') =''	
  </update>
  
  
  <update id="updateSrcDbmsSchId" parameterType="string">
  
	/* WaqDdlIdxMapper.updateSrcDbmsSchId */
   UPDATE WAQ_DDL_IDX A
	INNER JOIN WAA_DB_SCH B
	     ON A.STND_ASRT = B.STND_ASRT
	   AND A.SRC_DB_SCH_PNM = B.DB_SCH_PNM
	   AND B.EXP_DTM = STR_TO_DATE('9999-12-31', '%Y-%m-%d')
	   AND B.REG_TYP_CD IN ('C', 'U')
	INNER JOIN WAA_DB_CONN_TRG C
	      ON B.STND_ASRT = C.STND_ASRT
	   AND B.DB_CONN_TRG_ID = C.DB_CONN_TRG_ID
	   AND A.SRC_DB_CONN_TRG_PNM = C. DB_CONN_TRG_PNM
	   AND C.EXP_DTM = STR_TO_DATE('9999-12-31', '%Y-%m-%d')
	   AND C.REG_TYP_CD IN ('C', 'U')
	   AND C.INFO_SYS_CD != 'E'
	  SET A.SRC_DB_SCH_ID = B.DB_SCH_ID
         ,A.SRC_DDL_TRG_DCD = B.DDL_TRG_DCD 
    WHERE A.RQST_NO = #{rqstNo,jdbcType=VARCHAR}  	
     AND IFNULL(A.SRC_DB_SCH_ID,'') =''
  </update>
  
  <update id="updateLnm" parameterType="string">
  
	/* WaqDdlIdxMapper.updateLnm */
   UPDATE WAQ_DDL_IDX A
	INNER JOIN WAM_DDL_IDX B
	     ON A.STND_ASRT = B.STND_ASRT 
	    AND A.SRC_DB_SCH_ID = B.DB_SCH_ID
	    AND A.DDL_IDX_PNM = B.DDL_IDX_PNM
	 SET A.DDL_IDX_LNM = B.DDL_IDX_LNM
    WHERE A.RQST_NO = #{rqstNo,jdbcType=VARCHAR}  	
     AND IFNULL(A.DDL_IDX_LNM,'') =''
  </update>
  
  <update id="updateTblInfo" parameterType="string">
  
	/* WaqDdlIdxMapper.updateTblInfo */
   UPDATE WAQ_DDL_IDX A
	INNER JOIN WAM_DDL_IDX B
	     ON A.STND_ASRT = B.STND_ASRT 
	    AND A.SRC_DB_SCH_ID = B.DB_SCH_ID
	    AND A.DDL_IDX_PNM = B.DDL_IDX_PNM
	INNER JOIN WAM_DDL_TBL C
	     ON B.STND_ASRT = C.STND_ASRT
	   AND B.DB_SCH_ID = C.DB_SCH_ID
	   AND B.DDL_TBL_ID = C.DDL_TBL_ID
	 SET A.DDL_TBL_PNM = C.DDL_TBL_PNM
    WHERE A.RQST_NO = #{rqstNo,jdbcType=VARCHAR}  	
    AND IFNULL(A.DDL_TBL_PNM,'') =''
  </update>
  
  
  <update id="updateTblId" parameterType="string">
  
	/* WaqDdlIdxMapper.updateTblId */
    UPDATE WAQ_DDL_IDX A
	INNER JOIN WAA_DB_SCH B
	     ON A.STND_ASRT = B.STND_ASRT
	   AND A.DB_SCH_PNM = B.DB_SCH_PNM
	   AND B.EXP_DTM = STR_TO_DATE('9999-12-31', '%Y-%m-%d')
	   AND B.REG_TYP_CD IN ('C', 'U')
	INNER JOIN WAA_DB_CONN_TRG C
	      ON B.STND_ASRT = C.STND_ASRT
	   AND B.DB_CONN_TRG_ID = C.DB_CONN_TRG_ID
	   AND A.DB_CONN_TRG_PNM = C.DB_CONN_TRG_PNM
	   AND C.EXP_DTM = STR_TO_DATE('9999-12-31', '%Y-%m-%d')
	   AND C.REG_TYP_CD IN ('C', 'U')
	   AND C.INFO_SYS_CD != 'E'
	INNER JOIN WAM_DDL_TBL D
	      ON B.STND_ASRT =D.STND_ASRT
	    AND B.DB_SCH_ID = D.DB_SCH_ID
	   AND A.DDL_TBL_PNM = D.DDL_TBL_PNM	
	SET A.DDL_TBL_ID = D.DDL_TBL_ID
    WHERE A.RQST_NO = #{rqstNo,jdbcType=VARCHAR}  
      AND IFNULL(A.DDL_TBL_ID,'') =''	
  </update>
  
  
  <update id="updateIdxSpce" parameterType="string">
  
	/* WaqDdlIdxMapper.updateIdxSpce */
    UPDATE WAQ_DDL_IDX A
	INNER JOIN WAA_TBL_SPAC B
	     ON A.STND_ASRT = B.STND_ASRT
	   AND A.DB_CONN_TRG_ID = B.DB_CONN_TRG_ID
	    AND B.REG_TYP_CD IN ('C', 'U') 
	    AND B.EXP_DTM = STR_TO_DATE('9999-12-31', '%Y-%m-%d')
	    AND B.TBL_SPAC_TYP_CD = '2'
	   SET A.IDX_SPAC_ID  = B.DB_TBL_SPAC_ID
	  WHERE A.RQST_NO =#{rqstNo,jdbcType=VARCHAR}  
      AND IFNULL(A.IDX_SPAC_ID,'') = ''
  </update>
  
  <!-- 승인/반려 업데이트 -->
  <update id="updatervwStsCd" parameterType="kr.wise.meta.ddl.service.WaqDdlIdx" >
  
	UPDATE 	/* WaqDdlIdxMapper.updatervwStsCd */
			WAQ_DDL_IDX
  	<set>
  	    RVW_STS_CD 	= #{rvwStsCd} , 
  		RVW_CONTS 	= #{rvwConts} , 
  		APRV_DTM	= NOW() ,
  		APRV_USER_ID = #{aprvUserId} ,
  	</set>
    WHERE RQST_NO = #{rqstNo,jdbcType=VARCHAR}
      AND RQST_SNO = #{rqstSno,jdbcType=DECIMAL}
      AND RQST_DTL_SNO = #{rqstDtlSno,jdbcType=DECIMAL}
      AND VRF_CD = '1'
      AND IFNULL(RVW_STS_CD, '_') != '2'
  </update>
  
  <!-- 신규 적재 대상 추출 -->
  <select id="selectWaqC" parameterType="map" resultMap="BaseResultMap">
  
   SELECT /* WaqDdlIdxMapper.selectWaqC */
   		* FROM WAQ_DDL_IDX
   	WHERE RQST_NO = #{rqstNo}
   	  AND RVW_STS_CD = '1'  <!-- 승인 -->
   	  AND REG_TYP_CD = 'C'
   	  
   </select>
  
  <!-- 신규 적재 대상 ID 업데이트 -->
  <update id="updateidByKey" parameterType="kr.wise.meta.ddl.service.WaqDdlIdx">
  
    UPDATE 	/* WaqDdlIdxMapper.updateidByKey */
    		WAQ_DDL_IDX 
       SET DDL_IDX_ID = #{ddlIdxId,jdbcType=VARCHAR}
  	 WHERE RQST_NO      = #{rqstNo,jdbcType=VARCHAR}
       AND RQST_SNO     = #{rqstSno,jdbcType=DECIMAL}
       AND RQST_DTL_SNO = #{rqstDtlSno,jdbcType=DECIMAL}
   </update>

	<!-- WAQ ID, VERS 등을 업데이트... -->
	<update id="updateWaqCUD" parameterType="map">
	<!--
	UPDATE 	/* WaqDdlIdxMapper.updateWaqCUD */
			WAQ_DDL_IDX A
	INNER JOIN WAM_DDL_IDX B
	   ON A.STND_ASRT = B.STND_ASRT
	  AND A.DB_SCH_ID =  B.DB_SCH_ID
	  AND B.DDL_IDX_PNM     = A.DDL_IDX_PNM
	INNER JOIN WAM_DDL_TBL C
		ON B.DDL_TBL_ID = C.DDL_TBL_ID
	  AND C.REG_TYP_CD IN ('C', 'U')
	  AND C.STND_ASRT = A.STND_ASRT
	   AND C.DB_SCH_ID =  A.DB_SCH_ID
	  AND C.DDL_TBL_PNM     = A.DDL_TBL_PNM
	INNER JOIN WAA_DB_SCH S
		ON B.DB_SCH_ID = S.DB_SCH_ID
	  AND B.STND_ASRT = S.STND_ASRT
	  AND S.EXP_DTM = STR_TO_DATE('9999-12-31', '%Y-%m-%d')
	  AND S.REG_TYP_CD IN ('C', 'U')
	  AND S.DB_SCH_PNM      = A.DB_SCH_PNM 
	INNER JOIN WAA_DB_CONN_TRG D
		ON D.DB_CONN_TRG_ID = S.DB_CONN_TRG_ID
	  AND D.STND_ASRT = S.STND_ASRT
	  AND D.EXP_DTM = STR_TO_DATE('9999-12-31', '%Y-%m-%d')
	  AND D.REG_TYP_CD IN ('C', 'U')
	  AND D.DB_CONN_TRG_PNM = A.DB_CONN_TRG_PNM 
	  AND D.INFO_SYS_CD != 'E'
	  SET A.DDL_IDX_ID = B.DDL_IDX_ID,
	      A.OBJ_VERS = IFNULL(B.OBJ_VERS, 0) + 1,
	      A.FRS_RQST_DTM = B.FRS_RQST_DTM,
	      A.FRS_RQST_USER_ID = B.FRS_RQST_USER_ID 
	WHERE A.RQST_NO = #{rqstNo}
	AND A.RVW_STS_CD = '1'  # 승인 
	AND EXISTS (
	  SELECT 1
	    FROM WAM_DDL_IDX B
		   INNER JOIN WAM_DDL_TBL C
		      ON B.STND_ASRT = C.STND_ASRT
		      AND B.DB_SCH_ID = C.DB_SCH_ID
		     AND B.DDL_TBL_ID = C.DDL_TBL_ID
		     AND C.REG_TYP_CD IN ('C', 'U')
		   INNER JOIN WAA_DB_SCH S
	          ON B.DB_SCH_ID = S.DB_SCH_ID
	         AND B.STND_ASRT = S.STND_ASRT
	         AND S.EXP_DTM = STR_TO_DATE('9999-12-31', '%Y-%m-%d')
	   	     AND S.REG_TYP_CD IN ('C', 'U')
	   	   INNER JOIN WAA_DB_CONN_TRG D
	          ON D.DB_CONN_TRG_ID = S.DB_CONN_TRG_ID
	         AND D.STND_ASRT = S.STND_ASRT
	   	     AND D.EXP_DTM = STR_TO_DATE('9999-12-31', '%Y-%m-%d')
	   	     AND D.REG_TYP_CD IN ('C', 'U') 
	   	     AND D.INFO_SYS_CD != 'E'	       
	    WHERE B.DDL_IDX_PNM     = A.DDL_IDX_PNM
          AND C.DDL_TBL_PNM     = A.DDL_TBL_PNM
          AND S.DB_SCH_PNM      = A.DB_SCH_PNM 
          AND D.DB_CONN_TRG_PNM = A.DB_CONN_TRG_PNM  
	)
	-->
	
	UPDATE WAQ_DDL_IDX A
		   LEFT JOIN WAM_DDL_IDX B
		     ON B.DDL_IDX_PNM     = A.DDL_IDX_PNM
		   INNER JOIN WAM_DDL_TBL C
		      ON B.DDL_TBL_ID = C.DDL_TBL_ID
		     AND C.REG_TYP_CD IN ('C', 'U')
		     AND C.DDL_TBL_PNM     = A.DDL_TBL_PNM
		   INNER JOIN WAA_DB_SCH S
	          ON B.DB_SCH_ID = S.DB_SCH_ID
	         AND S.EXP_DTM = STR_TO_DATE('9999-12-31', '%Y-%m-%d')
	   	     AND S.REG_TYP_CD IN ('C', 'U')
	   	     AND S.DB_SCH_PNM      = A.DB_SCH_PNM
	   	   INNER JOIN WAA_DB_CONN_TRG D
	          ON D.DB_CONN_TRG_ID = S.DB_CONN_TRG_ID
	   	     AND D.EXP_DTM = STR_TO_DATE('9999-12-31', '%Y-%m-%d')
	   	     AND D.REG_TYP_CD IN ('C', 'U') 
	   	     AND D.DB_CONN_TRG_PNM = A.DB_CONN_TRG_PNM 
	SET A.DDL_IDX_ID		= B.DDL_IDX_ID
	  , A.OBJ_VERS			= IFNULL(B.OBJ_VERS, 0) + 1
	  , A.FRS_RQST_DTM		= B.FRS_RQST_DTM
	  , A.FRS_RQST_USER_ID  = B.FRS_RQST_USER_ID          
	WHERE A.RQST_NO = #{rqstNo}
	<!-- AND A.VRF_CD = '1' 	#	등록가능 -->
	AND A.RVW_STS_CD = '1'  <!-- 승인 -->
	AND EXISTS (
	  SELECT 1
	    FROM WAM_DDL_IDX B
		   INNER JOIN WAM_DDL_TBL C
		      ON B.DDL_TBL_ID = C.DDL_TBL_ID
		     AND C.REG_TYP_CD IN ('C', 'U')
		   INNER JOIN WAA_DB_SCH S
	          ON B.DB_SCH_ID = S.DB_SCH_ID
	         AND S.EXP_DTM = STR_TO_DATE('9999-12-31', '%Y-%m-%d')
	   	     AND S.REG_TYP_CD IN ('C', 'U')
	   	   INNER JOIN WAA_DB_CONN_TRG D
	          ON D.DB_CONN_TRG_ID = S.DB_CONN_TRG_ID
	   	     AND D.EXP_DTM = STR_TO_DATE('9999-12-31', '%Y-%m-%d')
	   	     AND D.REG_TYP_CD IN ('C', 'U') 	       
	    WHERE B.DDL_IDX_PNM     = A.DDL_IDX_PNM
          AND C.DDL_TBL_PNM     = A.DDL_TBL_PNM
          AND S.DB_SCH_PNM      = A.DB_SCH_PNM 
          AND D.DB_CONN_TRG_PNM = A.DB_CONN_TRG_PNM  
	)	
   </update>
   
   <!-- WAQ ID, VERS 등을 업데이트... -->
   <update id="updateWaqDdlTblId" parameterType="map">
   <!--
	UPDATE 	/* WaqDdlIdxMapper.updateWaqDdlTblId */
			WAQ_DDL_IDX A
	INNER JOIN WAM_DDL_TBL B
	   ON A.RQST_NO = B.RQST_NO
	  AND A.STND_ASRT = B.STND_ASRT
	  AND A.DDL_TBL_PNM = B.DDL_TBL_PNM
	  AND A.DB_SCH_ID = B.DB_SCH_ID
	  SET A.DDL_TBL_ID = B.DDL_TBL_ID
	WHERE A.RQST_NO = #{rqstNo}
	  AND A.DDL_TBL_ID IS NULL 
	  AND EXISTS (SELECT 1
				    FROM WAM_DDL_TBL B		   
				   WHERE A.RQST_NO = B.RQST_NO
					  AND A.STND_ASRT = B.STND_ASRT
					  AND A.DDL_TBL_PNM = B.DDL_TBL_PNM
					  AND A.DB_SCH_ID = B.DB_SCH_ID
					 LIMIT 1    
				 )
	-->			 
	
	UPDATE WAQ_DDL_IDX A
		   LEFT JOIN WAM_DDL_TBL B		   
			 ON B.RQST_NO  = A.RQST_NO
			AND B.RQST_SNO = A.RQST_SNO
	   SET A.DDL_TBL_ID = B.DDL_TBL_ID
	WHERE A.RQST_NO = #{rqstNo}
	  AND IFNULL(A.DDL_TBL_ID, '') = ''
	  AND EXISTS (SELECT 1
				    FROM WAM_DDL_TBL B		   
				   WHERE B.RQST_NO  = A.RQST_NO
					 AND B.RQST_SNO = A.RQST_SNO 
				   LIMIT 1
				 )	
   </update>
   
   
   <update id="updateTsf" parameterType="string">
  
  	/* WaqDdlIdxMapper.updateTsf */
  	
   UPDATE WAQ_DDL_IDX A
         INNER JOIN WAM_DDL_IDX B 
            ON A.STND_ASRT = B.STND_ASRT
           AND A.SRC_DB_SCH_ID = B.DB_SCH_ID
           AND A.DDL_IDX_PNM = B.DDL_IDX_PNM
         LEFT OUTER JOIN WAA_DB_SCH C
           ON A.STND_ASRT = C.STND_ASRT
          AND A.SRC_DB_SCH_ID = C.DB_SCH_ID
          AND C.EXP_DTM = STR_TO_DATE('9999-12-31', '%Y-%m-%d')
        SET A.PK_IDX_YN = B.PK_IDX_YN
           ,A.UK_IDX_YN = B.UK_IDX_YN
           ,A.IDX_TYP_CD = B.IDX_TYP_CD
           ,A.COL_CGR_TEXT = B.COL_CGR_TEXT
           ,A.DDL_IDX_COL_ASM = B.DDL_IDX_COL_ASM
           ,A.PRJ_NO = B.PRJ_NO
		   ,A.SRC_DDL_TRG_DCD = CASE WHEN C.DDL_TRG_DCD = 'D' THEN 'D'
			     							   WHEN C.DDL_TRG_DCD = 'T' THEN 'T' 
			     							ELSE NULL END
		    ,A.DBA_DDL_STMT = B.DBA_DDL_STMT
		WHERE A.RQST_NO=#{rqstNo,jdbcType=VARCHAR}
     
  </update>
   
   
   <update id="updateDbaDdlStmt" parameterType="string">
  
  	/* WaqDdlIdxMapper.updateDbaDdlStmt */
  	
   UPDATE WAQ_DDL_IDX A
         INNER JOIN WAM_DDL_IDX B 
            ON A.STND_ASRT = B.STND_ASRT
           AND A.DB_SCH_ID = B.DB_SCH_ID
           AND A.DDL_IDX_PNM = B.DDL_IDX_PNM
        SET A.DBA_DDL_STMT = B.DBA_DDL_STMT
		WHERE A.RQST_NO=#{rqstNo,jdbcType=VARCHAR}
     
  </update>
  
   <sql id="wam_col_ins">
	, DDL_IDX_PNM, DDL_IDX_LNM, DB_CONN_TRG_ID, DB_SCH_ID, DDL_TBL_ID
	, IDX_SPAC_ID
	, PK_IDX_YN, UK_IDX_YN, IDX_TYP_CD, SCRT_INFO
	, PRC_TYP_CD
	, PRC_DT
	, PRC_DBA_ID
	, RQST_NO
	, RQST_SNO
	, RQST_DTL_SNO
	, OBJ_DESCN, OBJ_VERS, REG_TYP_CD, FRS_RQST_DTM, FRS_RQST_USER_ID 
    , RQST_DTM, RQST_USER_ID, APRV_DTM, APRV_USER_ID
    , DDL_IDX_COL_ASM 
   </sql>
   
   <sql id="wam_col">
	, DDL_IDX_PNM, DDL_IDX_LNM, DB_CONN_TRG_ID, DB_SCH_ID, DDL_TBL_ID
	, IDX_SPAC_ID
	, PK_IDX_YN, UK_IDX_YN, IDX_TYP_CD, SCRT_INFO, NULL AS PRC_TYP_CD, NULL AS PRC_DT, NULL AS PRC_DBA_ID
	, RQST_NO
	, RQST_SNO
	, RQST_DTL_SNO
	, OBJ_DESCN, OBJ_VERS, REG_TYP_CD, FRS_RQST_DTM, FRS_RQST_USER_ID 
    , RQST_DTM, RQST_USER_ID, APRV_DTM, APRV_USER_ID
    , DDL_IDX_COL_ASM 
   </sql>
   
   <!-- WAM 삭제 (등록유형코드가REG_TYP_CD 변경, 삭제일 경우) -->
   <delete id="deleteWAM" parameterType="map">
   
    <!--
	DELETE A FROM WAM_DDL_IDX A
	 WHERE EXISTS ( SELECT 1 
				      FROM WAQ_DDL_IDX B
				     WHERE B.RQST_NO = #{rqstNo}
				       AND B.VRF_CD = '1'
				       AND B.RVW_STS_CD = '1'				       
				       AND B.DDL_IDX_ID = A.DDL_IDX_ID	       
				  )
	-->
	
	DELETE 	/* WaqDdlIdxMapper.deleteWAM */
			A FROM WAM_DDL_IDX A
	 		       INNER JOIN WAQ_DDL_IDX B
	    			  ON B.DDL_IDX_ID = A.DDL_IDX_ID	
	 WHERE B.RQST_NO = #{rqstNo}
	   AND B.VRF_CD = '1'
	   AND B.RVW_STS_CD = '1'
	   
   </delete>   

	<!-- WAM 추가 (WAQ 내용을 추가, REG_TYP_CD 가 신규,변경일 경우) -->
   <insert id="insertWAM" parameterType="map">
   
	INSERT 	/* WaqDdlIdxMapper.insertWAM */
			INTO WAM_DDL_IDX
	(DDL_IDX_ID 	
	 <include refid="wam_col_ins"/>
	)	
	SELECT DDL_IDX_ID 	
	       <include refid="wam_col"/>	
	 FROM WAQ_DDL_IDX A
	WHERE A.RQST_NO = #{rqstNo}
	  AND A.VRF_CD = '1'
	  AND A.RVW_STS_CD = '1'
	  AND A.REG_TYP_CD IN ('C', 'U')
   </insert>  
   
   <!-- WAH 이력 만료... -->
   <update id="updateWAH"  parameterType="map">
   
   	<!-- 
	UPDATE WAH_DDL_IDX A
	   SET EXP_DTM = NOW()
	 WHERE EXP_DTM = STR_TO_DATE('9999-12-31', '%Y-%m-%d')
	   AND REG_TYP_CD IN ('C','U')
	   AND EXISTS ( SELECT 1
			 	      FROM WAQ_DDL_IDX B
				     WHERE B.RQST_NO = #{rqstNo}
				       AND B.VRF_CD = '1'
				       AND B.RVW_STS_CD = '1'
				       AND B.STND_ASRT = A.STND_ASRT     
				       AND B.DDL_IDX_ID = A.DDL_IDX_ID	
				  )
	-->
	
	UPDATE 	/* WaqDdlIdxMapper.updateWAH */
			WAH_DDL_IDX A
	 		INNER JOIN WAQ_DDL_IDX B
			   ON B.DDL_IDX_ID = A.DDL_IDX_ID
			  AND B.RQST_NO = #{rqstNo}
       		  AND B.VRF_CD = '1'
       		  AND B.RVW_STS_CD = '1' 
	   SET A.EXP_DTM = NOW()
	 WHERE A.EXP_DTM = STR_TO_DATE('9999-12-31', '%Y-%m-%d')
	   AND A.REG_TYP_CD IN ('C','U')
 	   AND EXISTS ( SELECT 1
			 	      FROM WAQ_DDL_IDX B
				     WHERE B.RQST_NO = #{rqstNo}
				       AND B.VRF_CD = '1'
				       AND B.RVW_STS_CD = '1'
				       AND B.DDL_IDX_ID = A.DDL_IDX_ID	     
				  )
       
   </update>  

	<!-- WAH이력 적재... -->
   <insert id="insertWAH"  parameterType="map">
   
	INSERT 	/* WaqDdlIdxMapper.insertWAH */
			INTO WAH_DDL_IDX
	(  DDL_IDX_ID 
	 , EXP_DTM
	 , STR_DTM 	
	 <include refid="wam_col_ins"/>   	
	)
	SELECT A.DDL_IDX_ID AS DDL_IDX_ID
	     , STR_TO_DATE('9999-12-31', '%Y-%m-%d') AS EXP_DTM
	     , NOW() AS STR_DTM 	
	     <include refid="wam_col"/>   
	 FROM WAQ_DDL_IDX A
	WHERE A.RQST_NO = #{rqstNo}
	  AND A.VRF_CD = '1'
	  AND A.RVW_STS_CD = '1'
   </insert>   

	<!-- DDL인덱스 변경대상 조회... -->
	<select id="selectddlidxlist" parameterType="map" resultMap="BaseResultMap" >
	
   	SELECT 	/* WaqDdlIdxMapper.selectddlidxlist */
   			A.DDL_IDX_ID
   	      , 'I' AS IBS_STATUS
		  , MAX(A.DDL_IDX_PNM) AS DDL_IDX_PNM
	      , MAX(A.DDL_IDX_LNM) AS DDL_IDX_LNM
	      , #{reqmst.rqstDcd, jdbcType=VARCHAR} AS RQST_DCD
	      , MAX(A.DB_CONN_TRG_ID)    AS DB_CONN_TRG_ID
	      , MAX(DB.DB_CONN_TRG_PNM)  AS DB_CONN_TRG_PNM
	      , MAX(A.DB_SCH_ID)         AS DB_SCH_ID
	      , MAX(S.DB_SCH_PNM)        AS DB_SCH_PNM
	      , MAX(A.DDL_TBL_ID)        AS DDL_TBL_ID
	      , MAX(DD.DDL_TBL_PNM)      AS DDL_TBL_PNM
	      , MAX(A.IDX_SPAC_ID)       AS IDX_SPAC_ID
	      , MAX(IDX.DB_TBL_SPAC_PNM) AS IDX_SPAC_PNM
	      , MAX(A.PK_IDX_YN)         AS PK_IDX_YN
	      , MAX(A.UK_IDX_YN)         AS UK_IDX_YN
	      , MAX(A.IDX_TYP_CD)        AS IDX_TYP_CD
	      , MAX(A.DDL_IDX_COL_ASM)   AS DDL_IDX_COL_ASM
	      , MAX(A.OBJ_DESCN)         AS OBJ_DESCN
	     <!--, LISTAGG(B.DDL_IDX_COL_PNM ||','|| B.SORT_TYP,';') WITHIN GROUP(ORDER BY B.DDL_IDX_COL_ORD) AS DDL_IDX_COL_ASM -->
	   FROM WAM_DDL_IDX A
	       INNER JOIN WAM_DDL_IDX_COL B
	          ON B.DDL_IDX_ID = A.DDL_IDX_ID
	       LEFT JOIN WAM_DDL_TBL DD
	         ON A.DDL_TBL_ID = DD.DDL_TBL_ID
	        AND DD.REG_TYP_CD IN ('C', 'U')
	       LEFT JOIN WAA_DB_SCH S
	         ON A.DB_SCH_ID = S.DB_SCH_ID
	        AND S.REG_TYP_CD IN ('C', 'U')
	        AND S.EXP_DTM = STR_TO_DATE('9999-12-31', '%Y-%m-%d')
	       LEFT JOIN WAA_DB_CONN_TRG DB
	         ON A.DB_CONN_TRG_ID = DB.DB_CONN_TRG_ID
	        AND DB.REG_TYP_CD IN ('C', 'U')
	        AND DB.EXP_DTM = STR_TO_DATE('9999-12-31', '%Y-%m-%d')
	       LEFT JOIN WAA_TBL_SPAC IDX
	         ON A.IDX_SPAC_ID = IDX.DB_TBL_SPAC_ID
	        AND IDX.REG_TYP_CD IN ('C', 'U')
	        AND IDX.EXP_DTM = STR_TO_DATE('9999-12-31', '%Y-%m-%d')
	 WHERE A.DDL_IDX_ID IN 
	 <foreach collection="list" item="item" open="(" separator="," close=")">
	  	 #{item.ddlIdxId}
	 </foreach>
	 GROUP BY A.DDL_IDX_ID
	 
  </select>

	<!-- DDL 스크립트 업데이트... -->
  	<update id="updateDdlIdxScriptWaq" parameterType="kr.wise.meta.ddl.service.WaqDdlIdx">
  	
	  	UPDATE 	/* WaqDdlIdxMapper.updateDdlIdxScriptWaq */
	  			WAQ_DDL_IDX
	  	   SET SCRT_INFO = #{scrtInfo,jdbcType=VARCHAR}
	  	 WHERE RQST_NO = #{rqstNo,jdbcType=VARCHAR}
	       AND RQST_SNO = #{rqstSno,jdbcType=DECIMAL}
<!--	       AND RQST_DTL_SNO = #{rqstDtlSno,jdbcType=DECIMAL} -->
	       
  	</update>

	<!-- DDL 테이블 추가시 물리모델 컬럼을 추가한다. -->
  	<insert id="insertByRqstSno" parameterType="kr.wise.meta.ddl.service.WaqDdlTbl">
  	
	  	INSERT 	/* WaqDdlIdxMapper.insertByRqstSno */
	  			INTO WAQ_DDL_IDX(
		      RQST_NO
		    , RQST_SNO
		    , RQST_DTL_SNO
		    , DDL_IDX_ID 	    
		    , DDL_IDX_PNM, DDL_IDX_LNM
		    , RQST_DCD
		    , DB_CONN_TRG_ID     
		    , DB_CONN_TRG_PNM    
		    , DB_SCH_ID          
		    , DB_SCH_PNM         
		    , DDL_TBL_ID         
		    , DDL_TBL_PNM        
		    , IDX_SPAC_ID        
		    , IDX_SPAC_PNM       
		    , PK_IDX_YN          
		    , UK_IDX_YN          
		    , IDX_TYP_CD         
		    , OBJ_DESCN
		    , OBJ_VERS
		    , FRS_RQST_DTM
		    , FRS_RQST_USER_ID
		)
		SELECT A.RQST_NO
		     , A.RQST_SNO	    
		     , IFNULL((SELECT MAX(X.RQST_DTL_SNO) 
		          FROM WAQ_DDL_IDX X
		         WHERE X.RQST_NO  = #{rqstNo, jdbcType=VARCHAR}
		           AND X.RQST_SNO = #{rqstSno, jdbcType=VARCHAR}    
		        ), 0) + @ROWNUM := @ROWNUM + 1  AS RQST_DTL_SNO
			 , C.DDL_IDX_ID  	 
		     , C.DDL_IDX_PNM
		     , C.DDL_IDX_PNM
		     , 'CU' AS RQST_DCD
		     , C.DB_CONN_TRG_ID     
		     , E.DB_CONN_TRG_PNM    
		     , A.DB_SCH_ID          
		     , F.DB_SCH_PNM         
		     , B.DDL_TBL_ID         
		     , A.DDL_TBL_PNM        
		     , C.IDX_SPAC_ID        
		     , D.DB_TBL_SPAC_LNM       
		     , C.PK_IDX_YN          
		     , C.UK_IDX_YN          
		     , C.IDX_TYP_CD         
			 , C.OBJ_DESCN
			 , C.OBJ_VERS
			 , C.FRS_RQST_DTM
			 , C.FRS_RQST_USER_ID		 
		  FROM (SELECT @rownum:=0) TMP, WAQ_DDL_TBL A
		       INNER JOIN WAM_DDL_TBL B
		          ON B.DB_SCH_ID   = A.DB_SCH_ID
		         AND B.DDL_TBL_PNM = A.DDL_TBL_PNM 
		       INNER JOIN WAM_DDL_IDX C
		          ON C.DDL_TBL_ID = B.DDL_TBL_ID 		   		   		  
		       LEFT JOIN WAA_TBL_SPAC D
		          ON D.EXP_DTM = STR_TO_DATE('9999-12-31','%Y-%m-%d')
		         AND D.DB_TBL_SPAC_ID = C.IDX_SPAC_ID 	         
	           LEFT JOIN WAA_DB_CONN_TRG E
		          ON E.EXP_DTM = STR_TO_DATE('9999-12-31','%Y-%m-%d')
		         AND E.DB_CONN_TRG_ID = C.DB_CONN_TRG_ID
		       LEFT JOIN WAA_DB_SCH F
		          ON F.EXP_DTM = STR_TO_DATE('9999-12-31','%Y-%m-%d')
		         AND F.DB_SCH_ID = B.DB_SCH_ID	           
		  WHERE A.RQST_NO  = #{rqstNo, jdbcType=VARCHAR}
		    AND A.RQST_SNO = #{rqstSno, jdbcType=VARCHAR}
  </insert>
    
    <insert id="insertByRqstSnoTsf2" parameterType="kr.wise.meta.ddl.service.WaqDdlTbl">
    <selectKey keyProperty="rqstSno" resultType="int" statementType="PREPARED" order="BEFORE">
	<!--   		<include refid="kr.wise.commons.cmm.service.CommonMapper.getNextrqstSno"/> -->
		SELECT MAX(A.RQST_NO) AS RQST_NO
	FROM
   (
		SELECT IFNULL(MAX(RQST_SNO), 0) + 1 AS RQST_NO FROM WAQ_DDL_TBL WHERE RQST_NO = #{rqstNo}
		UNION ALL
		SELECT IFNULL(MAX(RQST_SNO), 0) + 1  AS RQST_NO FROM WAQ_DDL_IDX WHERE RQST_NO = #{rqstNo}
	) A
  	</selectKey>
    insert into WAQ_DDL_IDX
    <trim prefix="(" suffix=")" suffixOverrides="," >
        RQST_NO,
        RQST_SNO,
        RQST_DTL_SNO,
      <if test="ddlTblId != null" >
        DDL_IDX_ID,
      </if>
      <if test="ddlTblPnm != null" >
        DDL_IDX_PNM,
      </if>
      <if test="ddlTblLnm != null" >
        DDL_IDX_LNM,
      </if>
      <if test="rqstDcd != null" >
        RQST_DCD,
      </if>
      <if test="rvwStsCd != null" >
        RVW_STS_CD,
      </if>
      <if test="rvwConts != null" >
        RVW_CONTS,
      </if>
      <if test="vrfCd != null" >
        VRF_CD,
      </if>
      <if test="vrfRmk != null" >
        VRF_RMK,
      </if>
      <if test="tgtDbConnTrgPnm != null" >
        DB_CONN_TRG_PNM,
      </if>
      <if test="tgtDbSchId != null" >
        DB_SCH_ID,
      </if>
      <if test="tgtDbSchPnm != null" >
        DB_SCH_PNM,
      </if>
      <if test="tblSpacId != null" >
        IDX_SPAC_ID,
      </if>
      <if test="tblSpacPnm != null" >
        IDX_SPAC_PNM,
      </if>
      <if test="refTblPnm != null" >
        DDL_TBL_PNM,
      </if>
      <if test="objDescn != null" >
        OBJ_DESCN,
      </if>
        OBJ_VERS,
      <if test="regTypCd != null" >
        REG_TYP_CD,
      </if>
        FRS_RQST_DTM,
      <if test="frsRqstUserId != null" >
        FRS_RQST_USER_ID,
      </if>
        RQST_DTM,
      <if test="rqstUserId != null" >
        RQST_USER_ID,
      </if>
      <if test="prjNo != null" >
        PRJ_NO,
      </if>
      <if test="devTestSync != null" >
        DEV_TEST_SYNC,
      </if>
      <if test="srcDdlTrgDcd != null" >
        SRC_DDL_TRG_DCD,
      </if>
       <if test="srcDbSchPnm != null" >
        SRC_DB_SCH_PNM,
      </if>
      <if test="srcDbSchId != null" >
        SRC_DB_SCH_ID,
      </if>
      <if test="srcDbConnTrgPnm != null" >
        SRC_DB_CONN_TRG_PNM,
      </if>
      <if test="rqstConts != null" >
        RQST_CONTS,
      </if>
    </trim>
    <trim prefix="values (" suffix=")" suffixOverrides="," >
        #{rqstNo,jdbcType=VARCHAR},
        #{rqstSno,jdbcType=DECIMAL},
        #{rqstSno,jdbcType=DECIMAL},
      <if test="ddlTblId != null" >
        #{ddlTblId,jdbcType=VARCHAR},
      </if>
      <if test="ddlTblPnm != null" >
        #{ddlTblPnm,jdbcType=VARCHAR},
      </if>
      <if test="ddlTblLnm != null" >
        #{ddlTblLnm,jdbcType=VARCHAR},
      </if>
      <if test="rqstDcd != null" >
        #{rqstDcd,jdbcType=VARCHAR},
      </if>
      <if test="rvwStsCd != null" >
        #{rvwStsCd,jdbcType=VARCHAR},
      </if>
      <if test="rvwConts != null" >
        #{rvwConts,jdbcType=VARCHAR},
      </if>
      <if test="vrfCd != null" >
        #{vrfCd,jdbcType=VARCHAR},
      </if>
      <if test="vrfRmk != null" >
        #{vrfRmk,jdbcType=VARCHAR},
      </if>
      <if test="tgtDbConnTrgPnm != null" >
        #{tgtDbConnTrgPnm,jdbcType=VARCHAR},
      </if>
      <if test="tgtDbSchId != null" >
        #{tgtDbSchId,jdbcType=VARCHAR},
      </if>
      <if test="tgtDbSchPnm != null" >
        #{tgtDbSchPnm,jdbcType=VARCHAR},
      </if>
      <if test="tblSpacId != null" >
        #{tblSpacId,jdbcType=VARCHAR},
      </if>
      <if test="tblSpacPnm != null" >
        #{tblSpacPnm,jdbcType=VARCHAR},
      </if>
      <if test="refTblPnm != null" >
        #{refTblPnm,jdbcType=VARCHAR},
      </if>
      <if test="objDescn != null" >
        #{objDescn,jdbcType=VARCHAR},
      </if>
        1 ,
      <if test="regTypCd != null" >
        #{regTypCd,jdbcType=VARCHAR},
      </if>
        NOW() ,
      <if test="frsRqstUserId != null" >
        #{frsRqstUserId,jdbcType=VARCHAR},
      </if>
        NOW() ,
      <if test="rqstUserId != null" >
        #{rqstUserId,jdbcType=VARCHAR},
      </if>
      <if test="prjNo != null" >
        #{prjNo,jdbcType=VARCHAR},
      </if>
      <if test="devTestSync != null" >
        #{devTestSync,jdbcType=VARCHAR},
      </if>
      <if test="srcDdlTrgDcd != null" >
       #{srcDdlTrgDcd,jdbcType=VARCHAR},
      </if>
       <if test="srcDbSchPnm != null" >
       	#{srcDbSchPnm,jdbcType=VARCHAR},
      </if>
      <if test="srcDbSchId != null" >
      	#{srcDbSchId,jdbcType=VARCHAR},
      </if>
       <if test="srcDbConnTrgPnm != null" >
       #{srcDbConnTrgPnm,jdbcType=VARCHAR},
      </if>
      <if test="rqstConts != null" >
        #{rqstConts,jdbcType=VARCHAR},
      </if>
    </trim>
  </insert>
  
  
  <update id="updateByPrimaryKeySelective2" parameterType="kr.wise.meta.ddl.service.WaqDdlTbl" >
  
  	/* WaqDdlIdxMapper.updateByPrimaryKeySelective2 */
  	
    update WAQ_DDL_IDX
    <set >
      <if test="ddlTblId != null" >
        DDL_IDX_ID = #{ddlTblId,jdbcType=VARCHAR},
      </if>
      <if test="ddlTblPnm != null" >
        DDL_IDX_PNM = #{ddlTblPnm,jdbcType=VARCHAR},
      </if>
      <if test="ddlTblLnm != null" >
        DDL_IDX_LNM = #{ddlTblLnm,jdbcType=VARCHAR},
      </if>
      <if test="rqstDcd != null" >
        RQST_DCD = #{rqstDcd,jdbcType=VARCHAR},
      </if>
      <if test="rvwStsCd != null" >
        RVW_STS_CD = #{rvwStsCd,jdbcType=VARCHAR},
      </if>
      <if test="rvwConts != null" >
        RVW_CONTS = #{rvwConts,jdbcType=VARCHAR},
      </if>
      <if test="vrfCd != null" >
        VRF_CD = #{vrfCd,jdbcType=VARCHAR},
      </if>
      <if test="vrfRmk != null" >
        VRF_RMK = #{vrfRmk,jdbcType=VARCHAR},
      </if>
      <if test="tgtDbConnTrgPnm != null" >
        DB_CONN_TRG_PNM = #{tgtDbConnTrgPnm,jdbcType=VARCHAR},
      </if>
      <if test="tgtDbSchId != null" >
        DB_SCH_ID = #{tgtDbSchId,jdbcType=VARCHAR},
      </if>
      <if test="tgtDbSchPnm != null" >
        DB_SCH_PNM = #{tgtDbSchPnm,jdbcType=VARCHAR},
      </if>
      <if test="tblSpacId != null" >
        IDX_SPAC_ID = #{tblSpacId,jdbcType=VARCHAR},
      </if>
      <if test="tblSpacPnm != null" >
        IDX_SPAC_PNM = #{tblSpacPnm,jdbcType=VARCHAR},
      </if>
      <if test="objDescn != null" >
        OBJ_DESCN = #{objDescn,jdbcType=VARCHAR},
      </if>
      <if test="objVers != null" >
        OBJ_VERS = #{objVers,jdbcType=DECIMAL},
      </if>
      <if test="regTypCd != null" >
        REG_TYP_CD = #{regTypCd,jdbcType=VARCHAR},
      </if>
        RQST_DTM = NOW() ,
      <if test="rqstUserId != null" >
        RQST_USER_ID = #{rqstUserId,jdbcType=VARCHAR},
      </if>
      <if test="prjNo != null" >
        PRJ_NO = #{prjNo,jdbcType=VARCHAR},   
      </if>
      <if test="devTestSync != null" >
        DEV_TEST_SYNC = #{devTestSync,jdbcType=VARCHAR},   
      </if> 
      <if test="refTblPnm != null" >
        DDL_TBL_PNM = #{refTblPnm,jdbcType=VARCHAR},
      </if>
      <if test="srcDdlTrgDcd != null" >
       SRC_DDL_TRG_DCD = #{srcDdlTrgDcd,jdbcType=VARCHAR},
      </if>
       <if test="srcDbSchPnm != null" >
       	SRC_DB_SCH_PNM = #{srcDbSchPnm,jdbcType=VARCHAR},
      </if>
      <if test="srcDbSchId != null" >
      	SRC_DB_SCH_ID = #{srcDbSchId,jdbcType=VARCHAR},
      </if>
      <if test="srcDbConnTrgPnm != null" >
       SRC_DB_CONN_TRG_PNM = #{srcDbConnTrgPnm,jdbcType=VARCHAR},
      </if>
      <if test="rqstConts != null" >
        RQST_CONTS = #{rqstConts,jdbcType=VARCHAR},
      </if>
    </set>
    where RQST_NO = #{rqstNo,jdbcType=VARCHAR}
      and RQST_SNO = #{rqstSno,jdbcType=DECIMAL}
      
  </update>
  
  
  <update id="updateInfo" parameterType="kr.wise.meta.ddl.service.WaqDdlTbl" >
  
  	/* WaqDdlIdxMapper.updateInfo */
    UPDATE WAQ_DDL_IDX A
    INNER JOIN WAM_DDL_IDX B
       ON A.STND_ASRT = B.STND_ASRT
      AND A.DB_SCH_ID = B.DB_SCH_ID
      AND A.DDL_TBL_ID = B.DDL_TBL_ID
      AND A.DDL_IDX_ID = B.DDL_IDX_ID
      SET   A.PK_IDX_YN = B.PK_IDX_YN
          , A.UK_IDX_YN = B.UK_IDX_YN
          , A.IDX_TYP_CD = B.IDX_TYP_CD
    WHERE A.RQST_NO = #{rqstNo,jdbcType=VARCHAR}
      AND  A.RQST_SNO = #{rqstSno,jdbcType=DECIMAL}
      
  </update>
  
  
  <update id="updateDdlTblTsfId" parameterType="kr.wise.meta.ddl.service.WaqDdlTbl" >
  
  	/* WaqDdlIdxMapper.updateDdlTblTsfId */
    UPDATE WAQ_DDL_IDX A
    INNER JOIN WAM_DDL_TBL B
       ON A.STND_ASRT = B.STND_ASRT
      AND A.DB_SCH_ID = B.DB_SCH_ID
      AND A.DDL_TBL_PNM = B.DDL_TBL_PNM
      SET   A.DDL_TBL_ID = B.DDL_TBL_ID
    WHERE A.RQST_NO = #{rqstNo,jdbcType=VARCHAR}
      AND  A.RQST_SNO = #{rqstSno,jdbcType=DECIMAL}
      
  </update>
  
	<!-- DDL 테이블 추가시 물리모델 컬럼을 추가한다. -->
  	<insert id="insertByRqstSnoTsf" parameterType="kr.wise.meta.ddl.service.WaqDdlTbl">
  	
  	INSERT 	/* WaqDdlIdxMapper.insertByRqstSnoTsf */
  			INTO WAQ_DDL_IDX(
	      RQST_NO
	    , RQST_SNO
	    , RQST_DTL_SNO 	    
	    , DDL_IDX_PNM, DDL_IDX_LNM
	    , RQST_DCD
	    , DB_CONN_TRG_ID     
	    , DB_CONN_TRG_PNM    
	    , DB_SCH_ID          
	    , DB_SCH_PNM         
	    , DDL_TBL_ID         
	    , DDL_TBL_PNM        	            	           
	    , PK_IDX_YN          
	    , UK_IDX_YN          
	    , IDX_TYP_CD         
	    , OBJ_DESCN, OBJ_VERS, FRS_RQST_DTM, FRS_RQST_USER_ID, RQST_DTM, RQST_USER_ID
	    , DDL_IDX_COL_ASM
	) 	
	SELECT A.RQST_NO	
	     , A.RQST_SNO    
	     , IFNULL((SELECT MAX(X.RQST_DTL_SNO) 
	          FROM WAQ_DDL_IDX X
	         WHERE X.RQST_NO  = A.RQST_NO
	           AND X.RQST_SNO = A.RQST_SNO
	        ), 0) + @ROWNUM := @ROWNUM + 1  AS RQST_DTL_SNO
	     , C.DDL_IDX_PNM
	     , C.DDL_IDX_LNM
	     , A.RQST_DCD
	     , F.DB_CONN_TRG_ID AS DB_CONN_TRG_ID     
	     , F.DB_CONN_TRG_PNM    
	     , A.DB_SCH_ID          
	     , E.DB_SCH_PNM AS DB_SCH_PNM         
	     , A.DDL_TBL_ID         
	     , A.DDL_TBL_PNM         	    
	     , IFNULL(C.PK_IDX_YN,'N') AS PK_IDX_YN           
	     , IFNULL(C.UK_IDX_YN,'N') AS UK_IDX_YN           
	     , C.IDX_TYP_CD         
	     , C.OBJ_DESCN
	     , C.OBJ_VERS
	     , C.FRS_RQST_DTM
	     , C.FRS_RQST_USER_ID
	     , NOW()
	     , C.RQST_USER_ID
	     , C.DDL_IDX_COL_ASM
	  FROM (SELECT @rownum:=0) TMP, WAQ_DDL_TBL A  		   		   
	       INNER JOIN WAM_DDL_TBL B  <!-- 소스테이블 -->
	          ON B.DB_SCH_ID   = A.SRC_DB_SCH_ID
	         AND B.DDL_TBL_PNM = A.DDL_TBL_PNM
	       INNER JOIN WAM_DDL_IDX C  <!-- 소스인덱스 --> 
	          ON C.DDL_TBL_ID = B.DDL_TBL_ID   	       
	       INNER JOIN WAA_DB_SCH E   <!-- 타겟 스키마 --> 
	          ON E.EXP_DTM = STR_TO_DATE('9999-12-31','%Y-%m-%d')
	         AND E.DB_SCH_ID = A.DB_SCH_ID
	       INNER JOIN WAA_DB_CONN_TRG F  <!-- 타겟DB --> 
	          ON F.EXP_DTM = STR_TO_DATE('9999-12-31','%Y-%m-%d')
	         AND F.DB_CONN_TRG_ID = E.DB_CONN_TRG_ID
	 WHERE A.RQST_NO  = #{rqstNo}  
	   AND A.RQST_SNO = #{rqstSno}
  </insert>
    
  <insert id="insertTsfIdxSelective" parameterType="kr.wise.meta.ddl.service.WaqDdlTbl">
  
  	<selectKey keyProperty="rqstSno" resultType="int" statementType="PREPARED" order="BEFORE">
		SELECT IFNULL(MAX(RQST_SNO), 0) + 1 FROM WAQ_DDL_IDX WHERE RQST_NO = #{rqstNo}
  	</selectKey>
    insert 	/* WaqDdlIdxMapper.insertTsfIdxSelective */
    		into WAQ_DDL_IDX
    <trim prefix="(" suffix=")" suffixOverrides="," >
        RQST_NO,
        RQST_SNO,
      <if test="ddlIdxId != null" >
        DDL_IDX_ID,
      </if>
      <if test="ddlIdxPnm != null" >
        DDL_IDX_PNM,
      </if>
      <if test="ddlIdxPnm != null" >
        DDL_IDX_LNM,
      </if>
      <if test="rqstDcd != null" >
        RQST_DCD,
      </if>
      <if test="rvwStsCd != null" >
        RVW_STS_CD,
      </if>
      <if test="rvwConts != null" >
        RVW_CONTS,
      </if>
      <if test="vrfCd != null" >
        VRF_CD,
      </if>
      <if test="vrfRmk != null" >
        VRF_RMK,
      </if>
      <if test="dbConnTrgId != null" >
        DB_CONN_TRG_ID,
      </if>
      <if test="dbConnTrgPnm != null" >
        DB_CONN_TRG_PNM,
      </if>
      <if test="dbSchId != null" >
        DB_SCH_ID,
      </if>
      <if test="dbSchPnm != null" >
        DB_SCH_PNM,
      </if>
      <if test="ddlTblId != null" >
        DDL_TBL_ID,
      </if>
      <if test="ddlTblPnm != null" >
        DDL_TBL_PNM,
      </if>
      <if test="idxSpacId != null" >
        IDX_SPAC_ID,
      </if>
      <if test="idxSpacPnm != null" >
        IDX_SPAC_PNM,
      </if>      
      <if test="ukIdxYn != null" >
        UK_IDX_YN,
      </if>      
      <if test="objDescn != null" >
        OBJ_DESCN,
      </if>
        OBJ_VERS,
      <if test="regTypCd != null" >
        REG_TYP_CD,
      </if>
        FRS_RQST_DTM,
        FRS_RQST_USER_ID,
        RQST_DTM,
      <if test="rqstUserId != null" >
        RQST_USER_ID,
      </if>
      <if test="aprvDtm != null" >
        APRV_DTM,
      </if>
      <if test="aprvUserId != null" >
        APRV_USER_ID,
      </if>
      <if test="scrtInfo != null" >
        SCRT_INFO,
      </if>
      <if test="ddlTrgDcd != null" >
        DDL_TRG_DCD,
      </if>
      <if test="srcDdlTrgDcd != null" >
        SRC_DDL_TRG_DCD,
      </if>
       <if test="srcDbSchId != null" >
        SRC_DB_SCH_ID,
      </if>
      <if test="srcDbSchPnm != null" >
        SRC_DB_SCH_PNM,
      </if>
      <if test="srcDbConnTrgPnm != null" >
        SRC_DB_CONN_TRG_PNM,
      </if>
      <if test="tgtDdlTrgDcd != null" >
        TGT_DDL_TRG_DCD,
      </if>
       <if test="tgtDbSchId != null" >
        TGT_DB_SCH_ID,
      </if>
      <if test="tgtDbSchPnm != null" >
        TGT_DB_SCH_PNM,
      </if>
      <if test="tgtDbConnTrgPnm != null" >
        TGT_DB_CONN_TRG_PNM,
      </if>
    </trim>
    <trim prefix="values (" suffix=")" suffixOverrides="," >
        #{rqstNo,jdbcType=VARCHAR},
        #{rqstSno,jdbcType=DECIMAL},
      <if test="ddlIdxId != null" >
        #{ddlIdxId,jdbcType=VARCHAR},
      </if>
      <if test="ddlIdxPnm != null" >
        #{ddlIdxPnm,jdbcType=VARCHAR},
      </if>
      <if test="ddlIdxPnm != null" >
        #{ddlIdxPnm,jdbcType=VARCHAR},
      </if>
      <if test="rqstDcd != null" >
        #{rqstDcd,jdbcType=VARCHAR},
      </if>
      <if test="rvwStsCd != null" >
        #{rvwStsCd,jdbcType=VARCHAR},
      </if>
      <if test="rvwConts != null" >
        #{rvwConts,jdbcType=VARCHAR},
      </if>
      <if test="vrfCd != null" >
        #{vrfCd,jdbcType=VARCHAR},
      </if>
      <if test="vrfRmk != null" >
        #{vrfRmk,jdbcType=VARCHAR},
      </if>
      <if test="dbConnTrgId != null" >
        #{dbConnTrgId,jdbcType=VARCHAR},
      </if>
      <if test="dbConnTrgPnm != null" >
        #{dbConnTrgPnm,jdbcType=VARCHAR},
      </if>
      <if test="dbSchId != null" >
        #{dbSchId,jdbcType=VARCHAR},
      </if>
      <if test="dbSchPnm != null" >
        #{dbSchPnm,jdbcType=VARCHAR},
      </if>
      <if test="ddlTblId != null" >
        #{ddlTblId,jdbcType=VARCHAR},
      </if>
      <if test="ddlTblPnm != null" >
        #{ddlTblPnm,jdbcType=VARCHAR},
      </if>
      <if test="idxSpacId != null" >
        #{idxSpacId,jdbcType=VARCHAR},
      </if>
      <if test="idxSpacPnm != null" >
        #{idxSpacPnm,jdbcType=VARCHAR},
      </if>      
      <if test="ukIdxYn != null" >
        #{ukIdxYn,jdbcType=VARCHAR},
      </if>      
      <if test="objDescn != null" >
        #{objDescn,jdbcType=VARCHAR},
      </if>
        1 ,
      <if test="regTypCd != null" >
        #{regTypCd,jdbcType=VARCHAR},
      </if>
        NOW(),
        #{frsRqstUserId,jdbcType=VARCHAR},
        NOW(),
      <if test="rqstUserId != null" >
        #{rqstUserId,jdbcType=VARCHAR},
      </if>
      <if test="aprvDtm != null" >
        #{aprvDtm,jdbcType=TIMESTAMP},
      </if>
      <if test="aprvUserId != null" >
        #{aprvUserId,jdbcType=VARCHAR},
      </if>
      <if test="scrtInfo != null" >
        #{scrtInfo,jdbcType=CLOB},
      </if>
      <if test="ddlTrgDcd != null" >
        #{ddlTrgDcd,jdbcType=VARCHAR},
      </if>
      <if test="srcDdlTrgDcd != null" >
        #{srcDdlTrgDcd,jdbcType=VARCHAR},
      </if>
       <if test="srcDbSchId != null" >
        #{srcDbSchId,jdbcType=VARCHAR},
      </if>
      <if test="srcDbSchPnm != null" >
        #{srcDbSchPnm,jdbcType=VARCHAR},
      </if>
      <if test="srcDbConnTrgPnm != null" >
        #{srcDbConnTrgPnm,jdbcType=VARCHAR},
      </if>
      <if test="tgtDdlTrgDcd != null" >
        #{tgtDdlTrgDcd,jdbcType=VARCHAR},
      </if>
       <if test="tgtDbSchId != null" >
        #{tgtDbSchId,jdbcType=VARCHAR},
      </if>
      <if test="tgtDbSchPnm != null" >
        #{tgtDbSchPnm,jdbcType=VARCHAR},
      </if>
      <if test="tgtDbConnTrgPnm != null" >
        #{tgtDbConnTrgPnm,jdbcType=VARCHAR},
      </if>
    </trim>
  </insert>
  
  <select id="selectDdlTsfIdxListForRqst" resultMap="BaseResultMap" parameterType="kr.wise.meta.ddl.service.WaqDdlIdx" >
  
		SELECT 	/* WaqDdlIdxMapper.selectDdlTsfIdxListForRqst */
				'IDX' AS OBJ_DCD
            , C.DB_CONN_TRG_ID
            , C.DB_CONN_TRG_PNM
            , A.DB_SCH_ID
            , B.DB_SCH_PNM
            , A.DDL_IDX_ID            
            , D.DDL_TBL_PNM
            , D.DDL_TBL_LNM
            , A.DDL_IDX_PNM
            , A.DDL_IDX_LNM
            , A.OBJ_DESCN
         FROM WAM_DDL_IDX A
              INNER JOIN WAA_DB_SCH B
                 ON B.EXP_DTM = STR_TO_DATE('9999-12-31','%Y-%m-%d')
                AND B.DB_SCH_ID = A.DB_SCH_ID
              INNER JOIN WAA_DB_CONN_TRG C
                 ON C.EXP_DTM = STR_TO_DATE('9999-12-31','%Y-%m-%d')
                AND C.DB_CONN_TRG_ID = B.DB_CONN_TRG_ID
              INNER JOIN WAM_DDL_TBL D
                 ON D.DDL_TBL_ID = A.DDL_TBL_ID         
        WHERE 1 = 1
          AND A.DB_SCH_ID   = #{srcDbSchId,jdbcType=VARCHAR}    
         <if test="ddlTblPnm !=null ">
			AND D.DDL_TBL_PNM LIKE #{ddlTblPnm, ,jdbcType=VARCHAR} 
		 </if> 
  </select> 
  
  <select id="selectTsfDdlIdxList" parameterType="map" resultMap="BaseResultMap">
  
	  SELECT  /* WaqDdlIdxMapper.selectTsfDdlIdxList */
	  		'I' AS IBS_STATUS
		  , '' AS DDL_TBL_ID
		  , 'IDX' AS OBJ_DCD
		  , #{reqmst.tgtDbConnTrgPnm,jdbcType=VARCHAR} AS DB_CONN_TRG_PNM
		  , #{reqmst.tgtDbSchId,jdbcType=VARCHAR}      AS DB_SCH_ID 
		  , #{reqmst.tgtDbSchPnm,jdbcType=VARCHAR}     AS DB_SCH_PNM
		  , B.DDL_TBL_PNM AS DDL_TBL_PNM
		  , B.DDL_TBL_LNM AS DDL_TBL_LNM
		  , A.DDL_IDX_PNM AS DDL_IDX_PNM
		  , A.DDL_IDX_LNM AS DDL_IDX_LNM
		  , A.UK_IDX_YN   AS UK_IDX_YN
		  , #{reqmst.tgtDdlTrgDcd,jdbcType=VARCHAR}  AS DDL_TRG_DCD 
		  , #{reqmst.rqstDcd,jdbcType=VARCHAR} AS RQST_DCD 
		  , A.OBJ_DESCN		  
		  , #{reqmst.srcDdlTrgDcd,jdbcType=VARCHAR}    AS SRC_DDL_TRG_DCD
		  , #{reqmst.srcDbSchId,jdbcType=VARCHAR}      AS SRC_DB_SCH_ID
		  , #{reqmst.srcDbSchPnm,jdbcType=VARCHAR}     AS SRC_DB_SCH_PNM		 
		  , #{reqmst.srcDbConnTrgPnm,jdbcType=VARCHAR} AS SRC_DB_CONN_TRG_PNM 
		  , #{reqmst.tgtDdlTrgDcd,jdbcType=VARCHAR}    AS TGT_DDL_TRG_DCD
		  , #{reqmst.tgtDbSchId,jdbcType=VARCHAR}      AS TGT_DB_SCH_ID 
		  , #{reqmst.tgtDbSchPnm,jdbcType=VARCHAR}     AS TGT_DB_SCH_PNM
		  , #{reqmst.tgtDbConnTrgPnm,jdbcType=VARCHAR} AS TGT_DB_CONN_TRG_PNM
	   FROM WAM_DDL_IDX A
	        INNER JOIN WAM_DDL_TBL B
	           ON B.DDL_TBL_ID = A.DDL_TBL_ID 
	  WHERE A.DDL_IDX_ID IN 
	 <foreach collection="list" item="item" open="(" separator="," close=")">
	  	#{item.ddlIdxId}
	 </foreach>
	 
  </select>
  
  	<!-- DDL 인덱스이관 요청서 리스트 조회 -->
  	<select id="selecttDdlTsfIdxRqstList" parameterType="kr.wise.commons.rqstmst.service.WaqMstr" resultMap="BaseResultMap" >
  	
  	SELECT /* WaqDdlIdxMapper.selecttDdlTsfIdxRqstList */
	    <include refid="waq_Column_List"/>
	    <if test='rqstStepCd == "Q" '>
	     , CASE WHEN A.RVW_STS_CD = '2' THEN '2' ELSE '0' END AS RVW_STS_CD
	     </if>
	     <if test='rqstStepCd != "Q" '>
	     , A.RVW_STS_CD
	     </if> 	     
	     <!-- , CASE WHEN A.VRF_CD = '2' THEN '#FF0000' END AS FontColor --> 
	     , CASE WHEN A.VRF_CD = '2' THEN '#FF0000' ELSE CASE WHEN A.VRF_CD = '5' THEN '#0000FF'  END END AS FontColor 
	     , GET_USER_NM(A.RQST_USER_ID) AS RQST_USER_NM
	     , C.DB_CONN_TRG_PNM AS SRC_DB_CONN_TRG_PNM
	     , B.DB_SCH_PNM      AS SRC_DB_SCH_PNM
	     , E.DB_CONN_TRG_PNM AS TGT_DB_CONN_TRG_PNM
	     , D.DB_SCH_PNM      AS TGT_DB_SCH_PNM
	     , 'IDX'             AS OBJ_DCD   
     FROM WAQ_DDL_IDX A	      
	      LEFT JOIN WAA_DB_SCH B
	        ON B.EXP_DTM = STR_TO_DATE('9999-12-31','%Y-%m-%d')
	       AND B.DB_SCH_ID = A.SRC_DB_SCH_ID
	      LEFT JOIN WAA_DB_CONN_TRG C
	        ON C.EXP_DTM = STR_TO_DATE('9999-12-31','%Y-%m-%d')   
	       AND C.DB_CONN_TRG_ID = B.DB_CONN_TRG_ID
	      LEFT JOIN WAA_DB_SCH D
	        ON D.EXP_DTM = STR_TO_DATE('9999-12-31','%Y-%m-%d')
	       AND D.DB_SCH_ID = A.DB_SCH_ID
	      LEFT JOIN WAA_DB_CONN_TRG E
	        ON E.EXP_DTM = STR_TO_DATE('9999-12-31','%Y-%m-%d')
	       AND E.DB_CONN_TRG_ID = D.DB_CONN_TRG_ID     
    WHERE A.RQST_NO = #{rqstNo,jdbcType=VARCHAR}
    <if test='rqstStepCd == "Q" or rqstStepCd == "A" '>
    	AND A.VRF_CD = '1'
    </if>
    ORDER BY A.RQST_SNO
    
  </select>
  
  <update id="updateDelColIdxDel" parameterType="map">
  
      <![CDATA[
      UPDATE 	/* WaqDdlIdxMapper.updateDelColIdxDel */
      			WAQ_DDL_IDX A
         SET RQST_DCD   = 'DD'
           , REG_TYP_CD = 'D'
       WHERE A.RQST_NO = #{rqstNo,jdbcType=VARCHAR}                         
         AND A.RQST_DCD = 'CU'
         AND EXISTS (SELECT 1
				       FROM WAQ_DDL_IDX_COL X
				      WHERE X.RQST_DCD = 'CU'
				        AND X.RQST_NO      = A.RQST_NO 
				        AND X.RQST_SNO     = A.RQST_SNO 
				        AND X.RQST_DTL_SNO = A.RQST_DTL_SNO
				        AND NOT EXISTS (SELECT 1
				                          FROM WAQ_DDL_COL Y
				                         WHERE Y.RQST_DCD = 'CU'
				                           AND Y.RQST_NO  = X.RQST_NO
				                           AND Y.RQST_SNO = X.RQST_SNO
				                           AND Y.DDL_COL_PNM = X.DDL_IDX_COL_PNM
				                        )
				    )
      ]]>
  </update>
  
  
  <update id="updateDelColIdxDelTsf" parameterType="map">
  
      <![CDATA[
      UPDATE 	/* WaqDdlIdxMapper.updateDelColIdxDel */
      			WAQ_DDL_IDX A
         SET RQST_DCD   = 'DD'
           , REG_TYP_CD = 'D'
       WHERE A.RQST_NO = #{rqstNo,jdbcType=VARCHAR}                         
         AND A.RQST_DCD = 'CU'
         AND EXISTS (SELECT 1
				       FROM WAQ_DDL_IDX_COL X
				      WHERE X.RQST_DCD = 'CU'
				        AND X.RQST_NO      = A.RQST_NO 
				        AND X.RQST_SNO     = A.RQST_SNO 
				        AND X.RQST_DTL_SNO = A.RQST_DTL_SNO
				        AND X.STND_ASRT       = A.STND_ASRT
				        AND NOT EXISTS (SELECT 1
				                          FROM WAQ_DDL_COL Y
				                         INNER JOIN WAQ_DDL_TBL B
										    ON Y.RQST_NO = B.RQST_NO
										   AND Y.RQST_SNO = B.RQST_SNO
				                         WHERE Y.RQST_DCD = 'CU'
				                           AND Y.STND_ASRT = X.STND_ASRT
				                           AND Y.RQST_NO  = X.RQST_NO
				                           AND B.TGT_DB_SCH_ID = A.DB_SCH_ID
				                           AND B.DDL_TBL_PNM = A.DDL_TBL_PNM
				                           AND Y.DDL_COL_PNM = X.DDL_IDX_COL_PNM
				                           AND Y.STND_ASRT = X.STND_ASRT
				                           UNION ALL
				                          SELECT 1
				                            FROM WAM_DDL_COL Y
				                           WHERE A.DDL_TBL_ID = Y.DDL_TBL_ID
						                	 AND A.STND_ASRT = Y.STND_ASRT
											 AND Y.DDL_COL_PNM = X.DDL_IDX_COL_PNM
				                        )
				    )
		AND IFNULL(A.DDL_TBL_ID,'') != ''
      ]]>
  </update>
  
   <update id="updateIdxSpacPnm" parameterType="string">
   <!--
  	UPDATE /* WaqDdlIdxMapper.updateIdxSpacPnm */
  		WAQ_DDL_IDX A
	INNER JOIN (
		SELECT   X.DB_IDX_SPAC_ID
	    	   ,  Y.DB_TBL_SPAC_PNM
				, X.DB_SCH_ID		
				, X.STND_ASRT  
	      FROM WAA_DB_SCH X		
	      LEFT JOIN WAA_TBL_SPAC Y
	        ON Y.EXP_DTM = STR_TO_DATE('9999-12-31','%Y-%m-%d')
	       AND Y.DB_TBL_SPAC_ID = X.DB_IDX_SPAC_ID
	       AND Y.STND_ASRT = X.STND_ASRT			   	 
	      WHERE X.EXP_DTM = STR_TO_DATE('9999-12-31','%Y-%m-%d')
	        AND X.REG_TYP_CD IN ('C','U')
	         LIMIT 1                                                                                                                                      
	) B
	 ON B.STND_ASRT = A.STND_ASRT
	AND B.DB_SCH_ID = A.DB_SCH_ID  
	SET  A.IDX_SPAC_ID = B.DB_IDX_SPAC_ID
	    ,A.IDX_SPAC_PNM = B.DB_TBL_SPAC_PNM      
     WHERE A.RQST_NO =  #{rqstNo,jdbcType=VARCHAR} 
       AND EXISTS (SELECT 1		  
                     FROM WAA_DB_SCH X		
                         LEFT JOIN WAA_TBL_SPAC Y
                           ON Y.EXP_DTM = STR_TO_DATE('9999-12-31','%Y-%m-%d')
                          AND Y.DB_TBL_SPAC_ID = X.DB_IDX_SPAC_ID		
                          AND Y.STND_ASRT = X.STND_ASRT		   	                            
                    WHERE X.EXP_DTM = STR_TO_DATE('9999-12-31','%Y-%m-%d')
                      AND X.REG_TYP_CD IN ('C','U')
                      AND X.DB_SCH_ID = A.DB_SCH_ID 
                      LIMIT 1                         
                  ) 	
      AND IFNULL(A.IDX_SPAC_PNM,'') = ''
	-->    
	
  	UPDATE WAQ_DDL_IDX A
  		   LEFT JOIN WAA_DB_SCH X
  		     ON X.DB_SCH_ID = A.DB_SCH_ID 
  		    AND X.EXP_DTM = STR_TO_DATE('9999-12-31','%Y-%m-%d')
            AND X.REG_TYP_CD IN ('C','U')		
           LEFT JOIN WAA_TBL_SPAC Y
             ON Y.EXP_DTM = STR_TO_DATE('9999-12-31','%Y-%m-%d')
            AND Y.DB_TBL_SPAC_ID = X.DB_IDX_SPAC_ID            
       SET A.IDX_SPAC_ID 	= X.DB_IDX_SPAC_ID
         , A.IDX_SPAC_PNM   = Y.DB_TBL_SPAC_PNM		                              
     WHERE A.RQST_NO =  #{rqstNo,jdbcType=VARCHAR} 
       AND EXISTS (SELECT 1		  
                     FROM WAA_DB_SCH X		
                         LEFT JOIN WAA_TBL_SPAC Y
                           ON Y.EXP_DTM = STR_TO_DATE('9999-12-31','%Y-%m-%d')
                          AND Y.DB_TBL_SPAC_ID = X.DB_IDX_SPAC_ID			   	                            
                    WHERE X.EXP_DTM = STR_TO_DATE('9999-12-31','%Y-%m-%d')
                      AND X.REG_TYP_CD IN ('C','U')
                      AND X.DB_SCH_ID = A.DB_SCH_ID 
                      LIMIT 1                           
                  ) 	                 
  </update>
  	
  	<!-- DDL에 존재하고 PDM에 없는 컬럼을 삭제대상으로 추가한다.... -->
  	<insert id="insertDelInit" parameterType="string">
  	
	  	INSERT 	/* WaqDdlIdxMapper.insertDelInit */
	  			INTO WAQ_DDL_IDX 
	  	(
		    RQST_NO
	      , RQST_SNO        
		  , RQST_DTL_SNO
		  , DDL_IDX_ID
		  , DDL_IDX_PNM
		  , DDL_IDX_LNM
		  , DB_SCH_ID
		  , DDL_TBL_ID
		  , UK_IDX_YN
		  , IDX_TYP_CD
		  , DDL_IDX_COL_ASM
		  , RQST_DCD
		  , REG_TYP_CD
		  , VRF_CD	   	    
		  , OBJ_DESCN
		  , OBJ_VERS
		  , FRS_RQST_DTM
		  , FRS_RQST_USER_ID
		  , RQST_DTM
		  , RQST_USER_ID 
		)
	    SELECT B.RQST_NO
	         , B.RQST_SNO
	         , IFNULL((SELECT MAX(X.RQST_DTL_SNO) 
	          FROM WAQ_DDL_IDX X
	         WHERE X.RQST_NO  =#{rqstNo, jdbcType=VARCHAR}
	           AND X.RQST_SNO     = B.RQST_SNO 	         
	        ), 0) + @ROWNUM := @ROWNUM + 1  AS RQST_DTL_SNO
		     , C.DDL_IDX_ID
		     , C.DDL_IDX_PNM
		     , C.DDL_IDX_LNM
		     , C.DB_SCH_ID
		     , C.DDL_TBL_ID
		     , C.UK_IDX_YN
		     , C.IDX_TYP_CD
		     , C.DDL_IDX_COL_ASM
		     , 'DD' AS RQST_DCD
		     , 'D'  AS REG_TYP_CD
		     , '4'  AS VRF_CD	   	    
		     , C.OBJ_DESCN
		     , C.OBJ_VERS
		     , C.FRS_RQST_DTM
		     , C.FRS_RQST_USER_ID
		     , C.RQST_DTM
		     , C.RQST_USER_ID    
		  FROM (SELECT @rownum:=0) TMP, WAQ_DDL_TBL B 
			   INNER JOIN WAM_DDL_IDX C
			      ON C.DDL_TBL_ID = B.DDL_TBL_ID 		  
			     AND C.DB_SCH_ID = B.DB_SCH_ID 
		WHERE B.RQST_NO = #{rqstNo, jdbcType=VARCHAR}
		  AND NOT EXISTS (SELECT 1 
						    FROM WAQ_DDL_IDX X 
						   WHERE B.RQST_NO     = X.RQST_NO
							 AND B.RQST_SNO    = X.RQST_SNO 						 		 
					         AND C.DDL_IDX_PNM = X.DDL_IDX_PNM
			             )
  </insert>
  
  
  <insert id="insertDelInitD" parameterType="string">
  	
	  	INSERT 	/* WaqDdlIdxMapper.insertDelInitD */
	  			INTO WAQ_DDL_IDX 
	  	(
		    RQST_NO
	      , RQST_SNO        
		  , RQST_DTL_SNO
		  , DDL_IDX_ID
		  , DDL_IDX_PNM
		  , DDL_IDX_LNM
		  , DB_SCH_ID
		  , DDL_TBL_ID
		  , UK_IDX_YN
		  , IDX_TYP_CD
		  , DDL_IDX_COL_ASM
		  , RQST_DCD
		  , REG_TYP_CD
		  , VRF_CD	   	    
		  , OBJ_DESCN
		  , OBJ_VERS
		  , FRS_RQST_DTM
		  , FRS_RQST_USER_ID
		  , RQST_DTM
		  , RQST_USER_ID 
		)
	    SELECT B.RQST_NO
	         , B.RQST_SNO
	         , IFNULL((SELECT MAX(X.RQST_DTL_SNO) 
	          FROM WAQ_DDL_IDX X
	         WHERE X.RQST_NO  =#{rqstNo, jdbcType=VARCHAR}
	           AND X.RQST_SNO     = B.RQST_SNO 	         
	        ), 0) + @ROWNUM := @ROWNUM + 1  AS RQST_DTL_SNO
		     , C.DDL_IDX_ID
		     , C.DDL_IDX_PNM
		     , C.DDL_IDX_LNM
		     , C.DB_SCH_ID
		     , C.DDL_TBL_ID
		     , C.UK_IDX_YN
		     , C.IDX_TYP_CD
		     , C.DDL_IDX_COL_ASM
		     , 'DD' AS RQST_DCD
		     , 'D'  AS REG_TYP_CD
		     , '4'  AS VRF_CD	   	    
		     , C.OBJ_DESCN
		     , C.OBJ_VERS
		     , C.FRS_RQST_DTM
		     , C.FRS_RQST_USER_ID
		     , C.RQST_DTM
		     , C.RQST_USER_ID   	     
		  FROM (SELECT @rownum:=0) TMP, WAQ_DDL_TBL B 
			   INNER JOIN WAM_DDL_IDX C
			      ON C.DDL_TBL_ID = B.DDL_TBL_ID 		
		WHERE B.RQST_NO = #{rqstNo, jdbcType=VARCHAR}
		  AND NOT EXISTS (SELECT 1 
						    FROM WAQ_DDL_IDX X 
						   WHERE B.RQST_NO     = X.RQST_NO
							 AND B.RQST_SNO    = X.RQST_SNO 						 		 
					         AND C.DDL_IDX_PNM = X.DDL_IDX_PNM
			             )
  </insert>
  
  <select id="selectDevTestSynclist" parameterType="map" resultMap="BaseResultMap">
  
   	 select /* WaqDdlIdxMapper.selectDevTestSynclist */
   	   DISTINCT
   	 	'I' AS IBS_STATUS
	  , A.DDL_IDX_ID
	  , A.DDL_IDX_PNM AS DDL_IDX_PNM
	  , A.DDL_IDX_LNM AS DDL_IDX_LNM  
	  , A.DDL_TBL_PNM AS DDL_TBL_PNM
	  , A.IDX_SPAC_PNM AS IDX_SPAC_PNM
	  , A.PK_IDX_YN AS PK_IDX_YN
	  , A.UK_IDX_YN AS UK_IDX_YN
	  , A.DDL_IDX_COL_ASM AS DDL_IDX_COL_ASM
	  , A.IDX_TYP_CD AS IDX_TYP_CD
	  , A.RQST_DCD as RQST_DCD
	  , A.OBJ_DESCN
	  , TDB.DB_CONN_TRG_ID as DB_CONN_TRG_ID
	  , TDB.DB_CONN_TRG_PNM as DB_CONN_TRG_PNM
	  , TSCH.DB_SCH_ID as DB_SCH_ID
	  , TSCH.DB_SCH_PNM as DB_SCH_PNM
	  , TSCH.DDL_TRG_DCD as DDL_TRG_DCD
	  , A.STND_ASRT
	  , A.DDL_TBL_ID
	  , A.DEV_TEST_SYNC
	  , A.PRJ_NO
	  , A.COL_CGR_TEXT
	  , A.DDL_IDX_COL_ASM
	  , SSCH.DDL_TRG_DCD as SRC_DDL_TRG_DCD
	  , SSCH.DB_SCH_ID as SRC_DB_SCH_ID
	  , SSCH.DB_SCH_PNM as SRC_DB_SCH_PNM
	  , SDB.DB_CONN_TRG_PNM as SRC_DB_CONN_TRG_PNM
	  , TSCH.DDL_TRG_DCD as TGT_DDL_TRG_DCD
	  , TSCH.DB_SCH_ID as TGT_DB_SCH_ID
	  , TSCH.DB_SCH_PNM as TGT_DB_SCH_PNM
	  , TDB.DB_CONN_TRG_PNM as TGT_DB_CONN_TRG_PNM
  from WAQ_DDL_IDX A
 inner join WAA_DB_MAP B
    on A.STND_ASRT = B.STND_ASRT
   AND A.db_sch_id = B.SRC_DB_SCH_ID
   and B.exp_dtm = str_to_date('9999-12-31','%Y-%m-%D')
   and B.reg_typ_cd in ('C','U')
 inner join WAA_DB_SCH TSCH
    on B.STND_ASRT = TSCH.STND_ASRT 
   AND B.TGT_DB_SCH_ID = TSCH.DB_SCH_ID
   and TSCH.exp_dtm = str_to_date('9999-12-31','%Y-%m-%D')
   and TSCH.reg_typ_cd in ('C','U')
   and TSCH.DDL_TRG_DCD = 'T'
 inner join WAA_DB_CONN_TRG TDB  
    on TSCH.STND_ASRT = TDB.STND_ASRT
   and TSCH.DB_CONN_TRG_ID = TDB.DB_CONN_TRG_ID
   and TDB.exp_dtm = str_to_date('9999-12-31','%Y-%m-%D')
   and TDB.reg_typ_cd in ('C','U')
   AND TDB.INFO_SYS_CD != 'E'
 inner join WAA_DB_SCH SSCH
    on B.STND_ASRT = SSCH.STND_ASRT
   AND B.SRC_DB_SCH_ID = SSCH.DB_SCH_ID
   and SSCH.exp_dtm = str_to_date('9999-12-31','%Y-%m-%D')
   and SSCH.reg_typ_cd in ('C','U')
   and SSCH.DDL_TRG_DCD = 'D'
 inner join WAA_DB_CONN_TRG SDB
    on  SSCH.STND_ASRT = SDB.STND_ASRT
   AND  SSCH.DB_CONN_TRG_ID = SDB.DB_CONN_TRG_ID
   and SDB.exp_dtm = str_to_date('9999-12-31','%Y-%m-%D')
   and SDB.reg_typ_cd in ('C','U')
   AND SDB.INFO_SYS_CD != 'E'
 where A.rqst_no = #{reqmst.rqstNo,jdbcType=VARCHAR}
   and A.dev_test_sync = '1'
   and not exists (
   					select 1 from WAQ_DDL_IDX Z
   					 where Z.RQST_NO = A.RQST_NO
   					   and Z.DB_SCH_ID = TSCH.DB_SCH_ID
   					   and Z.DDL_IDX_PNM = A.DDL_IDX_PNM
   					   and Z.STND_ASRT = A.STND_ASRT
   					)
  </select>
  
  
  <update id="updateIdxTblSpaceIdSubjMap" parameterType="string">
  
  	/* WaqDdlIdxMapper.updateIdxTblSpaceIdSubjMap */
  	
	UPDATE WAQ_DDL_IDX A
	 inner join WAM_DDL_TBL T
	    on A.STND_ASRT = T.STND_ASRT
	   AND A.DB_SCH_ID = T.DB_SCH_ID
	   and A.DDL_TBL_ID = T.DDL_TBL_ID
	 inner join WAA_SUBJ SUBJ
	    on SUBJ.EXP_DTM = STR_TO_DATE('9999-12-31', '%Y-%m-%d')
	   and SUBJ.REG_TYP_CD IN ('C', 'U')
	   and SUBJ.FULL_PATH = T.FULL_PATH
	   AND SUBJ.STND_ASRT = T.STND_ASRT
	 INNER JOIN WAA_SUBJ_TBL_SPAC_MAP B
		ON B.EXP_DTM = STR_TO_DATE('9999-12-31', '%Y-%m-%d')
	   AND B.REG_TYP_CD IN ('C', 'U')
	   AND B.SUBJ_ID = SUBJ.SUBJ_ID
	   AND B.STND_ASRT = SUBJ.STND_ASRT
	 INNER JOIN WAA_TBL_SPAC C
	    ON C.EXP_DTM = STR_TO_DATE('9999-12-31', '%Y-%m-%d')
	   AND C.REG_TYP_CD IN ('C', 'U') 
	   AND C.DB_TBL_SPAC_ID = B.DB_TBL_SPAC_ID
	   AND C.TBL_SPAC_TYP_CD = '2'
	   AND C.STND_ASRT = B.STND_ASRT
	 inner join WAA_DB_CONN_TRG DB
	    on DB.DB_CONN_TRG_ID = C.DB_CONN_TRG_ID
	   AND DB.STND_ASRT = C.STND_ASRT
	   and DB.EXP_DTM = STR_TO_DATE('9999-12-31', '%Y-%m-%d')
	   AND DB.REG_TYP_CD IN ('C', 'U')
	   and A.DB_CONN_TRG_PNM = DB.DB_CONN_TRG_PNM
	   AND DB.INFO_SYS_CD != 'E'
	   -- AND A.STND_ASRT = DB.STND_ASRT	-- WAQ_DDL_IDX 에 국가코드 추가 예정
	   
	   SET  A.IDX_SPAC_ID = C.DB_TBL_SPAC_ID
			, A.IDX_SPAC_PNM = C.DB_TBL_SPAC_PNM
	   
		   WHERE A.RQST_NO = #{rqstNo,jdbcType=VARCHAR}   
	     	AND IFNULL(A.IDX_SPAC_ID,'') = ''        
  </update>
  
  
  
  <!-- 테이블 스페이스 ID 업데이트 -->
  <update id="updateIdxTblSpaceId" parameterType="string">
  
  	/* WaqDdlIdxMapper.updateIdxTblSpaceId */
UPDATE WAQ_DDL_IDX A
 INNER JOIN WAA_DB_SCH B 
    ON B.EXP_DTM = STR_TO_DATE('9999-12-31', '%Y-%m-%d')
   AND B.REG_TYP_CD IN ('C', 'U')
   AND B.DB_SCH_ID = A.DB_SCH_ID
   AND B.STND_ASRT = A.STND_ASRT
 INNER JOIN WAA_TBL_SPAC C
    ON C.EXP_DTM = STR_TO_DATE('9999-12-31', '%Y-%m-%d')
   AND C.REG_TYP_CD IN ('C', 'U')                              
   AND C.DB_TBL_SPAC_ID = B.DB_IDX_SPAC_ID  
   AND C.STND_ASRT = B.STND_ASRT
   SET  A.IDX_SPAC_ID = C.DB_TBL_SPAC_ID
		, A.IDX_SPAC_PNM = C.DB_TBL_SPAC_PNM
	   WHERE A.RQST_NO = #{rqstNo,jdbcType=VARCHAR}	     
	  AND IFNULL(A.IDX_SPAC_ID,'') = ''
	     	        
  </update>
  
  
  <select id="selectScrtInfo" parameterType="kr.wise.meta.ddl.service.WaqDdlIdx" resultMap="ResultMapWithBLOBs">
  
  	/* WaqDdlIdxMapper.selectScrtInfo */
      SELECT   A.SCRT_INFO
             , IFNULL(A.DBA_DDL_STMT,'') AS DBA_DDL_STMT
             , A.RQST_NO
             , A.RQST_SNO
             , A.RQST_DTL_SNO
         FROM WAQ_DDL_IDX A
        WHERE A.RQST_NO = #{rqstNo}
          AND A.RQST_SNO = #{rqstSno}
          AND A.RQST_DTL_SNO = #{rqstDtlSno}
  </select>
  
  
  <update id="scrtInfoUpdate" parameterType="kr.wise.meta.ddl.service.WaqDdlIdx" >
  
  	/* WaqDdlIdxMapper.scrtInfoUpdate */

	UPDATE WAQ_DDL_IDX A
	   SET A.SCRT_INFO = #{scrtInfo}
	      ,A.DBA_DDL_STMT = #{dbaDdlStmt}
     WHERE A.RQST_NO = #{rqstNo,jdbcType=VARCHAR}
       AND A.RQST_SNO = #{rqstSno}
       AND A.RQST_DTL_SNO = #{rqstDtlSno}
  </update>
  
  
  <select id="selectDbaId" parameterType="kr.wise.commons.rqstmst.service.WaqMstr" resultType="java.lang.String">
  	SELECT /* WaqDdlIdxMapper.selectDbaId */
  	       APRG_ID
	  FROM WAA_RQST_BIZ_APR A
	 WHERE APR_LVL = 
	 (
	  	SELECT MAX(APR_LVL) AS APR_LVL
	           FROM WAA_RQST_BIZ_APR A
	  	 WHERE  A.EXP_DTM = STR_TO_DATE('9999-12-31', '%Y-%m-%d')
	  	   AND A.REG_TYP_CD IN ('C', 'U') 
	  	   AND BIZ_DCD = #{reqmst.rqstNo}
	)
	AND BIZ_DCD = #{reqmst.bizDcd}
	
  </select>
  
  <update id="updatervwStsCdDba" parameterType="kr.wise.commons.rqstmst.service.WaqMstr" >
  	UPDATE /* WaqDdlIdxMapper.updatervwStsCd */
		WAQ_DDL_IDX
  	<set>
  	    RVW_STS_CD 	= '1', 
  		RVW_CONTS 	= '' , 
  		APRV_DTM	= NOW() ,
  		APRV_USER_ID = #{aprvUserId} ,
  	</set>
    WHERE RQST_NO = #{rqstNo,jdbcType=VARCHAR}
      AND VRF_CD = '1'
      AND IFNULL(RVW_STS_CD, '_') != '2'
  </update>
  
  
  <update id="updateDdlCopyYn" parameterType="map">
  
  	/* WaqDdlTblMapper.updateDdlCopyYn */
	UPDATE WAQ_DDL_IDX A
	INNER JOIN WAM_DDL_IDX B
	   ON A.STND_ASRT = B.STND_ASRT
	  AND A.DB_SCH_ID = B.DB_SCH_ID
	  AND A.DDL_IDX_ID = B.DDL_IDX_ID
	  AND B.DDL_COPY_YN ='Y'
  	<set>
  	    A.DDL_COPY_YN 	= 'Y',
  	    A.VRF_CD 	= '1', 
  		A.REG_TYP_CD 	= 'U'
  	</set>
    WHERE A.RQST_NO = #{rqstNo,jdbcType=VARCHAR}
      AND A.VRF_CD = '5'
      AND IFNULL(A.REG_TYP_CD,'') = ''
  </update>
  
</mapper>